<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeQuest Pro - JavaScriptÂÜíÈô∫</title>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Fredoka:wght@600;700&family=Orbitron:wght@400;700&display=swap');
        
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #141b2d;
            --bg-tertiary: #1e2a45;
            --bg-card: #182035;
            --accent-primary: #00f5ff;
            --accent-secondary: #ff2d75;
            --accent-tertiary: #b14eff;
            --accent-success: #00ff88;
            --accent-warning: #ffcc00;
            --accent-orange: #ff7b00;
            --text-primary: #e8f4f8;
            --text-secondary: #8892b0;
            --text-code: #7dd3fc;
            --glow-primary: rgba(0, 245, 255, 0.5);
            --glow-secondary: rgba(255, 45, 117, 0.5);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Animated starfield background */
        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        /* Nebula effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(177, 78, 255, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 245, 255, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(255, 45, 117, 0.08) 0%, transparent 60%);
            animation: nebulaPulse 15s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes nebulaPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        header {
            text-align: center;
            margin-bottom: 1.5rem;
            animation: fadeInDown 0.8s ease;
        }
        
        .logo-container {
            display: inline-block;
            position: relative;
        }
        
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-tertiary) 50%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.1em;
            position: relative;
            animation: logoGlow 3s ease-in-out infinite;
        }
        
        @keyframes logoGlow {
            0%, 100% { 
                filter: drop-shadow(0 0 20px var(--glow-primary)) drop-shadow(0 0 40px var(--glow-secondary));
            }
            50% { 
                filter: drop-shadow(0 0 30px var(--glow-primary)) drop-shadow(0 0 60px var(--glow-secondary));
            }
        }
        
        .subtitle {
            font-family: 'Fredoka', sans-serif;
            color: var(--text-secondary);
            font-size: 1.1rem;
            letter-spacing: 0.3em;
            margin-top: 0.5rem;
        }
        
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: 20px;
            border: 1px solid rgba(0, 245, 255, 0.2);
        }
        
        .stat-icon {
            font-size: 1.2rem;
        }
        
        .stat-value {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-primary);
            font-weight: 700;
        }
        
        .help-link {
            text-decoration: none;
            color: var(--accent-warning);
            border: 1px solid var(--accent-warning);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .help-link:hover {
            background: var(--accent-warning);
            color: var(--bg-primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 204, 0, 0.3);
        }
        
        .theme-toggle, .character-btn {
            cursor: pointer;
            border: 1px solid var(--accent-tertiary);
            color: var(--accent-tertiary);
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover, .character-btn:hover {
            background: var(--accent-tertiary);
            color: var(--bg-primary);
            transform: translateY(-2px);
        }
        
        /* Character Selector Modal */
        .character-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .character-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .character-modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 20px 60px rgba(0, 245, 255, 0.3);
        }
        
        .character-modal h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .character-card {
            background: var(--bg-secondary);
            border: 3px solid var(--bg-tertiary);
            border-radius: 16px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .character-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 245, 255, 0.2);
        }
        
        .character-card.selected {
            border-color: var(--accent-success);
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        
        .character-preview {
            width: 80px;
            height: 80px;
            margin: 0 auto 0.75rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .character-name {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .character-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .character-modal-close {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            color: var(--bg-primary);
            border: none;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .character-modal-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 245, 255, 0.4);
        }
        
        /* ===== AUTH MODAL ===== */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .auth-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .auth-modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 20px 60px rgba(0, 245, 255, 0.3);
        }
        
        .auth-modal h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .auth-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 10px;
            color: var(--text-secondary);
            font-family: 'Fredoka', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .auth-tab:hover {
            border-color: var(--accent-primary);
        }
        
        .auth-tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .auth-input-group {
            margin-bottom: 1rem;
        }
        
        .auth-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .auth-input-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .auth-input-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.3);
        }
        
        /* Password Input with Toggle */
        .password-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .password-input-wrapper input {
            width: 100%;
            padding-right: 3rem;
        }
        
        .password-toggle {
            position: absolute;
            right: 0.75rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            opacity: 0.6;
            transition: opacity 0.3s ease;
            padding: 0.25rem;
        }
        
        .password-toggle:hover {
            opacity: 1;
        }
        
        .password-toggle.showing {
            opacity: 1;
        }
        
        .auth-btn {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            color: var(--bg-primary);
            border: none;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 245, 255, 0.4);
        }
        
        .auth-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .auth-error {
            background: rgba(255, 45, 117, 0.2);
            border: 1px solid var(--accent-secondary);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            color: var(--accent-secondary);
            font-size: 0.85rem;
            display: none;
        }
        
        .auth-error.show {
            display: block;
        }
        
        .auth-success {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid var(--accent-success);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            color: var(--accent-success);
            font-size: 0.85rem;
            display: none;
        }
        
        .auth-success.show {
            display: block;
        }
        
        .auth-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .auth-close:hover {
            color: var(--accent-secondary);
        }
        
        .auth-modal-content {
            position: relative;
        }
        
        /* Google Login Button */
        .google-login-btn {
            width: 100%;
            padding: 0.875rem;
            background: #ffffff;
            color: #333;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        
        .google-login-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .google-login-btn svg {
            flex-shrink: 0;
        }
        
        /* Auth Divider */
        .auth-divider {
            display: flex;
            align-items: center;
            margin: 1.25rem 0;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--bg-tertiary);
        }
        
        .auth-divider span {
            padding: 0 1rem;
        }
        
        /* Forgot Password Link */
        .forgot-password-link {
            display: block;
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.75rem;
            background: none;
            border: none;
            color: var(--accent-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: color 0.3s ease;
            text-align: center;
        }
        
        .forgot-password-link:hover {
            color: var(--accent-tertiary);
            text-decoration: underline;
        }
        
        /* Forgot Password Form */
        .forgot-password-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .back-to-login-link {
            display: block;
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.75rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: color 0.3s ease;
            text-align: center;
        }
        
        .back-to-login-link:hover {
            color: var(--accent-primary);
        }
        
        /* User Info Display */
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: 20px;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .user-name {
            font-family: 'Fredoka', sans-serif;
            color: var(--accent-success);
            font-size: 0.9rem;
        }
        
        .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.3s ease;
        }
        
        .logout-btn:hover {
            color: var(--accent-secondary);
        }
        
        .logout-btn-visible {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--accent-secondary), #ff6b6b);
            color: white;
            border: none;
            border-radius: 20px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .logout-btn-visible:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 45, 117, 0.4);
            filter: brightness(1.1);
        }
        
        #authSection {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .login-btn {
            padding: 0.5rem 1.25rem;
            background: linear-gradient(135deg, var(--accent-success), var(--accent-primary));
            color: var(--bg-primary);
            border: none;
            border-radius: 20px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }
        
        .sync-indicator {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .sync-indicator.syncing {
            color: var(--accent-warning);
        }
        
        .sync-indicator.synced {
            color: var(--accent-success);
        }
        
        /* Settings Button */
        .settings-btn {
            position: relative;
            cursor: pointer;
            border: 1px solid var(--accent-warning);
            color: var(--accent-warning);
            transition: all 0.3s ease;
        }
        
        .settings-btn:hover {
            background: var(--accent-warning);
            color: var(--bg-primary);
            transform: translateY(-2px);
        }
        
        .login-status {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #888;
            border: 2px solid var(--bg-secondary);
        }
        
        .login-status.logged-in {
            background: var(--accent-success);
            box-shadow: 0 0 8px var(--accent-success);
        }
        
        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .settings-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .settings-modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            border: 2px solid var(--accent-warning);
            box-shadow: 0 20px 60px rgba(255, 204, 0, 0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .settings-modal h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-warning);
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .settings-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .settings-close:hover {
            color: var(--accent-secondary);
        }
        
        /* Login Status Card */
        .login-status-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 2px solid var(--bg-tertiary);
        }
        
        .login-status-card.logged-in {
            border-color: var(--accent-success);
            background: rgba(0, 255, 136, 0.1);
        }
        
        .login-status-card .status-icon {
            font-size: 2rem;
        }
        
        .login-status-card .status-info {
            display: flex;
            flex-direction: column;
        }
        
        .login-status-card .status-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .login-status-card .status-text {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        
        .login-status-card.logged-in .status-text {
            color: var(--accent-success);
        }
        
        /* Settings Message */
        .settings-message {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: none;
        }
        
        .settings-message.success {
            display: block;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid var(--accent-success);
            color: var(--accent-success);
        }
        
        .settings-message.error {
            display: block;
            background: rgba(255, 45, 117, 0.2);
            border: 1px solid var(--accent-secondary);
            color: var(--accent-secondary);
        }
        
        /* Settings Sections */
        .settings-section {
            margin-bottom: 1rem;
        }
        
        .settings-group {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .settings-group h3 {
            font-family: 'Fredoka', sans-serif;
            color: var(--accent-primary);
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        
        .settings-field {
            margin-bottom: 1rem;
        }
        
        .settings-field:last-child {
            margin-bottom: 0;
        }
        
        .settings-field label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .settings-field-row {
            display: flex;
            gap: 0.5rem;
        }
        
        .settings-field-row input {
            flex: 1;
            padding: 0.625rem 0.875rem;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .settings-field-row input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        /* Settings Password Input */
        .settings-field .password-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .settings-field .password-input-wrapper input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--bg-secondary);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .settings-field .password-input-wrapper input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.2);
        }
        
        .settings-field .password-input-wrapper input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }
        
        .settings-field .password-input-wrapper .password-toggle {
            position: absolute;
            right: 0.75rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            opacity: 0.6;
            transition: opacity 0.3s ease;
            padding: 0.25rem;
        }
        
        .settings-field .password-input-wrapper .password-toggle:hover {
            opacity: 1;
        }
        
        /* Password Change Section Styling */
        #settingsPasswordChange {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.25rem;
        }
        
        #settingsPasswordChange h3 {
            font-family: 'Fredoka', sans-serif;
            color: var(--accent-warning);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        #settingsPasswordChange .settings-note {
            margin-bottom: 1.25rem;
            margin-top: 0;
        }
        
        #settingsPasswordChange .settings-field {
            margin-bottom: 1rem;
        }
        
        #settingsPasswordChange .settings-buttons {
            margin-top: 1.5rem;
        }
        
        .settings-save-btn {
            padding: 0.625rem 1rem;
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .settings-save-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        
        /* Settings Buttons */
        .settings-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .settings-action-btn {
            width: 100%;
            padding: 0.875rem;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .settings-action-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            color: var(--bg-primary);
        }
        
        .settings-action-btn.secondary {
            background: linear-gradient(135deg, var(--accent-success), var(--accent-primary));
            color: var(--bg-primary);
        }
        
        .settings-action-btn.outline {
            background: transparent;
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .settings-action-btn.danger {
            background: linear-gradient(135deg, var(--accent-secondary), #ff6b6b);
            color: white;
        }
        
        .settings-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        
        .settings-action-btn.outline:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }
        
        .settings-note {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 1rem;
            text-align: center;
            line-height: 1.5;
        }
        
        /* Settings Stats */
        .settings-stats {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--bg-tertiary);
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-row span:first-child {
            color: var(--text-secondary);
        }
        
        .stat-row span:last-child {
            color: var(--accent-primary);
            font-family: 'Orbitron', sans-serif;
        }
        
        /* ===== LIGHT MODE ===== */
        body.light-mode {
            --bg-primary: #e8ecf2;
            --bg-secondary: #ffffff;
            --bg-tertiary: #d1d9e6;
            --bg-card: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #374151;
            --text-code: #7c3aed;
            --grid-color: #94a3b8;
            --border-color: #cbd5e1;
            --accent-primary: #0891b2;
            --accent-secondary: #db2777;
            --accent-tertiary: #7c3aed;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
        }
        
        body.light-mode::before {
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 180, 220, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(147, 51, 234, 0.12) 0%, transparent 50%);
        }
        
        body.light-mode .starfield .star {
            background: rgba(100, 116, 139, 0.3);
        }
        
        body.light-mode .panel {
            box-shadow: 
                0 4px 20px rgba(0, 0, 0, 0.08),
                0 0 0 1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border-color);
        }
        
        body.light-mode .panel::before {
            background: linear-gradient(90deg, #0891b2, #7c3aed);
        }
        
        body.light-mode canvas {
            background: #f1f5f9;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 2px solid #cbd5e1;
        }
        
        body.light-mode .code-editor textarea {
            background: #1e293b;
            color: #e879f9;
            border: 2px solid #475569;
        }
        
        body.light-mode .output {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #1e293b;
        }
        
        body.light-mode .hint-box {
            background: rgba(251, 191, 36, 0.15);
            border-color: #f59e0b;
        }
        
        body.light-mode .level-btn {
            background: #f1f5f9;
            border-color: #94a3b8;
            color: #475569;
        }
        
        body.light-mode .level-btn:hover {
            border-color: #0891b2;
            color: #0891b2;
            background: #e0f2fe;
        }
        
        body.light-mode .level-btn.active {
            background: linear-gradient(135deg, #0891b2, #7c3aed);
            color: white;
            border-color: #0891b2;
        }
        
        body.light-mode .world-btn {
            background: #f1f5f9;
            border-color: #94a3b8;
            color: #475569;
        }
        
        body.light-mode .world-btn:hover {
            border-color: #0891b2;
            color: #0891b2;
        }
        
        body.light-mode .world-btn.active {
            background: linear-gradient(135deg, #0891b2, #7c3aed);
            color: white;
        }
        
        body.light-mode .stat-item {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
        }
        
        body.light-mode .challenge-description {
            background: #f8fafc;
            border-left-color: #7c3aed;
            color: #1e293b;
        }
        
        body.light-mode .challenge-description code {
            background: #e0e7ff;
            color: #4338ca;
        }
        
        body.light-mode .success-message {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            color: #047857;
        }
        
        body.light-mode .error-message {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #dc2626;
        }
        
        body.light-mode .character-modal-content {
            background: #ffffff;
            border-color: #0891b2;
        }
        
        body.light-mode .character-card {
            background: #f8fafc;
            border-color: #cbd5e1;
        }
        
        body.light-mode .character-card:hover {
            border-color: #0891b2;
            background: #e0f2fe;
        }
        
        body.light-mode .character-card.selected {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        body.light-mode .quick-ref-panel {
            background: #ffffff;
            border-color: #cbd5e1;
        }
        
        body.light-mode .floating-help-btn {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        body.light-mode .panel-title {
            color: #0891b2;
        }
        
        body.light-mode .game-info {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
        }
        
        body.light-mode .info-item .label {
            color: #475569;
        }
        
        body.light-mode .run-btn {
            background: linear-gradient(135deg, #0891b2, #0e7490);
            box-shadow: 0 4px 12px rgba(8, 145, 178, 0.3);
        }
        
        body.light-mode .level-complete-modal {
            background: #ffffff;
            border-color: #0891b2;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 1.5rem;
            animation: fadeInUp 0.8s ease 0.2s backwards;
        }
        
        .panel {
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(0, 245, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-tertiary), var(--accent-secondary));
        }
        
        .panel::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 20px;
            background: linear-gradient(180deg, rgba(0, 245, 255, 0.2) 0%, transparent 100%);
            border-radius: 0 0 50% 50%;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .world-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .world-btn {
            padding: 0.4rem 0.8rem;
            border: 2px solid var(--bg-tertiary);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .world-btn:hover {
            border-color: var(--accent-tertiary);
            color: var(--accent-tertiary);
        }
        
        .world-btn.active {
            background: linear-gradient(135deg, var(--accent-tertiary), var(--accent-secondary));
            border-color: var(--accent-tertiary);
            color: white;
        }
        
        .level-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.4rem;
            margin-bottom: 1rem;
        }
        
        .level-btn {
            padding: 0.5rem;
            border: 2px solid var(--bg-tertiary);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .level-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 245, 255, 0.2);
        }
        
        .level-btn.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            border-color: var(--accent-primary);
            color: var(--bg-primary);
            box-shadow: 0 0 20px var(--glow-primary);
        }
        
        .level-btn.completed {
            background: linear-gradient(135deg, var(--accent-success), #00cc6a);
            border-color: var(--accent-success);
            color: var(--bg-primary);
        }
        
        /* Block mode completion - purple */
        .level-btn.completed-block {
            background: linear-gradient(135deg, #9966FF, #774DCB);
            border-color: #9966FF;
            color: white;
        }
        
        /* Both modes completion - green to purple gradient with prize */
        .level-btn.completed-both {
            background: linear-gradient(135deg, var(--accent-success), #00cc6a, #9966FF, #774DCB);
            border-color: #FFD700;
            color: white;
            position: relative;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .level-btn.completed-both::after {
            content: 'üèÜ';
            position: absolute;
            top: -6px;
            right: -6px;
            font-size: 0.7rem;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));
        }
        
        .level-btn .stars {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            white-space: nowrap;
        }
        
        .challenge-box {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-secondary);
            position: relative;
            overflow: hidden;
        }
        
        .challenge-box::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(255, 45, 117, 0.1) 0%, transparent 70%);
        }
        
        .challenge-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            color: var(--accent-warning);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .challenge-description {
            line-height: 1.6;
            font-size: 0.9rem;
        }
        
        .challenge-description code {
            background: var(--bg-primary);
            color: var(--text-code);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
        }
        
        .new-concept {
            display: inline-block;
            background: linear-gradient(135deg, var(--accent-tertiary), var(--accent-secondary));
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 0.5rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(177, 78, 255, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(177, 78, 255, 0); }
        }
        
        .code-editor-container {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .editor-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .editor-tab {
            padding: 0.4rem 1rem;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px 8px 0 0;
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .editor-tab.active {
            background: var(--bg-primary);
            color: var(--accent-primary);
        }
        
        .code-editor {
            position: relative;
            background: var(--bg-primary);
            border-radius: 0 12px 12px 12px;
            overflow: hidden;
            border: 2px solid var(--bg-tertiary);
            transition: border-color 0.3s ease;
        }
        
        .code-editor:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.1);
        }
        
        .line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3rem;
            background: var(--bg-secondary);
            border-right: 1px solid var(--bg-tertiary);
            padding: 1rem 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            user-select: none;
            line-height: 1.5;
            text-align: right;
            overflow: hidden;
        }
        
        textarea {
            width: 100%;
            height: 220px;
            background: transparent;
            color: var(--text-code);
            border: none;
            padding: 1rem 1rem 1rem 4rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            resize: none;
            line-height: 1.5;
        }
        
        /* ===== BLOCK MODE STYLES ===== */
        .editor-mode-toggle {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 20px;
            padding: 3px;
            margin-left: auto;
        }
        
        .mode-btn {
            padding: 0.4rem 1rem;
            border: none;
            border-radius: 17px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: var(--text-secondary);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            color: var(--bg-primary);
        }
        
        .mode-btn:hover:not(.active) {
            color: var(--text-primary);
        }
        
        .block-editor {
            display: none;
            flex-direction: column;
            height: 300px;
            background: var(--bg-primary);
            border-radius: 12px;
            border: 2px solid var(--bg-tertiary);
            overflow: hidden;
        }
        
        .block-editor.active {
            display: flex;
        }
        
        .code-editor-wrapper {
            display: block;
        }
        
        .code-editor-wrapper.hidden {
            display: none;
        }
        
        .block-palette {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--bg-tertiary);
            flex-wrap: wrap;
            align-items: center;
        }
        
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-left: auto;
            background: var(--bg-tertiary);
            border-radius: 15px;
            padding: 0.2rem 0.4rem;
        }
        
        .zoom-btn {
            width: 22px;
            height: 22px;
            border: none;
            border-radius: 50%;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .zoom-btn:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }
        
        .zoom-level {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-secondary);
            min-width: 35px;
            text-align: center;
        }
        
        .palette-category {
            padding: 0.35rem 0.75rem;
            border: none;
            border-radius: 15px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        
        .palette-category:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        
        .palette-category.active {
            opacity: 1;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .palette-category.motion { background: #4C97FF; color: white; }
        .palette-category.collect { background: #59C059; color: white; }
        .palette-category.check { background: #FF8C1A; color: white; }
        .palette-category.control { background: #FFAB19; color: white; }
        .palette-category.loop { background: #9966FF; color: white; }
        
        .block-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .block-list {
            width: 160px;
            padding: 0.5rem;
            background: var(--bg-secondary);
            overflow-y: auto;
            border-right: 1px solid var(--bg-tertiary);
        }
        
        .block-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .block-list::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }
        
        .block-workspace-wrapper {
            flex: 1;
            overflow: auto;
            position: relative;
            border: 2px solid transparent;
            border-radius: 0 0 8px 0;
            transition: border-color 0.2s ease;
        }
        
        .block-workspace {
            min-width: 100%;
            min-height: 100%;
            padding: 0.75rem;
            position: relative;
            background-color: var(--bg-primary);
            background-image: 
                linear-gradient(90deg, var(--bg-tertiary) 1px, transparent 1px),
                linear-gradient(var(--bg-tertiary) 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: -1px -1px;
            transition: background 0.2s ease;
            transform-origin: top left;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
        
        .workspace-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-align: center;
            pointer-events: none;
            opacity: 0.5;
            z-index: 0;
        }
        
        .workspace-hint.hidden {
            display: none;
        }
        
        .block-workspace > .workspace-block {
            z-index: 1;
        }
        
        /* Block styles */
        .block {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.35rem 0.5rem;
            margin-bottom: 0.3rem;
            border-radius: 6px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.7rem;
            cursor: grab;
            user-select: none;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        
        .block .icon {
            font-size: 0.85rem;
        }
        
        .block-list .block {
            cursor: grab;
            display: flex;
            width: fit-content;
        }
        
        .block-list .block:active {
            cursor: grabbing;
            transform: scale(1.05);
        }
        
        .block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .block:active {
            cursor: grabbing;
        }
        
        .block.dragging {
            opacity: 0.8;
            z-index: 1000;
            pointer-events: none;
        }
        
        /* Block colors by category */
        .block.motion {
            background: linear-gradient(135deg, #4C97FF, #3373CC);
            color: white;
        }
        
        .block.collect {
            background: linear-gradient(135deg, #59C059, #45A045);
            color: white;
        }
        
        .block.check {
            background: linear-gradient(135deg, #FF8C1A, #E67300);
            color: white;
        }
        
        .block.control {
            background: linear-gradient(135deg, #FFAB19, #E69500);
            color: white;
        }
        
        .block.loop {
            background: linear-gradient(135deg, #9966FF, #774DCB);
            color: white;
        }
        
        /* Container blocks (if, while, for) */
        .block.container {
            flex-direction: column;
            align-items: stretch;
            padding: 0;
            background: none !important;
            box-shadow: none !important;
        }
        
        .block.container:hover {
            transform: none;
            box-shadow: none !important;
        }
        
        .block-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .block.container.control .block-header {
            background: linear-gradient(135deg, #FFAB19, #E69500);
        }
        
        .block.container.loop .block-header {
            background: linear-gradient(135deg, #9966FF, #774DCB);
        }
        
        .block-body {
            min-height: 40px;
            margin-left: 12px;
            padding: 0.5rem;
            border-left: 4px solid;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0 0 0 8px;
        }
        
        .block.container.control .block-body {
            border-color: #FFAB19;
        }
        
        .block.container.loop .block-body {
            border-color: #9966FF;
        }
        
        .block-footer {
            height: 8px;
            margin-left: 12px;
            border-left: 4px solid;
            border-bottom: 4px solid;
            border-radius: 0 0 0 8px;
            width: 40px;
        }
        
        .block.container.control .block-footer {
            border-color: #FFAB19;
        }
        
        .block.container.loop .block-footer {
            border-color: #9966FF;
        }
        
        /* Workspace container blocks */
        .workspace-block.container-block {
            margin-bottom: 0.3rem;
            display: block;
            width: fit-content;
        }
        
        .workspace-block.container-block > .block {
            margin-bottom: 0;
        }
        
        .workspace-block .block-body {
            min-height: 30px;
            margin-left: 8px;
            padding: 0.35rem;
            padding-left: 0.5rem;
            border-left: 3px solid;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.15rem;
        }
        
        .workspace-block .block-body .workspace-block {
            display: block;
            margin-bottom: 0.1rem;
        }
        
        .workspace-block .block-footer {
            height: 8px;
            margin-left: 8px;
            border-left: 3px solid;
            border-bottom: 3px solid;
            border-radius: 0 0 0 6px;
            width: 35px;
        }
        
        /* Block input fields */
        .block-input {
            width: 28px;
            padding: 0.1rem 0.2rem;
            border: none;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            text-align: center;
        }
        
        .block-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
        }
        
        .block-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* Block select dropdown */
        .block-select {
            padding: 0.1rem 0.2rem;
            border: none;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.6rem;
            cursor: pointer;
            max-width: 80px;
        }
        
        .block-select:focus {
            outline: none;
        }
        
        .block-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        /* Workspace blocks */
        .workspace-block {
            position: relative;
            margin-bottom: 0.15rem;
            display: block;
            width: fit-content;
        }
        
        .workspace-block > .block {
            cursor: default;
            display: inline-flex;
        }
        
        .workspace-block .delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 14px;
            height: 14px;
            background: var(--accent-secondary);
            border: 1px solid var(--bg-primary);
            border-radius: 50%;
            color: white;
            font-size: 0.55rem;
            font-weight: bold;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            line-height: 1;
        }
        
        .workspace-block:hover > .delete-btn {
            opacity: 1;
        }
        
        .workspace-block .delete-btn:hover {
            transform: scale(1.2);
            background: #ff1744;
        }
        
        /* Drop zone highlight */
        .drop-zone {
            min-height: 30px;
            border: 2px dashed var(--accent-primary);
            border-radius: 8px;
            margin: 0.25rem 0;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .drop-zone.active {
            opacity: 1;
            background: rgba(0, 245, 255, 0.1);
        }
        
        /* Generated code preview */
        .generated-code {
            display: none;
            background: var(--bg-secondary);
            border-top: 1px solid var(--bg-tertiary);
            padding: 0.5rem 0.75rem;
            max-height: 100px;
            overflow-y: auto;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-code);
        }
        
        .generated-code.show {
            display: block;
        }
        
        .generated-code pre {
            margin: 0;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        
        .generated-code::before {
            content: 'üìÑ ÁîüÊàê„Åï„Çå„Åü„Ç≥„Éº„Éâ:';
            display: block;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        textarea:focus {
            outline: none;
        }
        
        .controls {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        button {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .run-btn {
            background: linear-gradient(135deg, var(--accent-primary), #00b8c8);
            color: var(--bg-primary);
            flex: 1;
            box-shadow: 0 4px 15px rgba(0, 245, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .run-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 245, 255, 0.4);
        }
        
        .run-btn:active {
            transform: translateY(0);
        }
        
        .hint-btn {
            background: var(--bg-tertiary);
            color: var(--accent-warning);
            border: 2px solid var(--accent-warning);
        }
        
        .hint-btn:hover {
            background: var(--accent-warning);
            color: var(--bg-primary);
        }
        
        .reset-btn {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 2px solid var(--text-secondary);
        }
        
        .reset-btn:hover {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
            color: white;
        }
        
        .hint-box {
            background: linear-gradient(135deg, rgba(255, 204, 0, 0.1), rgba(255, 123, 0, 0.1));
            border: 2px solid var(--accent-warning);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .hint-box.show {
            display: block;
        }
        
        .hint-box code {
            display: block;
            background: var(--bg-primary);
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            color: var(--text-code);
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .output {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            min-height: 80px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.5;
            border: 1px solid var(--bg-tertiary);
        }
        
        .output p {
            margin: 0.25rem 0;
            padding-left: 0.5rem;
            border-left: 2px solid var(--accent-primary);
        }
        
        .canvas-container {
            background: linear-gradient(180deg, #0d1321 0%, #151d32 100%);
            border-radius: 16px;
            padding: 1rem;
            position: relative;
            border: 2px solid var(--bg-tertiary);
            overflow: hidden;
        }
        
        .canvas-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 30% 30%, rgba(0, 245, 255, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 70% 70%, rgba(177, 78, 255, 0.05) 0%, transparent 40%);
            pointer-events: none;
        }
        
        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 8px;
            box-shadow: 
                0 0 30px rgba(0, 0, 0, 0.5),
                inset 0 0 50px rgba(0, 245, 255, 0.03);
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }
        
        .game-info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .game-info-item .icon {
            font-size: 1.2rem;
        }
        
        .game-info-item .value {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-primary);
            font-weight: 700;
        }
        
        .success-message {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 204, 106, 0.2));
            border: 2px solid var(--accent-success);
            color: var(--accent-success);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            font-weight: 700;
            animation: successPop 0.5s ease;
            margin-top: 1rem;
        }
        
        .error-message {
            background: linear-gradient(135deg, rgba(255, 45, 117, 0.2), rgba(255, 45, 117, 0.1));
            border: 2px solid var(--accent-secondary);
            color: var(--accent-secondary);
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes successPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Celebration effects */
        .celebration-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s linear forwards;
        }
        
        @keyframes confettiFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        .level-complete-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 23, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
            animation: fadeIn 0.3s ease;
        }
        
        .level-complete-modal.show {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            padding: 2.5rem;
            border-radius: 24px;
            text-align: center;
            max-width: 400px;
            border: 2px solid var(--accent-success);
            box-shadow: 0 0 60px rgba(0, 255, 136, 0.3);
            animation: modalPop 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalPop {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: var(--accent-success);
            margin-bottom: 1rem;
        }
        
        .modal-stars {
            font-size: 3rem;
            margin: 1rem 0;
        }
        
        .modal-message {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }
        
        .modal-btn {
            background: linear-gradient(135deg, var(--accent-success), #00cc6a);
            color: var(--bg-primary);
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 12px;
            cursor: pointer;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }
        
        /* Quick Reference Panel */
        .quick-ref-panel {
            position: fixed;
            right: -350px;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            max-height: 80vh;
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border-radius: 20px 0 0 20px;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
            z-index: 998;
            transition: right 0.4s ease;
            overflow: hidden;
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-right: none;
        }
        
        .quick-ref-panel.open {
            right: 0;
        }
        
        .quick-ref-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .quick-ref-header h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            color: var(--accent-primary);
            margin: 0;
        }
        
        .quick-ref-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .quick-ref-close:hover {
            background: var(--accent-secondary);
            color: white;
        }
        
        .quick-ref-content {
            padding: 1rem 1.25rem;
            overflow-y: auto;
            max-height: calc(80vh - 60px);
        }
        
        .quick-ref-section {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .quick-ref-section:last-of-type {
            border-bottom: none;
        }
        
        .quick-ref-section h4 {
            font-family: 'Fredoka', sans-serif;
            font-size: 0.9rem;
            color: var(--accent-warning);
            margin-bottom: 0.5rem;
        }
        
        .quick-ref-section code {
            display: inline-block;
            background: var(--bg-primary);
            color: var(--text-code);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 0.15rem 0;
        }
        
        .full-ref-link {
            display: block;
            text-align: center;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            color: var(--bg-primary);
            text-decoration: none;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            margin-top: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .full-ref-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 245, 255, 0.3);
        }
        
        /* Floating Help Button */
        .floating-help-btn {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-tertiary), var(--accent-secondary));
            border: none;
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            cursor: pointer;
            z-index: 997;
            box-shadow: 0 4px 20px rgba(177, 78, 255, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .floating-help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(177, 78, 255, 0.6);
        }
        
        .floating-help-btn.active {
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent-tertiary));
            transform: rotate(45deg);
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }
        
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            .level-selector {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .level-selector {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .stats-bar {
                gap: 0.5rem;
            }
            
            .stat-item {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="starfield" id="starfield"></div>
    
    <div class="container">
        <header>
            <div class="logo-container">
                <h1>‚ö° CODEQUEST ÈÅìÂ†¥</h1>
            </div>
            <p class="subtitle">JavaScript „Éû„Çπ„Çø„Éº„Å∏„ÅÆÈÅì</p>
            
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-icon">üèÜ</span>
                    <span>„ÇØ„É™„Ç¢:</span>
                    <span class="stat-value" id="completedCount">0</span>
                    <span>/80</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">‚≠ê</span>
                    <span>„Çπ„Çø„Éº:</span>
                    <span class="stat-value" id="totalStars">0</span>
                </div>
                <button class="stat-item theme-toggle" id="themeToggle" title="„ÉÜ„Éº„ÉûÂàáÊõø">
                    <span class="stat-icon" id="themeIcon">üåô</span>
                    <span id="themeText">„ÉÄ„Éº„ÇØ</span>
                </button>
                <button class="stat-item character-btn" id="characterBtn" title="„Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû">
                    <span class="stat-icon">ü§ñ</span>
                    <span>„Ç≠„É£„É©</span>
                </button>
                <a href="codequest-reference.html" class="stat-item help-link">
                    <span class="stat-icon">üìñ</span>
                    <span>„É™„Éï„Ç°„É¨„É≥„Çπ</span>
                </a>
                
                <!-- Settings Button -->
                <button class="stat-item settings-btn" id="settingsBtn" title="Ë®≠ÂÆö">
                    <span class="stat-icon">‚öôÔ∏è</span>
                    <span>Ë®≠ÂÆö</span>
                    <span class="login-status" id="loginStatusDot"></span>
                </button>
            </div>
            
            <!-- Sync Status -->
            <div class="sync-indicator" id="syncIndicator" style="display: none;">
                <span id="syncIcon">‚òÅÔ∏è</span>
                <span id="syncText">ÂêåÊúü‰∏≠...</span>
            </div>
        </header>
        
        <div class="main-grid">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">üìù „Ç≥„Éº„Éâ„Ç®„Éá„Ç£„Çø</h2>
                </div>
                
                <div class="world-selector" id="worldSelector">
                    <button class="world-btn active" data-world="1">üåç Âü∫Á§é</button>
                    <button class="world-btn" data-world="2">üîÅ „É´„Éº„Éó</button>
                    <button class="world-btn" data-world="3">üîÄ Êù°‰ª∂</button>
                    <button class="world-btn" data-world="4">‚öôÔ∏è Èñ¢Êï∞</button>
                </div>
                
                <div class="level-selector" id="levelSelector"></div>
                
                <div class="challenge-box">
                    <div class="challenge-title" id="challengeTitle">
                        <span>üéØ „Éü„ÉÉ„Ç∑„Éß„É≥</span>
                    </div>
                    <div class="challenge-description" id="challengeDescription"></div>
                </div>
                
                <div class="hint-box" id="hintBox"></div>
                
                <div class="code-editor-container">
                    <div class="editor-tabs">
                        <button class="editor-tab active">main.js</button>
                        <div class="editor-mode-toggle">
                            <button class="mode-btn active" id="codeModeBtn">üìù „Ç≥„Éº„Éâ</button>
                            <button class="mode-btn" id="blockModeBtn">üß© „Éñ„É≠„ÉÉ„ÇØ</button>
                        </div>
                    </div>
                    
                    <!-- Code Editor (default) -->
                    <div class="code-editor-wrapper" id="codeEditorWrapper">
                        <div class="code-editor">
                            <div class="line-numbers" id="lineNumbers">1</div>
                            <textarea id="codeInput" spellcheck="false"></textarea>
                        </div>
                    </div>
                    
                    <!-- Block Editor -->
                    <div class="block-editor" id="blockEditor">
                        <div class="block-palette">
                            <button class="palette-category motion active" data-category="motion">üö∂ ÁßªÂãï</button>
                            <button class="palette-category collect" data-category="collect">‚≠ê ÂèéÈõÜ</button>
                            <button class="palette-category check" data-category="check">üîç „ÉÅ„Çß„ÉÉ„ÇØ</button>
                            <button class="palette-category control" data-category="control">üîÄ Êù°‰ª∂</button>
                            <button class="palette-category loop" data-category="loop">üîÑ „É´„Éº„Éó</button>
                            <div class="zoom-controls">
                                <button class="zoom-btn" id="zoomOutBtn" title="Á∏ÆÂ∞è">‚àí</button>
                                <span class="zoom-level" id="zoomLevel">100%</span>
                                <button class="zoom-btn" id="zoomInBtn" title="Êã°Â§ß">+</button>
                            </div>
                        </div>
                        <div class="block-container">
                            <div class="block-list" id="blockList">
                                <!-- Blocks will be inserted here by JS -->
                            </div>
                            <div class="block-workspace-wrapper">
                                <div class="block-workspace" id="blockWorkspace">
                                    <div class="workspace-hint" id="workspaceHint">
                                        ‚Üê „Éñ„É≠„ÉÉ„ÇØ„Çí„Åì„Åì„Å´„Éâ„É©„ÉÉ„Ç∞ÔºÅ
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="generated-code" id="generatedCode">
                            <pre id="generatedCodePre"></pre>
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="run-btn" id="runBtn">
                        <span>‚ñ∂</span>
                        <span>ÂÆüË°å</span>
                    </button>
                    <button class="hint-btn" id="hintBtn">üí°</button>
                    <button class="reset-btn" id="resetBtn">‚Ü∫</button>
                </div>
                
                <div class="output" id="output"></div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">üéÆ „Ç∑„Éü„É•„É¨„Éº„Çø„Éº</h2>
                </div>
                
                <div class="canvas-container">
                    <canvas id="gameCanvas" width="580" height="420"></canvas>
                </div>
                
                <div class="game-info">
                    <div class="game-info-item">
                        <span class="icon">ü§ñ</span>
                        <span>‰ΩçÁΩÆ:</span>
                        <span class="value" id="robotPos">(0, 0)</span>
                    </div>
                    <div class="game-info-item">
                        <span class="icon">‚≠ê</span>
                        <span>ÂèéÈõÜ:</span>
                        <span class="value" id="starsCollected">0</span>
                    </div>
                    <div class="game-info-item">
                        <span class="icon">üíé</span>
                        <span>„Ç∏„Çß„É†:</span>
                        <span class="value" id="gemsCollected">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="celebration-container" id="celebrationContainer"></div>
    
    <div class="level-complete-modal" id="levelCompleteModal">
        <div class="modal-content">
            <h2 class="modal-title">üéâ „ÇØ„É™„Ç¢!</h2>
            <div class="modal-stars" id="modalStars">‚≠ê‚≠ê‚≠ê</div>
            <p class="modal-message" id="modalMessage">Á¥†Êô¥„Çâ„Åó„ÅÑ! Ê¨°„ÅÆ„É¨„Éô„É´„Å´ÊåëÊà¶„Åó„Çà„ÅÜ!</p>
            <button class="modal-btn" id="nextLevelBtn">Ê¨°„Å∏ÈÄ≤„ÇÄ ‚Üí</button>
        </div>
    </div>
    
    <!-- Quick Reference Panel -->
    <div class="quick-ref-panel" id="quickRefPanel">
        <div class="quick-ref-header">
            <h3>üìñ „ÇØ„Ç§„ÉÉ„ÇØ„É™„Éï„Ç°„É¨„É≥„Çπ</h3>
            <button class="quick-ref-close" id="closeQuickRef">‚úï</button>
        </div>
        <div class="quick-ref-content">
            <div class="quick-ref-section">
                <h4>üö∂ ÁßªÂãï</h4>
                <code>robot.move()</code> - Âè≥„Å´1„Éû„Çπ<br>
                <code>robot.moveUp()</code> - ‰∏ä„Å´1„Éû„Çπ<br>
                <code>robot.moveDown()</code> - ‰∏ã„Å´1„Éû„Çπ<br>
                <code>robot.jump()</code> - „Ç∏„É£„É≥„ÉóÔºàÈöúÂÆ≥Áâ©Ë∂ä„ÅàÔºâ
            </div>
            <div class="quick-ref-section">
                <h4>‚≠ê ÂèéÈõÜ</h4>
                <code>robot.collect()</code> - Êòü„ÇíÂèéÈõÜ<br>
                <code>robot.collectGem()</code> - „Ç∏„Çß„É†„ÇíÂèéÈõÜ
            </div>
            <div class="quick-ref-section">
                <h4>üîç „ÉÅ„Çß„ÉÉ„ÇØ</h4>
                <code>robot.isObstacle()</code> - ÂâçÊñπ„Å´ÈöúÂÆ≥Áâ©?<br>
                <code>robot.isStar()</code> - Êòü„Åå„ÅÇ„Çã?<br>
                <code>robot.isGem()</code> - „Ç∏„Çß„É†„Åå„ÅÇ„Çã?<br>
                <code>robot.isGoal()</code> - „Ç¥„Éº„É´?
            </div>
            <div class="quick-ref-section">
                <h4>üìä Áä∂ÊÖã</h4>
                <code>robot.x</code> - XÂ∫ßÊ®ô<br>
                <code>robot.y</code> - YÂ∫ßÊ®ô<br>
                <code>robot.starsCollected</code> - Êòü„ÅÆÊï∞
            </div>
            <a href="codequest-reference.html" class="full-ref-link">üìö Ë©≥„Åó„ÅÑ„É™„Éï„Ç°„É¨„É≥„Çπ„ÇíË¶ã„Çã ‚Üí</a>
        </div>
    </div>
    
    <!-- Floating Help Button -->
    <button class="floating-help-btn" id="floatingHelpBtn" title="„ÇØ„Ç§„ÉÉ„ÇØ„É™„Éï„Ç°„É¨„É≥„Çπ">
        <span>?</span>
    </button>
    
    <!-- Character Selection Modal -->
    <div class="character-modal" id="characterModal">
        <div class="character-modal-content">
            <h2>ü§ñ „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû</h2>
            <div class="character-grid" id="characterGrid">
                <!-- Characters will be added by JavaScript -->
            </div>
            <button class="character-modal-close" id="closeCharacterModal">Ê±∫ÂÆö</button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-modal-content">
            <button class="auth-close" id="closeAuthModal">‚úï</button>
            <h2>üîê „É≠„Ç∞„Ç§„É≥ / ÁôªÈå≤</h2>
            
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">„É≠„Ç∞„Ç§„É≥</button>
                <button class="auth-tab" data-tab="register">Êñ∞Ë¶èÁôªÈå≤</button>
            </div>
            
            <div class="auth-error" id="authError"></div>
            <div class="auth-success" id="authSuccess"></div>
            
            <!-- Google Login Button -->
            <button type="button" class="google-login-btn" id="googleLoginBtn">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Google„Åß„É≠„Ç∞„Ç§„É≥
            </button>
            
            <div class="auth-divider">
                <span>„Åæ„Åü„ÅØ</span>
            </div>
            
            <!-- Login Form -->
            <form class="auth-form active" id="loginForm">
                <div class="auth-input-group">
                    <label for="loginEmail">üìß „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" id="loginEmail" required placeholder="example@mail.com">
                </div>
                <div class="auth-input-group">
                    <label for="loginPassword">üîë „Éë„Çπ„ÉØ„Éº„Éâ</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="loginPassword" required placeholder="„Éë„Çπ„ÉØ„Éº„Éâ">
                        <button type="button" class="password-toggle" data-target="loginPassword">üëÅÔ∏è</button>
                    </div>
                </div>
                <button type="submit" class="auth-btn">„É≠„Ç∞„Ç§„É≥</button>
                <button type="button" class="forgot-password-link" id="forgotPasswordBtn">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„ÅüÊñπ</button>
            </form>
            
            <!-- Register Form -->
            <form class="auth-form" id="registerForm">
                <div class="auth-input-group">
                    <label for="registerNickname">üë§ „Éã„ÉÉ„ÇØ„Éç„Éº„É†</label>
                    <input type="text" id="registerNickname" required placeholder="„ÅÇ„Å™„Åü„ÅÆÂêçÂâç" maxlength="20">
                </div>
                <div class="auth-input-group">
                    <label for="registerEmail">üìß „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" id="registerEmail" required placeholder="example@mail.com">
                </div>
                <div class="auth-input-group">
                    <label for="registerPassword">üîë „Éë„Çπ„ÉØ„Éº„ÉâÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="registerPassword" required placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" minlength="6">
                        <button type="button" class="password-toggle" data-target="registerPassword">üëÅÔ∏è</button>
                    </div>
                </div>
                <button type="submit" class="auth-btn">„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê</button>
            </form>
            
            <!-- Forgot Password Form -->
            <form class="auth-form" id="forgotPasswordForm">
                <p class="forgot-password-text">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„ÉàÁî®„ÅÆ„É™„É≥„ÇØ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô„ÄÇ</p>
                <div class="auth-input-group">
                    <label for="resetEmail">üìß „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" id="resetEmail" required placeholder="example@mail.com">
                </div>
                <button type="submit" class="auth-btn">„É™„Çª„ÉÉ„Éà„É™„É≥„ÇØ„ÇíÈÄÅ‰ø°</button>
                <button type="button" class="back-to-login-link" id="backToLoginBtn">‚Üê „É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã</button>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-modal-content">
            <button class="settings-close" id="closeSettingsModal">‚úï</button>
            <h2>‚öôÔ∏è Ë®≠ÂÆö</h2>
            
            <!-- Login Status -->
            <div class="settings-login-status" id="settingsLoginStatus">
                <div class="login-status-card not-logged-in" id="loginStatusCard">
                    <div class="status-icon">üë§</div>
                    <div class="status-info">
                        <span class="status-label">„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã</span>
                        <span class="status-text" id="loginStatusText">„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì</span>
                    </div>
                </div>
            </div>
            
            <div class="settings-message" id="settingsMessage"></div>
            
            <!-- Not Logged In View -->
            <div class="settings-section" id="settingsNotLoggedIn">
                <div class="settings-buttons">
                    <button class="settings-action-btn primary" id="openLoginBtn">
                        üîê „É≠„Ç∞„Ç§„É≥
                    </button>
                    <button class="settings-action-btn secondary" id="openRegisterBtn">
                        ‚ú® Êñ∞Ë¶èÁôªÈå≤
                    </button>
                </div>
                <p class="settings-note">„É≠„Ç∞„Ç§„É≥„Åô„Çã„Å®„ÄÅÈÄ≤Êçó„Åå„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åï„Çå„ÄÅ‰ªñ„ÅÆ„Éá„Éê„Ç§„Çπ„Åß„ÇÇÁ∂ö„Åç„Åã„Çâ„Éó„É¨„Ç§„Åß„Åç„Åæ„Åô„ÄÇ</p>
            </div>
            
            <!-- Logged In View -->
            <div class="settings-section" id="settingsLoggedIn" style="display: none;">
                <!-- Profile Section -->
                <div class="settings-group">
                    <h3>üë§ „Éó„É≠„Éï„Ç£„Éº„É´</h3>
                    
                    <div class="settings-field">
                        <label>„Éã„ÉÉ„ÇØ„Éç„Éº„É†</label>
                        <div class="settings-field-row">
                            <input type="text" id="settingsNickname" maxlength="20" placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†">
                            <button class="settings-save-btn" id="saveNicknameBtn">‰øùÂ≠ò</button>
                        </div>
                    </div>
                    
                    <div class="settings-field">
                        <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <div class="settings-field-row">
                            <input type="email" id="settingsEmail" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ">
                            <button class="settings-save-btn" id="saveEmailBtn">Â§âÊõ¥</button>
                        </div>
                    </div>
                </div>
                
                <!-- Security Section -->
                <div class="settings-group">
                    <h3>üîí „Çª„Ç≠„É•„É™„ÉÜ„Ç£</h3>
                    
                    <button class="settings-action-btn outline" id="changePasswordBtn">
                        üîë „Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥
                    </button>
                </div>
                
                <!-- Data Section -->
                <div class="settings-group">
                    <h3>üìä „Éá„Éº„Çø</h3>
                    <div class="settings-stats">
                        <div class="stat-row">
                            <span>„ÇØ„É™„Ç¢„Åó„Åü„É¨„Éô„É´</span>
                            <span id="settingsCompletedLevels">0 / 80</span>
                        </div>
                        <div class="stat-row">
                            <span>Áç≤Âæó„Åó„ÅüÊòü</span>
                            <span id="settingsTotalStars">0</span>
                        </div>
                        <div class="stat-row">
                            <span>‰ΩøÁî®„Ç≠„É£„É©„ÇØ„Çø„Éº</span>
                            <span id="settingsCharacter">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Logout Section -->
                <div class="settings-group">
                    <button class="settings-action-btn danger" id="settingsLogoutBtn">
                        üö™ „É≠„Ç∞„Ç¢„Ç¶„Éà
                    </button>
                </div>
            </div>
            
            <!-- Password Change Form -->
            <div class="settings-section" id="settingsPasswordChange" style="display: none;">
                <h3>üîë „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥</h3>
                <p class="settings-note">Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                
                <div class="settings-field">
                    <label>Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„ÉâÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="newPassword" minlength="6" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ">
                        <button type="button" class="password-toggle" data-target="newPassword">üëÅÔ∏è</button>
                    </div>
                </div>
                
                <div class="settings-field">
                    <label>„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="confirmPassword" minlength="6" placeholder="„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç">
                        <button type="button" class="password-toggle" data-target="confirmPassword">üëÅÔ∏è</button>
                    </div>
                </div>
                
                <div class="settings-buttons">
                    <button class="settings-action-btn primary" id="savePasswordBtn">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥</button>
                    <button class="settings-action-btn outline" id="cancelPasswordChangeBtn">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </div>
        </div>
    </div>

    <script>

async function fetchKeys() {
  try {
    const res = await fetch("https://codequest.masashilandjob.workers.dev/", {
      method: "GET",
      mode: "cors",
      headers: {
        "Accept": "application/json"
      }
    });

    if (!res.ok) {
      throw new Error(`Worker error: ${res.status}`);
    }

    const data = await res.json();
    console.log("Worker data:", data);
    return data;

  } catch (err) {
    console.error("Error fetching data from Worker:", err);
    return null;
  }
}

  
        
        // Supabase „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂàùÊúüÂåñ
       let supabaseClient = null;
let currentUser = null;
let userProfile = null;

async function initSupabase() {
  const keys = await fetchKeys();

  if (!keys || !keys.supabaseUrl || !keys.supabaseAnonKey) {
    console.error("Supabase keys not available");
    return;
  }

  supabaseClient = supabase.createClient(
    keys.supabaseUrl,
    keys.supabaseAnonKey
  );

            
            try {
                supabaseClient = supabase.createClient( keys.supabaseUrl, keys.supabaseAnonKey, {
                    auth: {
                        detectSessionInUrl: true,
                        autoRefreshToken: true,
                        persistSession: true
                    }
                });
                console.log('‚úÖ SupabaseÊé•Á∂öÊàêÂäü');
                
                // URL„Åã„ÇâOAuth„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÊ§úÂá∫
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const queryParams = new URLSearchParams(window.location.search);
                
                const hasHashToken = hashParams.get('access_token') || hashParams.get('refresh_token');
                const hasAuthCode = queryParams.get('code');
                
                console.log('üîç URLÊ§úÊüª:', { 
                    hasHashToken: !!hasHashToken, 
                    hasAuthCode: !!hasAuthCode,
                    hash: window.location.hash.substring(0, 50) + '...',
                    search: window.location.search.substring(0, 50)
                });
                
                // OAuth „Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ
                if (hasHashToken || hasAuthCode) {
                    console.log('üîë OAuth„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÊ§úÂá∫„ÄÅ„Çª„ÉÉ„Ç∑„Éß„É≥Âá¶ÁêÜ‰∏≠...');
                    
                    // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂèñÂæóÔºàSupabase„ÅÆÂá¶ÁêÜ„ÇíÂæÖ„Å§Ôºâ
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const { data, error } = await supabaseClient.auth.getSession();
                    
                    console.log('üìã „Çª„ÉÉ„Ç∑„Éß„É≥ÂèñÂæóÁµêÊûú:', { 
                        hasSession: !!data?.session, 
                        error: error?.message 
                    });
                    
                    if (error) {
                        console.error('OAuth „Çª„ÉÉ„Ç∑„Éß„É≥„Ç®„É©„Éº:', error);
                    }
                    
                    if (data?.session) {
                        console.log('‚úÖ OAuth„É≠„Ç∞„Ç§„É≥ÊàêÂäü:', data.session.user.email);
                        currentUser = data.session.user;
                        await loadUserProfile();
                        await syncProgressFromCloud();
                        updateAuthUI();
                        
                        // URL„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                        window.history.replaceState(null, '', window.location.pathname);
                        return;
                    } else {
                        console.log('‚ö†Ô∏è OAuth„Éà„Éº„ÇØ„É≥„ÅØ„ÅÇ„Çã„Åå„Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó');
                    }
                }
                
                // ÈÄöÂ∏∏„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥Á¢∫Ë™ç
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError) {
                    console.error('„Çª„ÉÉ„Ç∑„Éß„É≥„Ç®„É©„Éº:', sessionError);
                }
                
                if (session) {
                    console.log('‚úÖ „É≠„Ç∞„Ç§„É≥Ê∏à„Åø„É¶„Éº„Ç∂„ÉºÊ§úÂá∫:', session.user.email);
                    currentUser = session.user;
                    await loadUserProfile();
                    await syncProgressFromCloud();
                    updateAuthUI();
                } else {
                    console.log('‚ÑπÔ∏è Êú™„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã');
                    updateAuthUI();
                }
                
                // Ë™çË®ºÁä∂ÊÖã„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    console.log('üîî Ë™çË®ºÁä∂ÊÖãÂ§âÊõ¥:', event, session?.user?.email);
                    
                    if (event === 'SIGNED_IN' && session) {
                        console.log('üì• „É≠„Ç∞„Ç§„É≥„Ç§„Éô„É≥„ÉàÊ§úÂá∫');
                        currentUser = session.user;
                        await loadUserProfile();
                        await syncProgressFromCloud();
                        updateAuthUI();
                    } else if (event === 'SIGNED_OUT') {
                        console.log('üì§ „É≠„Ç∞„Ç¢„Ç¶„Éà„Ç§„Éô„É≥„ÉàÊ§úÂá∫');
                        currentUser = null;
                        userProfile = null;
                        updateAuthUI();
                    } else if (event === 'TOKEN_REFRESHED') {
                        console.log('üîÑ „Éà„Éº„ÇØ„É≥„É™„Éï„É¨„ÉÉ„Ç∑„É•');
                    } else if (event === 'INITIAL_SESSION') {
                        console.log('üèÅ ÂàùÊúü„Çª„ÉÉ„Ç∑„Éß„É≥:', session?.user?.email || '„Å™„Åó');
                        if (session) {
                            currentUser = session.user;
                            await loadUserProfile();
                            await syncProgressFromCloud();
                            updateAuthUI();
                        }
                    }
                });
            } catch (error) {
                console.error('SupabaseÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
        }
        
        // „É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç£„Éº„É´Ë™≠„ÅøËæº„Åø
        async function loadUserProfile() {
            if (!supabaseClient || !currentUser) return;
            
            console.log('üë§ „Éó„É≠„Éï„Ç£„Éº„É´Ë™≠„ÅøËæº„Åø‰∏≠...', currentUser.id);
            console.log('üìß „É°„Çø„Éá„Éº„Çø:', currentUser.user_metadata);
            
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('nickname')
                    .eq('id', currentUser.id)
                    .single();
                
                if (data) {
                    console.log('‚úÖ „Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæóÊàêÂäü:', data);
                    userProfile = data;
                } else {
                    console.log('‚ÑπÔ∏è „Éó„É≠„Éï„Ç£„Éº„É´„Å™„Åó„ÄÅ‰ΩúÊàê‰∏≠...');
                    // „Éó„É≠„Éï„Ç£„Éº„É´„Åå„Å™„ÅÑÂ†¥ÂêàÔºàGoogle„É≠„Ç∞„Ç§„É≥„Å™„Å©Ôºâ„ÄÅ‰ΩúÊàê„ÇíË©¶„Åø„Çã
                    const nickname = currentUser.user_metadata?.nickname || 
                                    currentUser.user_metadata?.full_name || 
                                    currentUser.user_metadata?.name ||
                                    currentUser.email?.split('@')[0] || 
                                    'Player';
                    
                    console.log('üìù „Éã„ÉÉ„ÇØ„Éç„Éº„É†ÂÄôË£ú:', nickname);
                    
                    const { data: newProfile, error: insertError } = await supabaseClient
                        .from('profiles')
                        .upsert({ id: currentUser.id, nickname: nickname })
                        .select()
                        .single();
                    
                    if (newProfile) {
                        console.log('‚úÖ „Éó„É≠„Éï„Ç£„Éº„É´‰ΩúÊàêÊàêÂäü:', newProfile);
                        userProfile = newProfile;
                    } else {
                        console.log('‚ö†Ô∏è „Éó„É≠„Éï„Ç£„Éº„É´‰ΩúÊàêÂ§±Êïó„ÄÅ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ‰ΩøÁî®:', insertError);
                        // ÊåøÂÖ•Â§±Êïó„Åó„Å¶„ÇÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        userProfile = { nickname: nickname };
                    }
                }
            } catch (error) {
                console.error('„Éó„É≠„Éï„Ç£„Éº„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                // „Ç®„É©„ÉºÊôÇ„ÇÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                const nickname = currentUser.user_metadata?.nickname || 
                                currentUser.user_metadata?.full_name || 
                                currentUser.email?.split('@')[0] || 
                                'Player';
                userProfile = { nickname: nickname };
                console.log('‚ö†Ô∏è „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Éó„É≠„Éï„Ç£„Éº„É´‰ΩøÁî®:', userProfile);
            }
        }
        
        // Ë™çË®ºUIÊõ¥Êñ∞
        function updateAuthUI() {
            const loginStatusDot = document.getElementById('loginStatusDot');
            const loginStatusCard = document.getElementById('loginStatusCard');
            const loginStatusText = document.getElementById('loginStatusText');
            const settingsNotLoggedIn = document.getElementById('settingsNotLoggedIn');
            const settingsLoggedIn = document.getElementById('settingsLoggedIn');
            const settingsPasswordChange = document.getElementById('settingsPasswordChange');
            
            console.log('üîÑ UIÊõ¥Êñ∞‰∏≠... currentUser:', !!currentUser, 'userProfile:', userProfile);
            
            if (currentUser && userProfile) {
                console.log('‚úÖ „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÅßUIÊõ¥Êñ∞:', userProfile.nickname);
                
                // Header status dot
                if (loginStatusDot) {
                    loginStatusDot.classList.add('logged-in');
                }
                
                // Settings modal - logged in view
                if (loginStatusCard) {
                    loginStatusCard.classList.add('logged-in');
                    loginStatusCard.classList.remove('not-logged-in');
                }
                if (loginStatusText) {
                    loginStatusText.textContent = `${userProfile.nickname} „Åß„É≠„Ç∞„Ç§„É≥‰∏≠`;
                }
                
                // Show/hide sections
                if (settingsNotLoggedIn) settingsNotLoggedIn.style.display = 'none';
                if (settingsLoggedIn) settingsLoggedIn.style.display = 'block';
                if (settingsPasswordChange) settingsPasswordChange.style.display = 'none';
                
                // Update profile fields
                const nicknameInput = document.getElementById('settingsNickname');
                const emailInput = document.getElementById('settingsEmail');
                if (nicknameInput) nicknameInput.value = userProfile.nickname || '';
                if (emailInput) emailInput.value = currentUser.email || '';
                
                // Update stats
                updateSettingsStats();
                
            } else {
                console.log('‚ÑπÔ∏è Êú™„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÅßUIÊõ¥Êñ∞');
                
                // Header status dot
                if (loginStatusDot) {
                    loginStatusDot.classList.remove('logged-in');
                }
                
                // Settings modal - not logged in view
                if (loginStatusCard) {
                    loginStatusCard.classList.remove('logged-in');
                    loginStatusCard.classList.add('not-logged-in');
                }
                if (loginStatusText) {
                    loginStatusText.textContent = '„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì';
                }
                
                // Show/hide sections
                if (settingsNotLoggedIn) settingsNotLoggedIn.style.display = 'block';
                if (settingsLoggedIn) settingsLoggedIn.style.display = 'none';
                if (settingsPasswordChange) settingsPasswordChange.style.display = 'none';
            }
        }
        
        // Ë®≠ÂÆöÁîªÈù¢„ÅÆÁµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
        function updateSettingsStats() {
            const completedEl = document.getElementById('settingsCompletedLevels');
            const starsEl = document.getElementById('settingsTotalStars');
            const charEl = document.getElementById('settingsCharacter');
            
            if (completedEl) completedEl.textContent = `${completedLevels.size} / 80`;
            if (starsEl) starsEl.textContent = totalStarsEarned;
            if (charEl && selectedCharacter) charEl.textContent = selectedCharacter.name;
        }
        
        // Ë®≠ÂÆöÁîªÈù¢„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showSettingsMessage(type, message) {
            const msgEl = document.getElementById('settingsMessage');
            if (msgEl) {
                msgEl.textContent = message;
                msgEl.className = 'settings-message ' + type;
                setTimeout(() => {
                    msgEl.className = 'settings-message';
                }, 3000);
            }
        }
        
        // „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
        async function handleLogin(email, password) {
            if (!supabaseClient) {
                showAuthError('Supabase„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return false;
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                showAuthSuccess('„É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅ');
                setTimeout(() => {
                    document.getElementById('authModal').classList.remove('show');
                }, 1000);
                
                return true;
            } catch (error) {
                showAuthError(error.message);
                return false;
            }
        }
        
        // ÁôªÈå≤Âá¶ÁêÜ
        async function handleRegister(email, password, nickname) {
            if (!supabaseClient) {
                showAuthError('Supabase„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return false;
            }
            
            try {
                // „É¶„Éº„Ç∂„Éº‰ΩúÊàêÔºà„Éã„ÉÉ„ÇØ„Éç„Éº„É†„Çí„É°„Çø„Éá„Éº„Çø„Å®„Åó„Å¶ÈÄÅ‰ø°Ôºâ
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            nickname: nickname
                        }
                    }
                });
                
                if (authError) throw authError;
                
                // „É°„Éº„É´Á¢∫Ë™ç„ÅåÂøÖË¶Å„Å™Â†¥Âêà
                if (authData.user && !authData.session) {
                    showAuthSuccess('ÁôªÈå≤ÊàêÂäüÔºÅ„É°„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    showAuthSuccess('ÁôªÈå≤ÊàêÂäüÔºÅ');
                    setTimeout(() => {
                        document.getElementById('authModal').classList.remove('show');
                    }, 1000);
                }
                
                return true;
            } catch (error) {
                showAuthError(error.message);
                return false;
            }
        }
        
        // „É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
        async function handleLogout() {
            if (!supabaseClient) return;
            
            try {
                showSyncStatus('syncing', '„É≠„Ç∞„Ç¢„Ç¶„Éà‰∏≠...');
                await supabaseClient.auth.signOut();
                currentUser = null;
                userProfile = null;
                
                // „É≠„Éº„Ç´„É´„ÅÆÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„ÉàÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºö„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà„ÅßÈÄ≤Êçó„Çí‰øùÊåÅÔºâ
                completedLevels = new Set();
                totalStarsEarned = 0;
                levelStars = {};
                updateStats();
                updateLevelButtons();
                
                updateAuthUI();
                showSyncStatus('synced', '„É≠„Ç∞„Ç¢„Ç¶„ÉàÂÆå‰∫Ü');
            } catch (error) {
                console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
                showSyncStatus('error', '„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº');
            }
        }
        
        // Google„É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
        async function handleGoogleLogin() {
            if (!supabaseClient) {
                showAuthError('Supabase„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return false;
            }
            
            try {
                const redirectUrl = window.location.origin + window.location.pathname;
                console.log('üîó Google„É≠„Ç∞„Ç§„É≥ÈñãÂßã, „É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂÖà:', redirectUrl);
                
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: redirectUrl,
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent'
                        }
                    }
                });
                
                if (error) throw error;
                
                console.log('üì§ Google„Å∏„É™„ÉÄ„Ç§„É¨„ÇØ„Éà‰∏≠...');
                return true;
            } catch (error) {
                console.error('Google„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
                showAuthError(error.message);
                return false;
            }
        }
        
        // „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„ÉàÂá¶ÁêÜ
        async function handlePasswordReset(email) {
            if (!supabaseClient) {
                showAuthError('Supabase„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return false;
            }
            
            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + window.location.pathname
                });
                
                if (error) throw error;
                
                showAuthSuccess('„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„ÉàÁî®„ÅÆ„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„É°„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return true;
            } catch (error) {
                showAuthError(error.message);
                return false;
            }
        } 
        
        async function syncProgressFromCloud() {
            if (!supabaseClient || !currentUser) return;
            
            showSyncStatus('syncing', '„Éá„Éº„ÇøÂæ©ÂÖÉ‰∏≠...');
            
            try {
                // „É¶„Éº„Ç∂„ÉºË®≠ÂÆö„ÇíÂèñÂæóÔºà„Ç≠„É£„É©„ÇØ„Çø„Éº„ÄÅ„ÉÜ„Éº„Éû„ÄÅÁ∑èÊòüÊï∞Ôºâ
                const { data: profileData, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('total_stars, selected_character, theme')
                    .eq('id', currentUser.id)
                    .single();
                
                if (profileData) {
                    // „Ç≠„É£„É©„ÇØ„Çø„ÉºÂæ©ÂÖÉ
                    if (profileData.selected_character) {
                        const charIndex = characters.findIndex(c => c.id === profileData.selected_character);
                        if (charIndex !== -1) {
                            selectedCharacter = characters[charIndex];
                            localStorage.setItem('codequest-character', profileData.selected_character);
                            console.log('ü§ñ „Ç≠„É£„É©„ÇØ„Çø„ÉºÂæ©ÂÖÉ:', profileData.selected_character);
                        }
                    }
                    
                    // „ÉÜ„Éº„ÉûÂæ©ÂÖÉ
                    if (profileData.theme) {
                        const isDark = profileData.theme === 'dark';
                        if (isDark) {
                            document.body.classList.remove('light-mode');
                        } else {
                            document.body.classList.add('light-mode');
                        }
                        localStorage.setItem('codequest-theme', profileData.theme);
                        updateThemeButton();
                        console.log('üé® „ÉÜ„Éº„ÉûÂæ©ÂÖÉ:', profileData.theme);
                    }
                }
                
                // ÈÄ≤Êçó„Éá„Éº„Çø„ÇíÂèñÂæóÔºà„É¨„Éô„É´ID„Å®Êòü„ÅÆÊï∞Ôºâ
                const { data: progressData, error: progressError } = await supabaseClient
                    .from('progress')
                    .select('level_id, stars')
                    .eq('user_id', currentUser.id);
                
                if (progressError) throw progressError;
                
                if (progressData && progressData.length > 0) {
                    // „ÇØ„É©„Ç¶„Éâ„ÅÆ„Éá„Éº„Çø„Åß‰∏äÊõ∏„Åç
                    completedLevels = new Set();
                    levelStars = {};
                    totalStarsEarned = 0;
                    
                    progressData.forEach(p => {
                        completedLevels.add(p.level_id);
                        const stars = p.stars || 1;
                        levelStars[p.level_id] = stars;
                        totalStarsEarned += stars;
                    });
                    
                    console.log('üìä ÈÄ≤ÊçóÂæ©ÂÖÉ:', completedLevels.size, '„É¨„Éô„É´,', totalStarsEarned, 'Êòü');
                    updateStats();
                    updateLevelButtons();
                }
                
                showSyncStatus('synced', '„Éá„Éº„ÇøÂæ©ÂÖÉÂÆå‰∫Ü');
            } catch (error) {
                console.error('ÂêåÊúü„Ç®„É©„Éº:', error);
                showSyncStatus('error', 'ÂêåÊúü„Ç®„É©„Éº');
            }
        }
        
        // ÈÄ≤Êçó„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò
        async function saveProgressToCloud(levelId, stars = 1) {
            if (!supabaseClient || !currentUser) return;
            
            showSyncStatus('syncing', '‰øùÂ≠ò‰∏≠...');
            
            try {
                // ÈÄ≤Êçó„Çí‰øùÂ≠ò
                const { error: progressError } = await supabaseClient
                    .from('progress')
                    .upsert({
                        user_id: currentUser.id,
                        level_id: levelId,
                        stars: stars,
                        completed_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,level_id'
                    });
                
                if (progressError) throw progressError;
                
                // Á∑èÊòüÊï∞„ÇíÊõ¥Êñ∞
                await supabaseClient
                    .from('profiles')
                    .update({ total_stars: totalStarsEarned })
                    .eq('id', currentUser.id);
                
                showSyncStatus('synced', '‰øùÂ≠òÂÆå‰∫Ü');
            } catch (error) {
                console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showSyncStatus('error', '‰øùÂ≠ò„Ç®„É©„Éº');
            }
        }
        
        // „É¶„Éº„Ç∂„ÉºË®≠ÂÆö„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò
        async function saveUserSettingsToCloud() {
            if (!supabaseClient || !currentUser) return;
            
            try {
                const theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
                const characterId = selectedCharacter?.id || 'pixel';
                
                await supabaseClient
                    .from('profiles')
                    .update({
                        selected_character: characterId,
                        theme: theme,
                        total_stars: totalStarsEarned
                    })
                    .eq('id', currentUser.id);
                
                console.log('üíæ Ë®≠ÂÆö‰øùÂ≠ò:', { character: characterId, theme: theme });
            } catch (error) {
                console.error('Ë®≠ÂÆö‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }
        
        // „ÉÜ„Éº„Éû„Éú„Çø„É≥Êõ¥Êñ∞
        function updateThemeButton() {
            const isDark = !document.body.classList.contains('light-mode');
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            if (themeIcon) themeIcon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
            if (themeText) themeText.textContent = isDark ? '„ÉÄ„Éº„ÇØ' : '„É©„Ç§„Éà';
        }
        
        // ÂêåÊúü„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
        function showSyncStatus(status, text) {
            const indicator = document.getElementById('syncIndicator');
            const icon = document.getElementById('syncIcon');
            const textEl = document.getElementById('syncText');
            
            indicator.style.display = 'flex';
            indicator.className = 'sync-indicator ' + status;
            textEl.textContent = text;
            
            if (status === 'syncing') {
                icon.textContent = 'üîÑ';
            } else if (status === 'synced') {
                icon.textContent = '‚úÖ';
                setTimeout(() => { indicator.style.display = 'none'; }, 2000);
            } else {
                icon.textContent = '‚ùå';
            }
        }
        
        // „Ç®„É©„ÉºË°®Á§∫
        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            document.getElementById('authSuccess').classList.remove('show');
        }
        
        // ÊàêÂäüË°®Á§∫
        function showAuthSuccess(message) {
            const successEl = document.getElementById('authSuccess');
            successEl.textContent = message;
            successEl.classList.add('show');
            document.getElementById('authError').classList.remove('show');
        }
        
        // ===== CHARACTERS =====
        const characters = [
            {
                id: 'pixel',
                name: 'Pixel',
                desc: '„ÇØ„É©„Ç∑„ÉÉ„ÇØ„É≠„Éú„ÉÉ„Éà',
                colors: {
                    body: '#00f5ff',
                    bodyGlow: '#00d4dd',
                    eye: '#00ff88',
                    antenna: '#ff2d75',
                    chest: ['#ff2d75', '#00ff88', '#ffcc00']
                }
            },
            {
                id: 'blaze',
                name: 'Blaze',
                desc: 'ÁÇé„ÅÆ„É≠„Éú„ÉÉ„Éà',
                colors: {
                    body: '#ff6b35',
                    bodyGlow: '#ff4500',
                    eye: '#ffcc00',
                    antenna: '#ff0000',
                    chest: ['#ff0000', '#ff6b35', '#ffcc00']
                }
            },
            {
                id: 'nova',
                name: 'Nova',
                desc: 'ÂÆáÂÆô„É≠„Éú„ÉÉ„Éà',
                colors: {
                    body: '#b14eff',
                    bodyGlow: '#9333ea',
                    eye: '#00ffff',
                    antenna: '#ff00ff',
                    chest: ['#ff00ff', '#00ffff', '#b14eff']
                }
            },
            {
                id: 'leaf',
                name: 'Leaf',
                desc: 'Ëá™ÁÑ∂„É≠„Éú„ÉÉ„Éà',
                colors: {
                    body: '#22c55e',
                    bodyGlow: '#16a34a',
                    eye: '#a3e635',
                    antenna: '#84cc16',
                    chest: ['#22c55e', '#84cc16', '#a3e635']
                }
            },
            {
                id: 'frost',
                name: 'Frost',
                desc: 'Ê∞∑„ÅÆ„É≠„Éú„ÉÉ„Éà',
                colors: {
                    body: '#38bdf8',
                    bodyGlow: '#0ea5e9',
                    eye: '#ffffff',
                    antenna: '#e0f2fe',
                    chest: ['#bae6fd', '#7dd3fc', '#38bdf8']
                }
            },
            {
                id: 'shadow',
                name: 'Shadow',
                desc: 'ÂΩ±„ÅÆ„É≠„Éú„ÉÉ„Éà',
                colors: {
                    body: '#6b7280',
                    bodyGlow: '#4b5563',
                    eye: '#ef4444',
                    antenna: '#991b1b',
                    chest: ['#ef4444', '#6b7280', '#374151']
                }
            }
        ];
        
        let selectedCharacter = characters[0];
        let isDarkMode = true;
        
        // ===== THEME TOGGLE =====
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('light-mode', !isDarkMode);
            document.getElementById('themeIcon').textContent = isDarkMode ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('themeText').textContent = isDarkMode ? '„ÉÄ„Éº„ÇØ' : '„É©„Ç§„Éà';
            localStorage.setItem('codequest-theme', isDarkMode ? 'dark' : 'light');
            drawCanvas();
            
            // „ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò
            saveUserSettingsToCloud();
        }
        
        // ===== CHARACTER SELECTOR =====
        function initCharacterSelector() {
            const grid = document.getElementById('characterGrid');
            grid.innerHTML = '';
            
            characters.forEach((char, index) => {
                const card = document.createElement('div');
                card.className = 'character-card' + (char.id === selectedCharacter.id ? ' selected' : '');
                card.innerHTML = `
                    <div class="character-preview">
                        <canvas id="charPreview${index}" width="60" height="60"></canvas>
                    </div>
                    <div class="character-name">${char.name}</div>
                    <div class="character-desc">${char.desc}</div>
                `;
                card.addEventListener('click', () => selectCharacter(char, card));
                grid.appendChild(card);
                
                // Draw preview
                setTimeout(() => drawCharacterPreview(index, char), 10);
            });
        }
        
        function drawCharacterPreview(index, char) {
            const canvas = document.getElementById('charPreview' + index);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 60, 60);
            drawRobotWithColors(ctx, 30, 35, char.colors, 0.8);
        }
        
        function selectCharacter(char, card) {
            selectedCharacter = char;
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            localStorage.setItem('codequest-character', char.id);
            drawCanvas();
            
            // „ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò
            saveUserSettingsToCloud();
        }
        
        function loadSavedPreferences() {
            // Load theme
            const savedTheme = localStorage.getItem('codequest-theme');
            if (savedTheme === 'light') {
                isDarkMode = false;
                document.body.classList.add('light-mode');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
                document.getElementById('themeText').textContent = '„É©„Ç§„Éà';
            }
            
            // Load character
            const savedChar = localStorage.getItem('codequest-character');
            if (savedChar) {
                const found = characters.find(c => c.id === savedChar);
                if (found) selectedCharacter = found;
            }
        }
        
        // ===== LEVEL DATA =====
        const levels = [
            // ===== WORLD 1: BASICS (1-20) =====
            {
                id: 1, world: 1,
                title: "üöÄ ÊúÄÂàù„ÅÆ‰∏ÄÊ≠©",
                description: "„É≠„Éú„ÉÉ„Éà„ÇíÂè≥„Å´ <strong>2„Éû„Çπ</strong> Âãï„Åã„Åù„ÅÜ!<br><code>robot.move()</code> „Åß1„Éû„ÇπÁßªÂãï„ÄÇ",
                initialCode: "// robot.move() „Çí‰Ωø„Åä„ÅÜ!\n\n",
                hint: "move() „Çí2ÂõûÊõ∏„Åì„ÅÜ",
                goalX: 2, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 2 && r.y === 0
            },
            {
                id: 2, world: 1,
                title: "üèÉ 3„Éû„ÇπÈÄ≤„ÇÅ",
                description: "Âè≥„Å´ <strong>3„Éû„Çπ</strong> ÁßªÂãï„Åó„Çà„ÅÜ!",
                initialCode: "// 3„Éû„ÇπÈÄ≤„ÇÇ„ÅÜ!\n\n",
                hint: "move() „Çí3Âõû",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === 0
            },
            {
                id: 3, world: 1,
                title: "üéØ 4„Éû„ÇπÈÄ≤„ÇÅ",
                description: "Âè≥„Å´ <strong>4„Éû„Çπ</strong> ÁßªÂãï„Åó„Çà„ÅÜ!",
                initialCode: "// 4„Éû„ÇπÈÄ≤„ÇÇ„ÅÜ!\n\n",
                hint: "move() „Çí4Âõû",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 4 && r.y === 0
            },
            {
                id: 4, world: 1,
                title: "‚¨ÜÔ∏è ‰∏ä„Å´ÁßªÂãï",
                description: "<code>robot.moveUp()</code> „Åß‰∏ä„Å´ÁßªÂãï!<br>Âè≥„Å´1„Éû„Çπ„ÄÅ‰∏ä„Å´1„Éû„Çπ„ÄÇ",
                initialCode: "// moveUp() „Çí‰Ωø„Åä„ÅÜ!\n\n",
                hint: "move() „ÅßÂè≥„ÄÅmoveUp() „Åß‰∏ä",
                goalX: 1, goalY: -1,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 1 && r.y === -1
            },
            {
                id: 5, world: 1,
                title: "‚¨áÔ∏è ‰∏ã„Å´ÁßªÂãï",
                description: "<code>robot.moveDown()</code> „Åß‰∏ã„Å´ÁßªÂãï!<br>Âè≥„Å´1„Éû„Çπ„ÄÅ‰∏ã„Å´1„Éû„Çπ„ÄÇ",
                initialCode: "// moveDown() „Çí‰Ωø„Åä„ÅÜ!\n\n",
                hint: "move() „ÅßÂè≥„ÄÅmoveDown() „Åß‰∏ã",
                goalX: 1, goalY: 1,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 1 && r.y === 1
            },
            {
                id: 6, world: 1,
                title: "‚ÜóÔ∏è Êñú„ÇÅÁßªÂãï",
                description: "Âè≥„Å´2„Éû„Çπ„ÄÅ‰∏ä„Å´1„Éû„ÇπÈÄ≤„ÇÇ„ÅÜ!",
                initialCode: "// Âè≥„Å®‰∏ä„ÇíÁµÑ„ÅøÂêà„Çè„Åõ!\n\n",
                hint: "move()„Çí2Âõû„ÄÅmoveUp()„Çí1Âõû",
                goalX: 2, goalY: -1,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 2 && r.y === -1
            },
            {
                id: 7, world: 1,
                title: "‚ÜòÔ∏è ÂèçÂØæ„ÅÆÊñú„ÇÅ",
                description: "Âè≥„Å´2„Éû„Çπ„ÄÅ‰∏ã„Å´1„Éû„ÇπÈÄ≤„ÇÇ„ÅÜ!",
                initialCode: "// Âè≥„Å®‰∏ã„ÇíÁµÑ„ÅøÂêà„Çè„Åõ!\n\n",
                hint: "move()„Çí2Âõû„ÄÅmoveDown()„Çí1Âõû",
                goalX: 2, goalY: 1,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 2 && r.y === 1
            },
            {
                id: 8, world: 1,
                title: "üîº ‰∏ä„Å´2„Éû„Çπ",
                description: "Âè≥„Å´1„Éû„Çπ„ÄÅ‰∏ä„Å´2„Éû„ÇπÈÄ≤„ÇÇ„ÅÜ!",
                initialCode: "// ‰∏ä„Å´2ÂõûÁßªÂãï!\n\n",
                hint: "moveUp()„Çí2Âõû‰Ωø„Åä„ÅÜ",
                goalX: 1, goalY: -2,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 1 && r.y === -2
            },
            {
                id: 9, world: 1,
                title: "‚≠ê Êòü„ÇíÈõÜ„ÇÅ„Çà„ÅÜ",
                description: "<code>robot.collect()</code> „ÅßÊòü„ÇíÂèéÈõÜ!<br>‰ΩçÁΩÆ1„ÅÆÊòü„ÇíÈõÜ„ÇÅ„Å¶„Ç¥„Éº„É´„Å∏„ÄÇ",
                initialCode: "// collect() „ÅßÊòü„ÇíÈõÜ„ÇÅ„Çà„ÅÜ!\n\n",
                hint: "Êòü„ÅÆ‰ΩçÁΩÆ„Åß collect() „ÇíÂëº„Åº„ÅÜ",
                goalX: 2, goalY: 0,
                obstacles: [], stars: [1], gems: [],
                validate: (r) => r.x === 2 && r.starsCollected >= 1
            },
            {
                id: 10, world: 1,
                title: "‚≠ê‚≠ê 2„Å§„ÅÆÊòü",
                description: "2„Å§„ÅÆÊòü„ÇíÈõÜ„ÇÅ„Çà„ÅÜ!<br>Êòü„ÅØ‰ΩçÁΩÆ1„Å®2„Å´„ÅÇ„Çä„Åæ„Åô„ÄÇ",
                initialCode: "// 2„Å§ÈõÜ„ÇÅ„Çà„ÅÜ!\n\n",
                hint: "ÁßªÂãï„Åó„Å¶ collect() „ÇíÁπ∞„ÇäËøî„Åô",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [1, 2], gems: [],
                validate: (r) => r.x === 3 && r.starsCollected >= 2
            },
            {
                id: 11, world: 1,
                title: "üß± ÈöúÂÆ≥Áâ©„Å†!",
                description: "<code>robot.jump()</code> „ÅßÈöúÂÆ≥Áâ©„ÇíÈ£õ„Å≥Ë∂ä„Åà„Çà„ÅÜ!",
                initialCode: "// jump() „Åß„Ç∏„É£„É≥„Éó!\n\n",
                hint: "ÈöúÂÆ≥Áâ©„ÅÆÊâãÂâç„Åß jump()",
                goalX: 2, goalY: 0,
                obstacles: [{x: 1, y: 0}], stars: [], gems: [],
                validate: (r) => r.x === 2 && !r.hitObstacle
            },
            {
                id: 12, world: 1,
                title: "üß±‚û°Ô∏è „Ç∏„É£„É≥„Éó„Å®ÁßªÂãï",
                description: "„Ç∏„É£„É≥„Éó„Åó„Å¶„ÄÅ„Åï„Çâ„Å´1„Éû„ÇπÈÄ≤„ÇÇ„ÅÜ!",
                initialCode: "// „Ç∏„É£„É≥„ÉóÂæå„ÇÇÁßªÂãï!\n\n",
                hint: "jump() „ÅÆÂæå„Å´ move()",
                goalX: 3, goalY: 0,
                obstacles: [{x: 1, y: 0}], stars: [], gems: [],
                validate: (r) => r.x === 3 && !r.hitObstacle
            },
            {
                id: 13, world: 1,
                title: "üíé „Ç∏„Çß„É†„ÇíÈõÜ„ÇÅ„Çç",
                description: "<code>robot.collectGem()</code> „Åß„Ç∏„Çß„É†ÂèéÈõÜ!",
                initialCode: "// collectGem() „Çí‰Ωø„Åä„ÅÜ!\n\n",
                hint: "„Ç∏„Çß„É†„ÅÆ‰ΩçÁΩÆ„Åß collectGem()",
                goalX: 2, goalY: 0,
                obstacles: [], stars: [], gems: [1],
                validate: (r) => r.x === 2 && r.gemsCollected >= 1
            },
            {
                id: 14, world: 1,
                title: "‚≠êüíé Êòü„Å®„Ç∏„Çß„É†",
                description: "Êòü„Å®„Ç∏„Çß„É†„Çí‰∏°ÊñπÈõÜ„ÇÅ„Çà„ÅÜ!",
                initialCode: "// ‰∏°ÊñπÈõÜ„ÇÅ„Çà„ÅÜ!\n\n",
                hint: "collect() „Å® collectGem() „Çí‰Ωø„ÅÑÂàÜ„Åë",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [1], gems: [2],
                validate: (r) => r.x === 3 && r.starsCollected >= 1 && r.gemsCollected >= 1
            },
            {
                id: 15, world: 1,
                title: "üèîÔ∏è ‰∏ä‰∏ã„ÅÆÂÜíÈô∫",
                description: "‰∏ä„Å´Ë°å„Å£„Å¶Êòü„ÇíÂèñ„Çä„ÄÅ‰∏ã„Å´Êàª„Çç„ÅÜ!",
                initialCode: "// ‰∏ä‰∏ãÁßªÂãï„ÅßÊòü„ÇíÂèñ„Çç„ÅÜ!\n\n",
                hint: "moveUp() ‚Üí collect() ‚Üí moveDown()",
                goalX: 1, goalY: 0,
                obstacles: [], stars: [1], gems: [],
                validate: (r) => r.x === 1 && r.y === 0 && r.starsCollected >= 1
            },
            {
                id: 16, world: 1,
                title: "üéØ Á≤æÂØÜÊìç‰Ωú",
                description: "ÈöúÂÆ≥Áâ©„ÇíÈÅø„Åë„Å¶Êòü„ÇíÈõÜ„ÇÅ„Çà„ÅÜ!",
                initialCode: "// „Ç∏„É£„É≥„Éó„Åó„Å¶Êòü„ÇíÂèñ„Çç„ÅÜ!\n\n",
                hint: "jump() „ÅßÈ£õ„Å≥Ë∂ä„Åà„ÅüÂæå„Å´ collect()",
                goalX: 3, goalY: 0,
                obstacles: [{x: 1, y: 0}], stars: [2], gems: [],
                validate: (r) => r.x === 3 && r.starsCollected >= 1 && !r.hitObstacle
            },
            {
                id: 17, world: 1,
                title: "üåü 3„Å§„ÅÆÊòü",
                description: "3„Å§„ÅÆÊòü„ÇíÂÖ®ÈÉ®ÈõÜ„ÇÅ„Çà„ÅÜ!",
                initialCode: "// 3„Å§ÂÖ®ÈÉ®!\n\n",
                hint: "‰ΩçÁΩÆ1,2,3„Åß collect()",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [],
                validate: (r) => r.x === 4 && r.starsCollected >= 3
            },
            {
                id: 18, world: 1,
                title: "üß±üß± 2„Å§„ÅÆÈöúÂÆ≥Áâ©",
                description: "2„Å§„ÅÆÈöúÂÆ≥Áâ©„ÇíÈ£õ„Å≥Ë∂ä„Åà„Çà„ÅÜ!",
                initialCode: "// 2Âõû„Ç∏„É£„É≥„Éó!\n\n",
                hint: "jump() „Çí2Âõû‰Ωø„Åä„ÅÜ",
                goalX: 4, goalY: 0,
                obstacles: [{x: 1, y: 0}, {x: 3, y: 0}], stars: [], gems: [],
                validate: (r) => r.x === 4 && !r.hitObstacle
            },
            {
                id: 19, world: 1,
                title: "üíéüíé 2„Å§„ÅÆ„Ç∏„Çß„É†",
                description: "2„Å§„ÅÆ„Ç∏„Çß„É†„ÇíÈõÜ„ÇÅ„Çà„ÅÜ!",
                initialCode: "// „Ç∏„Çß„É†2„Å§!\n\n",
                hint: "collectGem() „Çí2Âõû",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [], gems: [1, 2],
                validate: (r) => r.x === 3 && r.gemsCollected >= 2
            },
            {
                id: 20, world: 1,
                title: "üèÜ Âü∫Á§é„Éû„Çπ„Çø„Éº",
                description: "ÂÖ®„Çπ„Ç≠„É´„Çí‰Ωø„Å£„Å¶„Ç¥„Éº„É´„Å∏!<br>ÈöúÂÆ≥Áâ©„ÄÅÊòü„ÄÅ„Ç∏„Çß„É†„Å´ÂØæÂøú!",
                initialCode: "// Âü∫Á§é„ÅÆÈõÜÂ§ßÊàê!\n\n",
                hint: "jump, collect, collectGem „ÇíÁµÑ„ÅøÂêà„Çè„Åõ",
                goalX: 5, goalY: 0,
                obstacles: [{x: 2, y: 0}], stars: [1, 4], gems: [3],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && r.gemsCollected >= 1 && !r.hitObstacle
            },
            
            // ===== WORLD 2: LOOPS (21-40) =====
            {
                id: 21, world: 2,
                title: "üîÑ for„É´„Éº„ÉóÂÖ•ÈñÄ",
                description: "<code>for</code>„É´„Éº„Éó„Åß3„Éû„ÇπÁßªÂãï!",
                initialCode: "// for (let i = 0; i < ÂõûÊï∞; i++) { }\n\n",
                hint: "for „ÅÆ‰∏≠„Å´ move() „ÇíÂÖ•„Çå„Çà„ÅÜ",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === 0
            },
            {
                id: 22, world: 2,
                title: "üîÑ 5„Éû„Çπ„É´„Éº„Éó",
                description: "for„É´„Éº„Éó„Åß5„Éû„ÇπÁßªÂãï„Åó„Çà„ÅÜ!",
                initialCode: "// 5Âõû„É´„Éº„Éó!\n\n",
                hint: "i < 5 „Åß„É´„Éº„Éó",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 5 && r.y === 0
            },
            {
                id: 23, world: 2,
                title: "üîÅ while„É´„Éº„Éó",
                description: "<code>while (robot.x < 4)</code> „ÅßÁßªÂãï!",
                initialCode: "// while (Êù°‰ª∂) { }\n\n",
                hint: "robot.x < 4 „ÅÆÈñì„É´„Éº„Éó",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 4 && r.y === 0
            },
            {
                id: 24, world: 2,
                title: "‚≠ê „É´„Éº„Éó„ÅßÊòü",
                description: "„É´„Éº„Éó„ÅßÁßªÂãï„Åó„Å¶Êòü„ÇíÈõÜ„ÇÅ„Çà„ÅÜ!",
                initialCode: "// „É´„Éº„Éó„ÅßÊòüÈõÜ„ÇÅ!\n\n",
                hint: "„É´„Éº„ÉóÂÜÖ„Åß move() „Å® collect()",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [],
                validate: (r) => r.x === 4 && r.starsCollected >= 3
            },
            {
                id: 25, world: 2,
                title: "üî¢ Â§âÊï∞„Çí‰Ωø„Åä„ÅÜ",
                description: "<code>let steps = 3;</code> „Åß„É´„Éº„ÉóÂõûÊï∞„ÇíÊåáÂÆö!",
                initialCode: "let steps = 3;\n// steps „Çí‰Ωø„Å£„Å¶„É´„Éº„Éó!\n\n",
                hint: "for „ÅÆÊù°‰ª∂„Å´ steps „Çí‰Ωø„ÅÜ",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === 0
            },
            {
                id: 26, world: 2,
                title: "üß± „É´„Éº„Éó„Åß„Ç∏„É£„É≥„Éó",
                description: "ÈÄ£Á∂ö„Åó„ÅüÈöúÂÆ≥Áâ©„Çí„É´„Éº„Éó„Åß„Ç∏„É£„É≥„Éó!",
                initialCode: "// „É´„Éº„Éó„Åß„Ç∏„É£„É≥„Éó!\n\n",
                hint: "for „Åß jump() „ÇíÁπ∞„ÇäËøî„Åô",
                goalX: 3, goalY: 0,
                obstacles: [{x: 1, y: 0}, {x: 2, y: 0}], stars: [], gems: [],
                validate: (r) => r.x === 3 && !r.hitObstacle
            },
            {
                id: 27, world: 2,
                title: "üíé „É´„Éº„Éó„Åß„Ç∏„Çß„É†",
                description: "„É´„Éº„Éó„Åß„Ç∏„Çß„É†„ÇíÂÖ®ÈÉ®ÈõÜ„ÇÅ„Çà„ÅÜ!",
                initialCode: "// „Ç∏„Çß„É†„Çí„É´„Éº„Éó„Åß!\n\n",
                hint: "move() „Å® collectGem() „Çí„É´„Éº„Éó",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [1, 2, 3],
                validate: (r) => r.x === 4 && r.gemsCollected >= 3
            },
            {
                id: 28, world: 2,
                title: "‚¨ÜÔ∏è „É´„Éº„Éó„Åß‰∏äÊòá",
                description: "„É´„Éº„Éó„Åß‰∏ä„Å´3„Éû„ÇπÁßªÂãï!",
                initialCode: "// „É´„Éº„Éó„Åß‰∏ä„Å∏!\n\n",
                hint: "moveUp() „Çí„É´„Éº„Éó",
                goalX: 1, goalY: -3,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 1 && r.y === -3
            },
            {
                id: 29, world: 2,
                title: "üîÄ 2„Å§„ÅÆ„É´„Éº„Éó",
                description: "Âè≥„Å´3„Éû„Çπ„ÄÅ‰∏ä„Å´2„Éû„Çπ!<br>2„Å§„ÅÆ„É´„Éº„Éó„Çí‰Ωø„Åä„ÅÜ„ÄÇ",
                initialCode: "// 2„Å§„ÅÆ„É´„Éº„Éó!\n\n",
                hint: "ÊúÄÂàù„ÅÆfor„ÅßÂè≥„ÄÅÊ¨°„ÅÆfor„Åß‰∏ä",
                goalX: 3, goalY: -2,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === -2
            },
            {
                id: 30, world: 2,
                title: "‚≠êüíé ‰∏°ÊñπÈõÜ„ÇÅ",
                description: "„É´„Éº„Éó„ÅßÊòü„Å®„Ç∏„Çß„É†„Çí‰∏°Êñπ!",
                initialCode: "// ‰∏°ÊñπÈõÜ„ÇÅ„Çà„ÅÜ!\n\n",
                hint: "collect() „Å® collectGem() „Çí‰∏°Êñπ„É´„Éº„ÉóÂÜÖ„Åß",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [1, 2, 3],
                validate: (r) => r.x === 4 && r.starsCollected >= 3 && r.gemsCollected >= 3
            },
            {
                id: 31, world: 2,
                title: "üîÑ 6„Éû„Çπ„É´„Éº„Éó",
                description: "for„É´„Éº„Éó„Åß6„Éû„ÇπÁßªÂãï!",
                initialCode: "// 6Âõû„É´„Éº„Éó!\n\n",
                hint: "i < 6 „Åß„É´„Éº„Éó",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 6 && r.y === 0
            },
            {
                id: 32, world: 2,
                title: "üåÄ while„ÅßÊòüÈõÜ„ÇÅ",
                description: "while„É´„Éº„Éó„ÅßÊòü„ÇíÈõÜ„ÇÅ„Å™„Åå„ÇâÈÄ≤„ÇÇ„ÅÜ!",
                initialCode: "// while„ÅßÊòüÈõÜ„ÇÅ!\n\n",
                hint: "while (robot.x < 5) „ÅßÊòü„ÇíÈõÜ„ÇÅ„Å™„Åå„Çâ",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 2, 3, 4], gems: [],
                validate: (r) => r.x === 5 && r.starsCollected >= 4
            },
            {
                id: 33, world: 2,
                title: "üß±üß±üß± 3„Å§„ÅÆÈöúÂÆ≥Áâ©",
                description: "3„Å§„ÅÆÈÄ£Á∂öÈöúÂÆ≥Áâ©„Çí„É´„Éº„Éó„Åß„Ç∏„É£„É≥„Éó!",
                initialCode: "// 3Âõû„Ç∏„É£„É≥„Éó!\n\n",
                hint: "for „Åß3Âõû jump()",
                goalX: 4, goalY: 0,
                obstacles: [{x: 1, y: 0}, {x: 2, y: 0}, {x: 3, y: 0}], stars: [], gems: [],
                validate: (r) => r.x === 4 && !r.hitObstacle
            },
            {
                id: 34, world: 2,
                title: "‚¨áÔ∏è „É´„Éº„Éó„Åß‰∏ãÈôç",
                description: "Âè≥„Å´2„Éû„Çπ„ÄÅ‰∏ã„Å´3„Éû„Çπ!",
                initialCode: "// Âè≥„Å®‰∏ã„ÅÆ„É´„Éº„Éó!\n\n",
                hint: "2„Å§„ÅÆforÊñá„Çí‰Ωø„Åä„ÅÜ",
                goalX: 2, goalY: 3,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 2 && r.y === 3
            },
            {
                id: 35, world: 2,
                title: "üî¢ Â§âÊï∞„ÅßÊòü",
                description: "Â§âÊï∞ count „Åß‰ΩïÂÄãÈõÜ„ÇÅ„Åü„ÅãÊï∞„Åà„Çà„ÅÜ!",
                initialCode: "let count = 0;\n// „É´„Éº„Éó„ÅßÊï∞„Åà„Å™„Åå„ÇâÈõÜ„ÇÅ„Çà„ÅÜ!\n\n",
                hint: "collect() „ÅÆÂæå„Å´ count++ „ÅßÊï∞„Åà„Çã",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [],
                validate: (r) => r.x === 4 && r.starsCollected >= 3
            },
            {
                id: 36, world: 2,
                title: "üîÅ whileÊù°‰ª∂",
                description: "Êòü„Åå3ÂÄã„Å´„Å™„Çã„Åæ„ÅßÈÄ≤„ÇÇ„ÅÜ!",
                initialCode: "// while (robot.starsCollected < 3)\n\n",
                hint: "starsCollected „Çí„ÉÅ„Çß„ÉÉ„ÇØ",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 3, 5], gems: [],
                validate: (r) => r.starsCollected >= 3
            },
            {
                id: 37, world: 2,
                title: "üíéüíéüíéüíé 4„Å§„ÅÆ„Ç∏„Çß„É†",
                description: "4„Å§„ÅÆ„Ç∏„Çß„É†„Çí„É´„Éº„Éó„Åß!",
                initialCode: "// 4„Å§ÈõÜ„ÇÅ„Çà„ÅÜ!\n\n",
                hint: "4Âõû„É´„Éº„Éó„Åß collectGem()",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [1, 2, 3, 4],
                validate: (r) => r.x === 5 && r.gemsCollected >= 4
            },
            {
                id: 38, world: 2,
                title: "üìê ÂõõËßíÂΩ¢„Éë„Çπ",
                description: "Âè≥„Å´2„Éû„Çπ„ÄÅ‰∏ä„Å´2„Éû„ÇπÈÄ≤„ÇÇ„ÅÜ!",
                initialCode: "// ÂõõËßíÂΩ¢„ÅÆËßí„Å∏!\n\n",
                hint: "2„Å§„ÅÆforÊñá„ÅßÂè≥„Å®‰∏ä",
                goalX: 2, goalY: -2,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 2 && r.y === -2
            },
            {
                id: 39, world: 2,
                title: "‚≠ê 5„Å§„ÅÆÊòü",
                description: "5„Å§„ÅÆÊòü„ÇíÂÖ®ÈÉ®ÈõÜ„ÇÅ„Çà„ÅÜ!",
                initialCode: "// 5„Å§ÂÖ®ÈÉ®!\n\n",
                hint: "5Âõû„É´„Éº„Éó„Åß move() „Å® collect()",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [1, 2, 3, 4, 5], gems: [],
                validate: (r) => r.x === 6 && r.starsCollected >= 5
            },
            {
                id: 40, world: 2,
                title: "üèÜ „É´„Éº„Éó„Éû„Çπ„Çø„Éº",
                description: "„É´„Éº„Éó„ÇíÈßÜ‰Ωø„Åó„Å¶ÂÖ®ÈÉ®ÈõÜ„ÇÅ„Çà„ÅÜ!",
                initialCode: "// „É´„Éº„Éó„ÅÆÈõÜÂ§ßÊàê!\n\n",
                hint: "forÊñá„ÅßÈöúÂÆ≥Áâ©„ÇíÈÅø„Åë„Å™„Åå„ÇâÊòü„Å®„Ç∏„Çß„É†„Çí",
                goalX: 7, goalY: 0,
                obstacles: [{x: 3, y: 0}], stars: [1, 2, 5, 6], gems: [4],
                validate: (r) => r.x === 7 && r.starsCollected >= 4 && r.gemsCollected >= 1 && !r.hitObstacle
            },
            
            // ===== WORLD 3: CONDITIONS (41-60) =====
            {
                id: 41, world: 3,
                title: "‚ùì ifÊñáÂÖ•ÈñÄ",
                description: "<code>if (robot.isObstacle())</code> „ÅßÈöúÂÆ≥Áâ©„ÉÅ„Çß„ÉÉ„ÇØ!",
                initialCode: "// if „ÅßÈöúÂÆ≥Áâ©„Çí„ÉÅ„Çß„ÉÉ„ÇØ!\nfor (let i = 0; i < 3; i++) {\n  // „Åì„Åì„Å´ifÊñá\n}\n",
                hint: "isObstacle() „Åå true „Å™„Çâ jump()",
                goalX: 3, goalY: 0,
                obstacles: [{x: 1, y: 0}], stars: [], gems: [],
                validate: (r) => r.x === 3 && !r.hitObstacle
            },
            {
                id: 42, world: 3,
                title: "üîÄ if-else",
                description: "ÈöúÂÆ≥Áâ©„Åå„ÅÇ„Çå„Å∞ jump„ÄÅ„Å™„Åë„Çå„Å∞ move!",
                initialCode: "// if-else „Çí‰Ωø„Åä„ÅÜ!\nfor (let i = 0; i < 4; i++) {\n  \n}\n",
                hint: "if (ÈöúÂÆ≥Áâ©) { jump } else { move }",
                goalX: 4, goalY: 0,
                obstacles: [{x: 2, y: 0}], stars: [], gems: [],
                validate: (r) => r.x === 4 && !r.hitObstacle
            },
            {
                id: 43, world: 3,
                title: "‚≠ê Êòü„ÉÅ„Çß„ÉÉ„ÇØ",
                description: "<code>robot.isStar()</code> „ÅßÊòü„Çí„ÉÅ„Çß„ÉÉ„ÇØ!",
                initialCode: "// Êòü„Åå„ÅÇ„Çã„Å®„Åç„Å†„Åë collect!\n\n",
                hint: "if (robot.isStar()) { collect() }",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [2, 4], gems: [],
                validate: (r) => r.x === 4 && r.starsCollected >= 2
            },
            {
                id: 44, world: 3,
                title: "üíé „Ç∏„Çß„É†„ÉÅ„Çß„ÉÉ„ÇØ",
                description: "<code>robot.isGem()</code> „Åß„Ç∏„Çß„É†„Çí„ÉÅ„Çß„ÉÉ„ÇØ!",
                initialCode: "// „Ç∏„Çß„É†„Åå„ÅÇ„Çã„Å®„Åç„Å†„Åë collectGem!\n\n",
                hint: "if (robot.isGem()) { collectGem() }",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [1, 3],
                validate: (r) => r.x === 4 && r.gemsCollected >= 2
            },
            {
                id: 45, world: 3,
                title: "üîÄ else if",
                description: "Ë§áÊï∞„ÅÆÊù°‰ª∂„Çí else if „ÅßÂá¶ÁêÜ!",
                initialCode: "// if, else if, else „Çí‰Ωø„Åä„ÅÜ!\n\n",
                hint: "ÈöúÂÆ≥Áâ©‚ÜíÊòü‚ÜíÁßªÂãï „ÅÆÈ†Ü„Åß„ÉÅ„Çß„ÉÉ„ÇØ",
                goalX: 5, goalY: 0,
                obstacles: [{x: 2, y: 0}], stars: [1, 4], gems: [],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && !r.hitObstacle
            },
            {
                id: 46, world: 3,
                title: "üéØ „Ç¥„Éº„É´„ÉÅ„Çß„ÉÉ„ÇØ",
                description: "<code>robot.isGoal()</code> „Åß„Ç¥„Éº„É´„ÇíÊ§úÁü•!",
                initialCode: "// „Ç¥„Éº„É´„Åæ„ÅßÈÄ≤„ÇÇ„ÅÜ!\n\n",
                hint: "while (!robot.isGoal()) „Åß„É´„Éº„Éó",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 5
            },
            {
                id: 47, world: 3,
                title: "üß† ANDÊºîÁÆóÂ≠ê",
                description: "<code>&&</code> „ÅßË§áÊï∞Êù°‰ª∂„Çí„ÉÅ„Çß„ÉÉ„ÇØ!",
                initialCode: "// && „ÅØ„Äå„Åã„Å§„Äç\n\n",
                hint: "Êù°‰ª∂A && Êù°‰ª∂B „Åß‰∏°Êñπ„ÉÅ„Çß„ÉÉ„ÇØ",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 2, 3, 4], gems: [],
                validate: (r) => r.x === 5 && r.starsCollected >= 4
            },
            {
                id: 48, world: 3,
                title: "üß† ORÊºîÁÆóÂ≠ê",
                description: "<code>||</code> „Åß„Å©„Å°„Çâ„Åã„ÅÆÊù°‰ª∂!",
                initialCode: "// || „ÅØ„Äå„Åæ„Åü„ÅØ„Äç\n\n",
                hint: "Êòü„Åæ„Åü„ÅØ„Ç∏„Çß„É†„Åå„ÅÇ„Çå„Å∞ÂèéÈõÜ",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 3], gems: [2, 4],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && r.gemsCollected >= 2
            },
            {
                id: 49, world: 3,
                title: "üö´ NOTÊºîÁÆóÂ≠ê",
                description: "<code>!</code> „ÅßÊù°‰ª∂„ÇíÂèçËª¢!",
                initialCode: "// ! „ÅØ„Äå„Åß„Å™„ÅÑ„Äç\n\n",
                hint: "!robot.isObstacle() = ÈöúÂÆ≥Áâ©„Åå„Å™„ÅÑ",
                goalX: 4, goalY: 0,
                obstacles: [{x: 2, y: 0}], stars: [], gems: [],
                validate: (r) => r.x === 4 && !r.hitObstacle
            },
            {
                id: 50, world: 3,
                title: "üîÑ Êù°‰ª∂‰ªò„Åç„É´„Éº„Éó",
                description: "Êù°‰ª∂„ÇíÊ∫Ä„Åü„ÅôÈñì„É´„Éº„Éó„Åó„Çà„ÅÜ!",
                initialCode: "// while „Å® if „ÅÆÁµÑ„ÅøÂêà„Çè„Åõ!\n\n",
                hint: "while „Åß„É´„Éº„Éó„ÄÅ‰∏≠„Åß if „ÅßÂàÜÂ≤ê",
                goalX: 6, goalY: 0,
                obstacles: [{x: 2, y: 0}, {x: 4, y: 0}], stars: [], gems: [],
                validate: (r) => r.x === 6 && !r.hitObstacle
            },
            {
                id: 51, world: 3,
                title: "‚≠êüíé ‰∏°Êñπ„ÉÅ„Çß„ÉÉ„ÇØ",
                description: "Êòü„Å®„Ç∏„Çß„É†„ÄÅ„Åù„Çå„Åû„Çå„ÅÆÊù°‰ª∂„ÅßÂèéÈõÜ!",
                initialCode: "// ‰∏°Êñπ„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Çà„ÅÜ!\n\n",
                hint: "if (isStar) „Å® if (isGem) „ÇíÂà•„ÄÖ„Å´",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 3], gems: [2, 4],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && r.gemsCollected >= 2
            },
            {
                id: 52, world: 3,
                title: "üß±‚≠ê ÈöúÂÆ≥Áâ©„Å®Êòü",
                description: "ÈöúÂÆ≥Áâ©„ÇíÈÅø„Åë„Å§„Å§Êòü„ÇíÈõÜ„ÇÅ„Çà„ÅÜ!",
                initialCode: "// ‰∏°Êñπ„Å´ÂØæÂøú!\n\n",
                hint: "„Åæ„ÅöÈöúÂÆ≥Áâ©„ÉÅ„Çß„ÉÉ„ÇØ„ÄÅÊ¨°„Å´Êòü„ÉÅ„Çß„ÉÉ„ÇØ",
                goalX: 6, goalY: 0,
                obstacles: [{x: 2, y: 0}], stars: [1, 4, 5], gems: [],
                validate: (r) => r.x === 6 && r.starsCollected >= 3 && !r.hitObstacle
            },
            {
                id: 53, world: 3,
                title: "üî¢ „Ç´„Ç¶„É≥„ÉàÊù°‰ª∂",
                description: "Êòü„Çí3ÂÄãÈõÜ„ÇÅ„Çã„Åæ„ÅßÈÄ≤„ÇÇ„ÅÜ!",
                initialCode: "// starsCollected „ÅßÊù°‰ª∂!\n\n",
                hint: "while (robot.starsCollected < 3)",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [1, 3, 5], gems: [],
                validate: (r) => r.starsCollected >= 3
            },
            {
                id: 54, world: 3,
                title: "üìç ‰ΩçÁΩÆÊù°‰ª∂",
                description: "robot.x „Çí‰Ωø„Å£„Å¶Êù°‰ª∂ÂàÜÂ≤ê!",
                initialCode: "// ‰ΩçÁΩÆ„ÅßÊù°‰ª∂„ÇíÂ§â„Åà„Çà„ÅÜ!\n\n",
                hint: "if (robot.x === 2) „Å™„Å©„Åß‰ΩçÁΩÆ„ÉÅ„Çß„ÉÉ„ÇØ",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [2], gems: [4],
                validate: (r) => r.x === 5 && r.starsCollected >= 1 && r.gemsCollected >= 1
            },
            {
                id: 55, world: 3,
                title: "üîÄ Ë§áÂêàÊù°‰ª∂",
                description: "Ë§áÊï∞„ÅÆÊù°‰ª∂„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„Çà„ÅÜ!",
                initialCode: "// && „Å® || „ÇíÁµÑ„ÅøÂêà„Çè„Åõ!\n\n",
                hint: "(Êù°‰ª∂A && Êù°‰ª∂B) || Êù°‰ª∂C",
                goalX: 6, goalY: 0,
                obstacles: [{x: 3, y: 0}], stars: [1, 2, 5], gems: [4],
                validate: (r) => r.x === 6 && r.starsCollected >= 3 && r.gemsCollected >= 1 && !r.hitObstacle
            },
            {
                id: 56, world: 3,
                title: "üéØ „Ç¥„Éº„É´„Åæ„ÅßÂèéÈõÜ",
                description: "„Ç¥„Éº„É´„Åæ„ÅßÂÖ®ÈÉ®ÈõÜ„ÇÅ„Çà„ÅÜ!",
                initialCode: "// isGoal() „Åæ„ÅßÂèéÈõÜ!\n\n",
                hint: "while (!isGoal()) „ÅßÂèéÈõÜ„Åó„Å™„Åå„Çâ",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [1, 2, 3, 4, 5], gems: [],
                validate: (r) => r.x === 6 && r.starsCollected >= 5
            },
            {
                id: 57, world: 3,
                title: "üß±üß± 2ÈöúÂÆ≥Áâ©Êù°‰ª∂",
                description: "2„Å§„ÅÆÈöúÂÆ≥Áâ©„ÇíÊù°‰ª∂„ÅßÈÅø„Åë„Çà„ÅÜ!",
                initialCode: "// Êù°‰ª∂„ÅßÈöúÂÆ≥Áâ©ÂØæÂøú!\n\n",
                hint: "„É´„Éº„ÉóÂÜÖ„Åß isObstacle() „ÉÅ„Çß„ÉÉ„ÇØ",
                goalX: 5, goalY: 0,
                obstacles: [{x: 1, y: 0}, {x: 3, y: 0}], stars: [], gems: [],
                validate: (r) => r.x === 5 && !r.hitObstacle
            },
            {
                id: 58, world: 3,
                title: "‚≠ê‚≠ê‚≠ê‚≠ê 4„Å§„ÅÆÊòü",
                description: "Êù°‰ª∂‰ªò„Åç„Åß4„Å§„ÅÆÊòü„ÇíÈõÜ„ÇÅ„Çà„ÅÜ!",
                initialCode: "// 4„Å§ÂÖ®ÈÉ®!\n\n",
                hint: "if (isStar()) „ÅßÊòü„Åå„ÅÇ„ÇãÊôÇ„Å†„Åë collect",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [1, 2, 4, 5], gems: [],
                validate: (r) => r.x === 6 && r.starsCollected >= 4
            },
            {
                id: 59, world: 3,
                title: "üåÄ „Éç„Çπ„ÉàÊù°‰ª∂",
                description: "if „ÅÆ‰∏≠„Å´ if „ÇíÂÖ•„Çå„Çà„ÅÜ!",
                initialCode: "// „Éç„Çπ„Éà„Åó„ÅüÊù°‰ª∂!\n\n",
                hint: "if (Êù°‰ª∂A) { if (Êù°‰ª∂B) { ... } }",
                goalX: 5, goalY: 0,
                obstacles: [{x: 2, y: 0}], stars: [3, 4], gems: [],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && !r.hitObstacle
            },
            {
                id: 60, world: 3,
                title: "üèÜ Êù°‰ª∂„Éû„Çπ„Çø„Éº",
                description: "ÂÖ®„Å¶„ÅÆÊù°‰ª∂ÊäÄË°ì„Çí‰Ωø„Åä„ÅÜ!",
                initialCode: "// Êù°‰ª∂„ÅÆÈõÜÂ§ßÊàê!\n\n",
                hint: "while, if, else, &&, || „ÇíÂÖ®ÈÉ®‰Ωø„Åä„ÅÜ",
                goalX: 8, goalY: 0,
                obstacles: [{x: 2, y: 0}, {x: 5, y: 0}], stars: [1, 3, 4, 6, 7], gems: [4],
                validate: (r) => r.x === 8 && r.starsCollected >= 5 && r.gemsCollected >= 1 && !r.hitObstacle
            },
            
            // ===== WORLD 4: FUNCTIONS (61-80) =====
            {
                id: 61, world: 4,
                title: "‚öôÔ∏è Èñ¢Êï∞ÂÖ•ÈñÄ",
                description: "<code>function ÂêçÂâç() { }</code> „ÅßÈñ¢Êï∞„Çí‰Ωú„Çç„ÅÜ!",
                initialCode: "// Èñ¢Êï∞„Çí‰Ωú„Å£„Å¶Âëº„Å≥Âá∫„Åù„ÅÜ!\nfunction moveOnce() {\n  robot.move();\n}\n\n// 3ÂõûÂëº„Å≥Âá∫„Åó„Å¶„Ç¥„Éº„É´„Å∏\n",
                hint: "Èñ¢Êï∞„ÇíÂÆöÁæ©„Åó„Å¶„ÄÅË§áÊï∞ÂõûÂëº„Å≥Âá∫„Åô",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === 0
            },
            {
                id: 62, world: 4,
                title: "‚öôÔ∏è moveTwoÈñ¢Êï∞",
                description: "2„Éû„ÇπÁßªÂãï„Åô„ÇãÈñ¢Êï∞„Çí‰Ωú„Çç„ÅÜ!",
                initialCode: "function moveTwo() {\n  // 2„Éû„ÇπÁßªÂãï„Åô„ÇãÈñ¢Êï∞\n}\n\n// Âëº„Å≥Âá∫„Åó„Å¶4„Éû„ÇπÈÄ≤„ÇÇ„ÅÜ\n",
                hint: "Èñ¢Êï∞ÂÜÖ„Å´ move() „Çí2ÂõûÊõ∏„Åè",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 4 && r.y === 0
            },
            {
                id: 63, world: 4,
                title: "üì¶ ÂºïÊï∞ÂÖ•ÈñÄ",
                description: "<code>function move(n)</code> „ÅßÂºïÊï∞„Çí‰Ωø„Åä„ÅÜ!",
                initialCode: "function moveN(n) {\n  // nÂõûÁßªÂãï„Åô„ÇãÈñ¢Êï∞\n}\n\n// moveN(4) „Åß4„Éû„ÇπÈÄ≤„ÇÇ„ÅÜ\n",
                hint: "Èñ¢Êï∞ÂÜÖ„Åß for „É´„Éº„Éó„Å®ÂºïÊï∞ n „Çí‰Ωø„ÅÜ",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 4 && r.y === 0
            },
            {
                id: 64, world: 4,
                title: "‚≠ê ÂèéÈõÜÈñ¢Êï∞",
                description: "ÁßªÂãï„Åó„Å¶ÂèéÈõÜ„Åô„ÇãÈñ¢Êï∞„Çí‰Ωú„Çç„ÅÜ!",
                initialCode: "function moveAndCollect() {\n  // ÁßªÂãï„Åó„Å¶ÂèéÈõÜ\n}\n\n// 3ÂõûÂëº„Å≥Âá∫„Åù„ÅÜ\n",
                hint: "Èñ¢Êï∞ÂÜÖ„Åß move() „Å® collect()",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [],
                validate: (r) => r.x === 3 && r.starsCollected >= 3
            },
            {
                id: 65, world: 4,
                title: "üß± „Ç∏„É£„É≥„ÉóÈñ¢Êï∞",
                description: "ÈöúÂÆ≥Áâ©Âá¶ÁêÜ„ÇíÈñ¢Êï∞„Å´„Åó„Çà„ÅÜ!",
                initialCode: "function handleMove() {\n  // ÈöúÂÆ≥Áâ©„Åå„ÅÇ„Çå„Å∞„Ç∏„É£„É≥„Éó\n}\n\n// 4ÂõûÂëº„Å≥Âá∫„Åù„ÅÜ\n",
                hint: "if (isObstacle()) „ÇíÈñ¢Êï∞ÂÜÖ„Å´",
                goalX: 4, goalY: 0,
                obstacles: [{x: 2, y: 0}], stars: [], gems: [],
                validate: (r) => r.x === 4 && !r.hitObstacle
            },
            {
                id: 66, world: 4,
                title: "üîô returnÂÖ•ÈñÄ",
                description: "<code>return</code> „ÅßÂÄ§„ÇíËøî„Åù„ÅÜ!",
                initialCode: "function getX() {\n  return robot.x;\n}\n\n// Èñ¢Êï∞„Çí‰Ωø„Å£„Å¶ÁßªÂãï\nwhile (getX() < 4) {\n  robot.move();\n}\n",
                hint: "return „ÅßÁèæÂú®‰ΩçÁΩÆ„ÇíËøî„Åô",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 4
            },
            {
                id: 67, world: 4,
                title: "üî¢ „Ç´„Ç¶„É≥„ÉàÈñ¢Êï∞",
                description: "ÂèéÈõÜ„Åó„ÅüÊï∞„ÇíËøî„ÅôÈñ¢Êï∞„Çí‰Ωú„Çç„ÅÜ!",
                initialCode: "function collectAndCount() {\n  robot.move();\n  robot.collect();\n  return robot.starsCollected;\n}\n\n// 3ÂõûÂëº„Å≥Âá∫„Åù„ÅÜ\n",
                hint: "collect() Âæå„Å´ starsCollected „Çí return",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [],
                validate: (r) => r.x === 3 && r.starsCollected >= 3
            },
            {
                id: 68, world: 4,
                title: "‚öôÔ∏è‚öôÔ∏è 2„Å§„ÅÆÈñ¢Êï∞",
                description: "2„Å§„ÅÆÈñ¢Êï∞„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„Çà„ÅÜ!",
                initialCode: "function goRight() {\n  robot.move();\n}\n\nfunction goUp() {\n  robot.moveUp();\n}\n\n// ÁµÑ„ÅøÂêà„Çè„Åõ„Å¶‰Ωø„Åä„ÅÜ\n",
                hint: "„Åù„Çå„Åû„Çå„ÅÆÈñ¢Êï∞„ÇíÈÅ©Âàá„Å´Âëº„Å≥Âá∫„Åô",
                goalX: 2, goalY: -2,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 2 && r.y === -2
            },
            {
                id: 69, world: 4,
                title: "üì¶ Ë§áÊï∞ÂºïÊï∞",
                description: "ÂºïÊï∞„Çí2„Å§‰Ωø„ÅÜÈñ¢Êï∞„Çí‰Ωú„Çç„ÅÜ!",
                initialCode: "function moveXY(x, y) {\n  // xÂõûÂè≥„ÄÅyÂõû‰∏ä„Å´ÁßªÂãï\n}\n\n// moveXY(3, 2) „ÅßÁßªÂãï\n",
                hint: "forÊñá„Çí2„Å§‰Ωø„Å£„Å¶ x „Å® y ÂõûÁßªÂãï",
                goalX: 3, goalY: -2,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === -2
            },
            {
                id: 70, world: 4,
                title: "üéØ Êù°‰ª∂‰ªò„ÅçÈñ¢Êï∞",
                description: "Êù°‰ª∂ÂàÜÂ≤ê„ÇíÂê´„ÇÄÈñ¢Êï∞„Çí‰Ωú„Çç„ÅÜ!",
                initialCode: "function smartMove() {\n  // ÈöúÂÆ≥Áâ©„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶ÁßªÂãï\n}\n\n// „É´„Éº„Éó„ÅßÂëº„Å≥Âá∫„Åù„ÅÜ\n",
                hint: "if (isObstacle()) „ÇíÈñ¢Êï∞ÂÜÖ„Å´",
                goalX: 5, goalY: 0,
                obstacles: [{x: 2, y: 0}, {x: 4, y: 0}], stars: [], gems: [],
                validate: (r) => r.x === 5 && !r.hitObstacle
            },
            {
                id: 71, world: 4,
                title: "‚≠ê ÂèéÈõÜ„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞",
                description: "Êòü„Åå„ÅÇ„Çå„Å∞ÂèéÈõÜ„Åô„ÇãÈñ¢Êï∞„Çí‰Ωú„Çç„ÅÜ!",
                initialCode: "function tryCollect() {\n  // Êòü„Åå„ÅÇ„Çå„Å∞ÂèéÈõÜ\n}\n\n// ÁßªÂãï„Åó„Å™„Åå„ÇâÂëº„Å≥Âá∫„Åù„ÅÜ\n",
                hint: "if (isStar()) { collect() } „ÇíÈñ¢Êï∞„Å´",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 3, 5], gems: [],
                validate: (r) => r.x === 5 && r.starsCollected >= 3
            },
            {
                id: 72, world: 4,
                title: "üíé „Ç∏„Çß„É†ÂèéÈõÜÈñ¢Êï∞",
                description: "„Ç∏„Çß„É†„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞„Çí‰Ωú„Çç„ÅÜ!",
                initialCode: "function tryCollectGem() {\n  // „Ç∏„Çß„É†„Åå„ÅÇ„Çå„Å∞ÂèéÈõÜ\n}\n\n",
                hint: "if (isGem()) { collectGem() }",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [1, 2, 4],
                validate: (r) => r.x === 5 && r.gemsCollected >= 3
            },
            {
                id: 73, world: 4,
                title: "üîÄ ÂàÜÂ≤êÈñ¢Êï∞",
                description: "Ë§áÊï∞„ÅÆÂàÜÂ≤ê„ÇíÂê´„ÇÄÈñ¢Êï∞„Çí‰Ωú„Çç„ÅÜ!",
                initialCode: "function step() {\n  // ÈöúÂÆ≥Áâ©„ÄÅÊòü„ÄÅ„Ç∏„Çß„É†„Çí„ÉÅ„Çß„ÉÉ„ÇØ\n}\n\n",
                hint: "if-else if-else „ÅßÂÖ®„Ç±„Éº„ÇπÂØæÂøú",
                goalX: 5, goalY: 0,
                obstacles: [{x: 2, y: 0}], stars: [1, 4], gems: [3],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && r.gemsCollected >= 1 && !r.hitObstacle
            },
            {
                id: 74, world: 4,
                title: "üîÅ „É´„Éº„ÉóÈñ¢Êï∞",
                description: "„É´„Éº„Éó„ÇíÂê´„ÇÄÈñ¢Êï∞„Çí‰Ωú„Çç„ÅÜ!",
                initialCode: "function moveMany(n) {\n  // nÂõûÁßªÂãï\n}\n\n// moveMany(5) „Åß5„Éû„Çπ\n",
                hint: "for (let i = 0; i < n; i++) „ÇíÈñ¢Êï∞ÂÜÖ„Å´",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 5 && r.y === 0
            },
            {
                id: 75, world: 4,
                title: "üîô boolÈñ¢Êï∞",
                description: "true/false „ÇíËøî„ÅôÈñ¢Êï∞„Çí‰Ωú„Çç„ÅÜ!",
                initialCode: "function canCollect() {\n  return robot.isStar() || robot.isGem();\n}\n\n// canCollect() „Çí‰Ωø„Åä„ÅÜ\n",
                hint: "|| „ÅßÊòü„Åæ„Åü„ÅØ„Ç∏„Çß„É†„Çí„ÉÅ„Çß„ÉÉ„ÇØ",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 3], gems: [2, 4],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && r.gemsCollected >= 2
            },
            {
                id: 76, world: 4,
                title: "‚öôÔ∏è‚öôÔ∏è‚öôÔ∏è 3„Å§„ÅÆÈñ¢Êï∞",
                description: "3„Å§„ÅÆÈñ¢Êï∞„ÇíÈÄ£Êê∫„Åï„Åõ„Çà„ÅÜ!",
                initialCode: "function handleObstacle() { }\nfunction collectStar() { }\nfunction collectGem() { }\n\n// ÁµÑ„ÅøÂêà„Çè„Åõ„Å¶‰Ωø„Åä„ÅÜ\n",
                hint: "ÂêÑÈñ¢Êï∞„Å´ÈÅ©Âàá„Å™Âá¶ÁêÜ„ÇíÊõ∏„Åè",
                goalX: 6, goalY: 0,
                obstacles: [{x: 2, y: 0}], stars: [1, 4, 5], gems: [3],
                validate: (r) => r.x === 6 && r.starsCollected >= 3 && r.gemsCollected >= 1 && !r.hitObstacle
            },
            {
                id: 77, world: 4,
                title: "üéØ „Ç¥„Éº„É´Èñ¢Êï∞",
                description: "„Ç¥„Éº„É´„Åæ„ÅßÈÄ≤„ÇÄÈñ¢Êï∞„Çí‰Ωú„Çç„ÅÜ!",
                initialCode: "function goToGoal() {\n  // isGoal() „Åæ„Åß„É´„Éº„Éó\n}\n\ngoToGoal();\n",
                hint: "while (!isGoal()) „ÇíÈñ¢Êï∞ÂÜÖ„Å´",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 6
            },
            {
                id: 78, world: 4,
                title: "üåÄ ÂÜçÂ∏∞ÁöÑÊÄùËÄÉ",
                description: "Èñ¢Êï∞„Åã„ÇâÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åù„ÅÜ!",
                initialCode: "function step() {\n  // 1Ê≠©ÈÄ≤„ÇÄ\n}\n\nfunction run() {\n  // step() „ÇíÁπ∞„ÇäËøî„ÅóÂëº„Å∂\n}\n\nrun();\n",
                hint: "run() ÂÜÖ„Åß for „É´„Éº„Éó„Åß step() „ÇíÂëº„Å∂",
                goalX: 5, goalY: 0,
                obstacles: [{x: 2, y: 0}], stars: [1, 3, 4], gems: [],
                validate: (r) => r.x === 5 && r.starsCollected >= 3 && !r.hitObstacle
            },
            {
                id: 79, world: 4,
                title: "üìä Áµ±Ë®àÈñ¢Êï∞",
                description: "ÂèéÈõÜÊï∞„ÅÆÂêàË®à„ÇíËøî„ÅôÈñ¢Êï∞!",
                initialCode: "function getTotal() {\n  return robot.starsCollected + robot.gemsCollected;\n}\n\n// getTotal() „Çí‰Ωø„Åä„ÅÜ\n",
                hint: "Êòü„Å®„Ç∏„Çß„É†„ÅÆÂêàË®à„Çí return",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [4],
                validate: (r) => r.x === 5 && r.starsCollected >= 3 && r.gemsCollected >= 1
            },
            {
                id: 80, world: 4,
                title: "üèÜ „Éû„Çπ„Çø„Éº„ÉÅ„É£„É¨„É≥„Ç∏",
                description: "ÂÖ®ÊäÄË°ì„Çí‰Ωø„Å£„Å¶„Ç¥„Éº„É´„Å∏!",
                initialCode: "// ÊúÄÁµÇ„ÉÅ„É£„É¨„É≥„Ç∏!\n// Èñ¢Êï∞„ÄÅ„É´„Éº„Éó„ÄÅÊù°‰ª∂„ÇíÂÖ®ÈÉ®‰Ωø„Åä„ÅÜ!\n\n",
                hint: "smartMove, collectAll Èñ¢Êï∞„Çí‰Ωú„Çä„ÄÅwhile„Åß„Ç¥„Éº„É´„Åæ„Åß",
                goalX: 9, goalY: 0,
                obstacles: [{x: 2, y: 0}, {x: 4, y: 0}, {x: 7, y: 0}], 
                stars: [1, 3, 5, 6, 8], gems: [3, 6, 9],
                validate: (r) => r.x === 9 && r.starsCollected >= 5 && r.gemsCollected >= 3 && !r.hitObstacle
            }
        ];

        // ===== ROBOT CLASS =====
        class Robot {
            constructor() {
                this.reset();
            }

            reset() {
                this.x = 0;
                this.y = 0;
                this.starsCollected = 0;
                this.gemsCollected = 0;
                this.hitObstacle = false;
                this.moves = [];
                this.currentLevel = null;
                this.eyeState = 'normal';
                this.antennaGlow = 0;
            }

            setLevel(level) {
                this.currentLevel = level;
            }

            move() {
                const nextX = this.x + 1;
                if (this.checkObstacleAt(nextX, this.y)) {
                    this.hitObstacle = true;
                    log('üí• ÈöúÂÆ≥Áâ©„Å´„Å∂„Å§„Åã„Å£„Åü!');
                    return;
                }
                this.moves.push({ type: 'move', fromX: this.x, fromY: this.y, toX: nextX, toY: this.y });
                this.x = nextX;
                log(`ü§ñ ÁßªÂãï ‚Üí (${this.x}, ${this.y})`);
            }

            moveUp() {
                const nextY = this.y - 1;
                this.moves.push({ type: 'moveUp', fromX: this.x, fromY: this.y, toX: this.x, toY: nextY });
                this.y = nextY;
                log(`ü§ñ ‰∏ä„Å∏ÁßªÂãï ‚Üë (${this.x}, ${this.y})`);
            }

            moveDown() {
                const nextY = this.y + 1;
                this.moves.push({ type: 'moveDown', fromX: this.x, fromY: this.y, toX: this.x, toY: nextY });
                this.y = nextY;
                log(`ü§ñ ‰∏ã„Å∏ÁßªÂãï ‚Üì (${this.x}, ${this.y})`);
            }

            jump() {
                const nextX = this.x + 1;
                this.moves.push({ type: 'jump', fromX: this.x, fromY: this.y, toX: nextX, toY: this.y });
                this.x = nextX;
                log(`ü§ñ „Ç∏„É£„É≥„Éó! ‚Üí (${this.x}, ${this.y})`);
            }

            collect() {
                if (this.isStar()) {
                    this.starsCollected++;
                    this.moves.push({ type: 'collectStar', x: this.x, y: this.y });
                    log(`‚≠ê Êòü„ÇíÂèéÈõÜ! (${this.starsCollected}ÂÄã)`);
                }
            }

            collectGem() {
                if (this.isGem()) {
                    this.gemsCollected++;
                    this.moves.push({ type: 'collectGem', x: this.x, y: this.y });
                    log(`üíé „Ç∏„Çß„É†„ÇíÂèéÈõÜ! (${this.gemsCollected}ÂÄã)`);
                }
            }

            checkObstacleAt(x, y) {
                if (!this.currentLevel) return false;
                return this.currentLevel.obstacles.some(o => o.x === x && o.y === y);
            }

            isObstacle() {
                return this.checkObstacleAt(this.x + 1, this.y);
            }

            isStar() {
                if (!this.currentLevel) return false;
                return this.currentLevel.stars.includes(this.x);
            }

            isGem() {
                if (!this.currentLevel) return false;
                return this.currentLevel.gems.includes(this.x);
            }

            isGoal() {
                if (!this.currentLevel) return false;
                return this.x === this.currentLevel.goalX && this.y === this.currentLevel.goalY;
            }
        }

        // ===== GAME STATE =====
        const robot = new Robot();
        let currentLevelIndex = 0;
        let currentWorld = 1;
        let completedLevels = new Set();
        let levelStars = {};
        let levelCompletionMode = {}; // Track completion mode: 'code', 'block', or 'both'
        let totalStarsEarned = 0;
        let collectedStarsInLevel = new Set();
        let collectedGemsInLevel = new Set();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const output = document.getElementById('output');

        // ===== STARFIELD BACKGROUND =====
        function createStarfield() {
            const starfield = document.getElementById('starfield');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = (Math.random() * 3 + 1) + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 3 + 's';
                starfield.appendChild(star);
            }
        }
        createStarfield();

        // ===== LOGGING =====
        function log(message) {
            const p = document.createElement('p');
            p.innerHTML = message;
            output.appendChild(p);
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            output.innerHTML = '';
        }

        // ===== LEVEL MANAGEMENT =====
        function getWorldLevels(world) {
            return levels.filter(l => l.world === world);
        }

        function loadLevel(index) {
            currentLevelIndex = index;
            const level = levels[index];
            currentWorld = level.world;
            robot.setLevel(level);
            robot.reset();
            collectedStarsInLevel.clear();
            collectedGemsInLevel.clear();
            
            document.getElementById('challengeTitle').innerHTML = 
                `üéØ ${level.title}` + 
                (level.concept ? `<span class="new-concept">${level.concept}</span>` : '');
            document.getElementById('challengeDescription').innerHTML = level.description;
            document.getElementById('codeInput').value = level.initialCode;
            document.getElementById('hintBox').classList.remove('show');
            clearLog();
            drawCanvas();
            
            // Clear block workspace when loading new level
            if (typeof clearBlockWorkspace === 'function') {
                clearBlockWorkspace();
            }
            
            updateWorldButtons();
            updateLevelButtons();
            updateStats();
            updateLineNumbers();
            updateGameInfo();
        }

        function updateWorldButtons() {
            document.querySelectorAll('.world-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.world) === currentWorld);
            });
        }

        function updateLevelButtons() {
            const selector = document.getElementById('levelSelector');
            selector.innerHTML = '';
            
            const worldLevels = getWorldLevels(currentWorld);
            
            worldLevels.forEach((level) => {
                const btn = document.createElement('button');
                btn.className = 'level-btn';
                
                const globalIndex = levels.findIndex(l => l.id === level.id);
                
                if (globalIndex === currentLevelIndex) btn.classList.add('active');
                
                // Apply completion mode styling
                if (completedLevels.has(level.id)) {
                    const mode = levelCompletionMode[level.id];
                    if (mode === 'both') {
                        btn.classList.add('completed-both');
                    } else if (mode === 'block') {
                        btn.classList.add('completed-block');
                    } else {
                        btn.classList.add('completed'); // code mode (green)
                    }
                }
                
                btn.textContent = level.id;
                
                // Add stars
                if (levelStars[level.id]) {
                    const starsDiv = document.createElement('span');
                    starsDiv.className = 'stars';
                    starsDiv.textContent = '‚≠ê'.repeat(levelStars[level.id]);
                    btn.appendChild(starsDiv);
                }
                
                btn.onclick = () => {
                    loadLevel(globalIndex);
                };
                selector.appendChild(btn);
            });
        }

        function updateStats() {
            document.getElementById('completedCount').textContent = completedLevels.size;
            document.getElementById('totalStars').textContent = totalStarsEarned;
        }

        function updateGameInfo() {
            document.getElementById('robotPos').textContent = `(${robot.x}, ${robot.y})`;
            document.getElementById('starsCollected').textContent = robot.starsCollected;
            document.getElementById('gemsCollected').textContent = robot.gemsCollected;
        }

        function updateLineNumbers() {
            const textarea = document.getElementById('codeInput');
            const lines = textarea.value.split('\n').length;
            const lineNumbers = document.getElementById('lineNumbers');
            lineNumbers.innerHTML = Array.from({length: lines}, (_, i) => i + 1).join('<br>');
        }

        // ===== DRAWING =====
        function drawCanvas() {
            const level = levels[currentLevelIndex];
            const cellSize = 50;
            const startX = 40;
            const startY = 200;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid background
            drawGrid(startX, startY, cellSize);
            
            // Draw path
            drawPath(startX, startY, cellSize, level.goalX);
            
            // Draw obstacles
            drawObstacles(startX, startY, cellSize, level.obstacles);
            
            // Draw stars
            drawStars(startX, startY, cellSize, level.stars);
            
            // Draw gems
            drawGems(startX, startY, cellSize, level.gems);
            
            // Draw goal
            drawGoal(startX + level.goalX * cellSize, startY + level.goalY * cellSize, cellSize);
            
            // Draw robot
            drawRobot(startX + robot.x * cellSize + cellSize / 2, startY + robot.y * cellSize - cellSize / 2 + 10, cellSize);
        }

        function drawGrid(startX, startY, cellSize) {
            const isLightMode = document.body.classList.contains('light-mode');
            ctx.strokeStyle = isLightMode ? 'rgba(71, 85, 105, 0.25)' : 'rgba(0, 245, 255, 0.1)';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 12; i++) {
                ctx.beginPath();
                ctx.moveTo(startX + i * cellSize, 50);
                ctx.lineTo(startX + i * cellSize, 350);
                ctx.stroke();
            }
            
            for (let i = 0; i <= 6; i++) {
                ctx.beginPath();
                ctx.moveTo(startX, 50 + i * cellSize);
                ctx.lineTo(startX + 12 * cellSize, 50 + i * cellSize);
                ctx.stroke();
            }
        }

        function drawPath(startX, startY, cellSize, goalX) {
            const isLightMode = document.body.classList.contains('light-mode');
            
            let gradient;
            if (isLightMode) {
                gradient = ctx.createLinearGradient(startX, 0, startX + (goalX + 1) * cellSize, 0);
                gradient.addColorStop(0, 'rgba(203, 213, 225, 0.9)');
                gradient.addColorStop(1, 'rgba(16, 185, 129, 0.3)');
            } else {
                gradient = ctx.createLinearGradient(startX, 0, startX + (goalX + 1) * cellSize, 0);
                gradient.addColorStop(0, 'rgba(30, 42, 69, 0.8)');
                gradient.addColorStop(1, 'rgba(0, 255, 136, 0.2)');
            }
            
            ctx.fillStyle = gradient;
            ctx.fillRect(startX, startY - cellSize + 10, (goalX + 1) * cellSize, cellSize);
            
            // Path border
            ctx.strokeStyle = isLightMode ? 'rgba(71, 85, 105, 0.5)' : 'rgba(0, 245, 255, 0.3)';
            ctx.lineWidth = 2;
            ctx.strokeRect(startX, startY - cellSize + 10, (goalX + 1) * cellSize, cellSize);
        }

        function drawObstacles(startX, startY, cellSize, obstacles) {
            const isLightMode = document.body.classList.contains('light-mode');
            
            obstacles.forEach(obs => {
                const x = startX + obs.x * cellSize;
                const y = startY + obs.y * cellSize - cellSize + 10;
                
                // Obstacle body with gradient
                const gradient = ctx.createLinearGradient(x, y, x, y + cellSize);
                gradient.addColorStop(0, '#ff2d75');
                gradient.addColorStop(1, '#c91a5a');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x + 5, y + 10, cellSize - 10, cellSize - 10);
                
                // Danger stripes
                ctx.strokeStyle = '#ffcc00';
                ctx.lineWidth = 3;
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.moveTo(x + 10 + i * 12, y + 15);
                    ctx.lineTo(x + 10 + i * 12, y + cellSize - 5);
                    ctx.stroke();
                }
                
                // Border
                ctx.strokeStyle = isLightMode ? '#9f1239' : '#ff2d75';
                ctx.lineWidth = isLightMode ? 3 : 2;
                ctx.strokeRect(x + 5, y + 10, cellSize - 10, cellSize - 10);
                
                // Glow effect (only in dark mode)
                if (!isLightMode) {
                    ctx.shadowColor = '#ff2d75';
                    ctx.shadowBlur = 15;
                    ctx.strokeRect(x + 5, y + 10, cellSize - 10, cellSize - 10);
                    ctx.shadowBlur = 0;
                }
            });
        }

        function drawStars(startX, startY, cellSize, stars) {
            const isLightMode = document.body.classList.contains('light-mode');
            
            stars.forEach(starX => {
                if (collectedStarsInLevel.has(starX)) return;
                
                const x = startX + starX * cellSize + cellSize / 2;
                const y = startY - 60;
                
                // Glow (only in dark mode)
                if (!isLightMode) {
                    ctx.shadowColor = '#ffcc00';
                    ctx.shadowBlur = 20;
                }
                
                drawStarShape(ctx, x, y, 12, 5, '#ffcc00', '#ff9500');
                
                // Add outline in light mode
                if (isLightMode) {
                    ctx.strokeStyle = '#b45309';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                
                ctx.shadowBlur = 0;
            });
        }

        function drawGems(startX, startY, cellSize, gems) {
            const isLightMode = document.body.classList.contains('light-mode');
            
            gems.forEach(gemX => {
                if (collectedGemsInLevel.has(gemX)) return;
                
                const x = startX + gemX * cellSize + cellSize / 2;
                const y = startY - 75;
                
                // Glow (only in dark mode)
                if (!isLightMode) {
                    ctx.shadowColor = '#b14eff';
                    ctx.shadowBlur = 15;
                }
                
                ctx.fillStyle = '#b14eff';
                ctx.beginPath();
                ctx.moveTo(x, y - 10);
                ctx.lineTo(x + 8, y);
                ctx.lineTo(x, y + 10);
                ctx.lineTo(x - 8, y);
                ctx.closePath();
                ctx.fill();
                
                // Add outline in light mode
                if (isLightMode) {
                    ctx.strokeStyle = '#7c3aed';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                
                // Shine
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.beginPath();
                ctx.moveTo(x - 2, y - 5);
                ctx.lineTo(x + 3, y - 5);
                ctx.lineTo(x, y);
                ctx.closePath();
                ctx.fill();
                
                ctx.shadowBlur = 0;
            });
        }

        function drawStarShape(ctx, cx, cy, outerR, points, color1, color2) {
            const gradient = ctx.createRadialGradient(cx, cy, 0, cx, cy, outerR);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            
            for (let i = 0; i < points * 2; i++) {
                const angle = (i * Math.PI) / points - Math.PI / 2;
                const radius = i % 2 === 0 ? outerR : outerR / 2;
                const x = cx + Math.cos(angle) * radius;
                const y = cy + Math.sin(angle) * radius;
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            
            ctx.closePath();
            ctx.fill();
        }

        function drawGoal(x, y, cellSize) {
            const isLightMode = document.body.classList.contains('light-mode');
            
            // Goal platform
            const gradient = ctx.createLinearGradient(x, y - cellSize, x, y + 10);
            gradient.addColorStop(0, '#00ff88');
            gradient.addColorStop(1, '#00cc6a');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(x + 5, y - cellSize + 10, cellSize - 10, cellSize);
            
            // Border for visibility
            ctx.strokeStyle = isLightMode ? '#047857' : '#00ff88';
            ctx.lineWidth = isLightMode ? 3 : 2;
            ctx.strokeRect(x + 5, y - cellSize + 10, cellSize - 10, cellSize);
            
            // Glow (only in dark mode)
            if (!isLightMode) {
                ctx.shadowColor = '#00ff88';
                ctx.shadowBlur = 20;
                ctx.strokeRect(x + 5, y - cellSize + 10, cellSize - 10, cellSize);
                ctx.shadowBlur = 0;
            }
            
            // Flag pole
            ctx.fillStyle = isLightMode ? '#047857' : '#00ff88';
            ctx.fillRect(x + cellSize / 2 - 2, y - cellSize - 20, 4, 40);
            
            // Flag
            ctx.fillStyle = '#ff2d75';
            ctx.beginPath();
            ctx.moveTo(x + cellSize / 2 + 2, y - cellSize - 15);
            ctx.lineTo(x + cellSize / 2 + 25, y - cellSize - 5);
            ctx.lineTo(x + cellSize / 2 + 2, y - cellSize + 5);
            ctx.closePath();
            ctx.fill();
            
            // Flag border in light mode
            if (isLightMode) {
                ctx.strokeStyle = '#9f1239';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        function drawRobot(x, y, cellSize) {
            drawRobotWithColors(ctx, x, y, selectedCharacter.colors, 1, cellSize);
        }
        
        function drawRobotWithColors(ctx, x, y, colors, scale = 1, cellSize = 50) {
            const size = cellSize * 0.7 * scale;
            
            // Shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.beginPath();
            ctx.ellipse(x, y + size / 2 + 5 * scale, size / 2, 8 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Body glow
            ctx.shadowColor = colors.body;
            ctx.shadowBlur = 20 * scale;
            
            // Body
            const bodyGradient = ctx.createLinearGradient(x - size/2, y - size/2, x + size/2, y + size/2);
            bodyGradient.addColorStop(0, colors.body);
            bodyGradient.addColorStop(0.5, colors.bodyGlow);
            bodyGradient.addColorStop(1, colors.bodyGlow);
            
            ctx.fillStyle = bodyGradient;
            ctx.beginPath();
            ctx.roundRect(x - size/2, y - size/2, size, size, 8 * scale);
            ctx.fill();
            
            ctx.shadowBlur = 0;
            
            // Face plate
            ctx.fillStyle = '#0a1520';
            ctx.beginPath();
            ctx.roundRect(x - size/2 + 5 * scale, y - size/2 + 5 * scale, size - 10 * scale, size/2, 5 * scale);
            ctx.fill();
            
            // Eyes
            const eyeY = y - size/4;
            const eyeSpacing = size / 4;
            
            // Eye glow
            ctx.shadowColor = colors.eye;
            ctx.shadowBlur = 10 * scale;
            
            // Left eye
            ctx.fillStyle = colors.eye;
            ctx.beginPath();
            ctx.arc(x - eyeSpacing, eyeY, 6 * scale, 0, Math.PI * 2);
            ctx.fill();
            
            // Right eye
            ctx.beginPath();
            ctx.arc(x + eyeSpacing, eyeY, 6 * scale, 0, Math.PI * 2);
            ctx.fill();
            
            // Eye highlights
            ctx.shadowBlur = 0;
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(x - eyeSpacing - 2 * scale, eyeY - 2 * scale, 2 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + eyeSpacing - 2 * scale, eyeY - 2 * scale, 2 * scale, 0, Math.PI * 2);
            ctx.fill();
            
            // Mouth (smile)
            ctx.strokeStyle = colors.eye;
            ctx.lineWidth = 2 * scale;
            ctx.beginPath();
            ctx.arc(x, y + 2 * scale, 8 * scale, 0.1 * Math.PI, 0.9 * Math.PI);
            ctx.stroke();
            
            // Antenna
            ctx.strokeStyle = colors.body;
            ctx.lineWidth = 3 * scale;
            ctx.beginPath();
            ctx.moveTo(x, y - size/2);
            ctx.lineTo(x, y - size/2 - 15 * scale);
            ctx.stroke();
            
            // Antenna ball with glow
            ctx.shadowColor = colors.antenna;
            ctx.shadowBlur = 15 * scale;
            ctx.fillStyle = colors.antenna;
            ctx.beginPath();
            ctx.arc(x, y - size/2 - 18 * scale, 5 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            // Chest panel
            ctx.fillStyle = '#0a1520';
            ctx.beginPath();
            ctx.roundRect(x - 12 * scale, y + 5 * scale, 24 * scale, 12 * scale, 3 * scale);
            ctx.fill();
            
            // Chest lights
            const lightColors = colors.chest;
            for (let i = 0; i < 3; i++) {
                ctx.fillStyle = lightColors[i];
                ctx.beginPath();
                ctx.arc(x - 8 * scale + i * 8 * scale, y + 11 * scale, 3 * scale, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Arms
            ctx.fillStyle = colors.bodyGlow;
            ctx.fillRect(x - size/2 - 8 * scale, y - 5 * scale, 8 * scale, 20 * scale);
            ctx.fillRect(x + size/2, y - 5 * scale, 8 * scale, 20 * scale);
            
            // Hands
            ctx.fillStyle = colors.body;
            ctx.beginPath();
            ctx.arc(x - size/2 - 4 * scale, y + 18 * scale, 6 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + size/2 + 4 * scale, y + 18 * scale, 6 * scale, 0, Math.PI * 2);
            ctx.fill();
        }

        // ===== ANIMATION =====
        async function animateRobot() {
            const cellSize = 50;
            const startX = 40;
            const startY = 200;
            
            for (const move of robot.moves) {
                if (move.type === 'collectStar') {
                    collectedStarsInLevel.add(move.x);
                    createParticles(startX + move.x * cellSize + cellSize/2, startY - 60, '#ffcc00');
                    drawCanvas();
                    await sleep(200);
                    continue;
                }
                
                if (move.type === 'collectGem') {
                    collectedGemsInLevel.add(move.x);
                    createParticles(startX + move.x * cellSize + cellSize/2, startY - 75, '#b14eff');
                    drawCanvas();
                    await sleep(200);
                    continue;
                }
                
                const frames = 15;
                for (let frame = 0; frame <= frames; frame++) {
                    const progress = frame / frames;
                    const easeProgress = 1 - Math.pow(1 - progress, 3); // easeOutCubic
                    
                    let currentX = move.fromX + (move.toX - move.fromX) * easeProgress;
                    let currentY = move.fromY + (move.toY - move.fromY) * easeProgress;
                    let jumpOffset = 0;
                    
                    if (move.type === 'jump') {
                        jumpOffset = Math.sin(progress * Math.PI) * 40;
                    }
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    drawGrid(startX, startY, cellSize);
                    drawPath(startX, startY, cellSize, levels[currentLevelIndex].goalX);
                    drawObstacles(startX, startY, cellSize, levels[currentLevelIndex].obstacles);
                    drawStars(startX, startY, cellSize, levels[currentLevelIndex].stars);
                    drawGems(startX, startY, cellSize, levels[currentLevelIndex].gems);
                    drawGoal(startX + levels[currentLevelIndex].goalX * cellSize, startY + levels[currentLevelIndex].goalY * cellSize, cellSize);
                    
                    drawRobot(
                        startX + currentX * cellSize + cellSize/2,
                        startY + currentY * cellSize - cellSize/2 + 10 - jumpOffset,
                        cellSize
                    );
                    
                    await sleep(20);
                }
                
                updateGameInfo();
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ===== PARTICLE EFFECTS =====
        function createParticles(x, y, color) {
            for (let i = 0; i < 12; i++) {
                const angle = (Math.PI * 2 / 12) * i;
                const speed = 3 + Math.random() * 2;
                const particle = {
                    x, y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 1,
                    color
                };
                animateParticle(particle);
            }
        }

        async function animateParticle(particle) {
            while (particle.life > 0) {
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.vy += 0.2;
                particle.life -= 0.05;
                
                ctx.globalAlpha = particle.life;
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, 4 * particle.life, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
                
                await sleep(16);
            }
        }

        // ===== CELEBRATION =====
        function showCelebration() {
            const container = document.getElementById('celebrationContainer');
            const colors = ['#ff2d75', '#00f5ff', '#ffcc00', '#00ff88', '#b14eff'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                container.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function showLevelComplete(starsEarned) {
            const modal = document.getElementById('levelCompleteModal');
            const starsDisplay = document.getElementById('modalStars');
            const message = document.getElementById('modalMessage');
            
            starsDisplay.textContent = '‚≠ê'.repeat(starsEarned) + '‚òÜ'.repeat(3 - starsEarned);
            
            if (starsEarned === 3) {
                message.textContent = 'ÂÆåÁíß! Á¥†Êô¥„Çâ„Åó„ÅÑ„Ç≥„Éº„Éâ„Å†!';
            } else if (starsEarned === 2) {
                message.textContent = '„ÅÑ„ÅÑÊÑü„Åò! „ÇÇ„Å£„Å®ÂäπÁéáÁöÑ„Å´Êõ∏„Åë„Çã„Åã„Å™?';
            } else {
                message.textContent = '„ÇØ„É™„Ç¢! „ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Å¶„Åø„Çà„ÅÜ!';
            }
            
            modal.classList.add('show');
            showCelebration();
        }

        // ===== BLOCK MODE SYSTEM =====
        let currentEditorMode = 'code'; // 'code' or 'block'
        let currentBlockCategory = 'motion';
        let draggedBlock = null;
        let dragClone = null;
        let isDragging = false;
        let blockZoom = 100; // Zoom percentage
        
        // Block definitions
        const blockDefinitions = {
            motion: [
                { id: 'move', icon: '‚û°Ô∏è', label: 'Âè≥„Å´ÁßªÂãï', code: 'robot.move();', category: 'motion' },
                { id: 'moveUp', icon: '‚¨ÜÔ∏è', label: '‰∏ä„Å´ÁßªÂãï', code: 'robot.moveUp();', category: 'motion' },
                { id: 'moveDown', icon: '‚¨áÔ∏è', label: '‰∏ã„Å´ÁßªÂãï', code: 'robot.moveDown();', category: 'motion' },
                { id: 'jump', icon: 'ü¶ò', label: '„Ç∏„É£„É≥„Éó', code: 'robot.jump();', category: 'motion' }
            ],
            collect: [
                { id: 'collect', icon: '‚≠ê', label: 'Êòü„ÇíÂèéÈõÜ', code: 'robot.collect();', category: 'collect' },
                { id: 'collectGem', icon: 'üíé', label: '„Ç∏„Çß„É†ÂèéÈõÜ', code: 'robot.collectGem();', category: 'collect' }
            ],
            check: [
                { id: 'isObstacle', icon: 'üß±', label: 'ÈöúÂÆ≥Áâ©Ôºü', code: 'robot.isObstacle()', isCondition: true, category: 'check' },
                { id: 'isStar', icon: '‚≠ê', label: 'Êòü„Åå„ÅÇ„ÇãÔºü', code: 'robot.isStar()', isCondition: true, category: 'check' },
                { id: 'isGem', icon: 'üíé', label: '„Ç∏„Çß„É†Ôºü', code: 'robot.isGem()', isCondition: true, category: 'check' },
                { id: 'isGoal', icon: 'üèÅ', label: '„Ç¥„Éº„É´Ôºü', code: 'robot.isGoal()', isCondition: true, category: 'check' }
            ],
            control: [
                { id: 'if', icon: 'üîÄ', label: '„ÇÇ„Åó', code: 'if', isContainer: true, hasCondition: true, category: 'control' },
                { id: 'ifElse', icon: 'üîÄ', label: '„ÇÇ„Åó„Äú„Åß„Å™„Åë„Çå„Å∞', code: 'ifElse', isContainer: true, hasCondition: true, hasElse: true, category: 'control' }
            ],
            loop: [
                { id: 'repeat', icon: 'üîÑ', label: 'Áπ∞„ÇäËøî„Åô', code: 'for', isContainer: true, hasCount: true, defaultCount: 3, category: 'loop' },
                { id: 'while', icon: 'üîÅ', label: '„Äú„ÅÆÈñì', code: 'while', isContainer: true, hasCondition: true, category: 'loop' }
            ]
        };
        
        // Condition options for dropdowns
        const conditionOptions = [
            { value: 'robot.isObstacle()', label: 'ÈöúÂÆ≥Áâ©„Åå„ÅÇ„Çã' },
            { value: '!robot.isObstacle()', label: 'ÈöúÂÆ≥Áâ©„Åå„Å™„ÅÑ' },
            { value: 'robot.isStar()', label: 'Êòü„Åå„ÅÇ„Çã' },
            { value: 'robot.isGem()', label: '„Ç∏„Çß„É†„Åå„ÅÇ„Çã' },
            { value: 'robot.isGoal()', label: '„Ç¥„Éº„É´„Å´„ÅÑ„Çã' },
            { value: '!robot.isGoal()', label: '„Ç¥„Éº„É´„Åò„ÇÉ„Å™„ÅÑ' }
        ];
        
        // Initialize block palette
        function initBlockPalette() {
            renderBlockList('motion');
            
            document.querySelectorAll('.palette-category').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.palette-category').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentBlockCategory = btn.dataset.category;
                    renderBlockList(currentBlockCategory);
                });
            });
        }
        
        // Render blocks in the palette list
        function renderBlockList(category) {
            const blockList = document.getElementById('blockList');
            blockList.innerHTML = '';
            
            const blocks = blockDefinitions[category] || [];
            
            blocks.forEach(blockDef => {
                if (!blockDef.isCondition) { // Don't show condition-only blocks in palette
                    const block = createPaletteBlock(blockDef);
                    blockList.appendChild(block);
                }
            });
        }
        
        // Create a palette block (draggable source)
        function createPaletteBlock(blockDef) {
            const block = document.createElement('div');
            block.className = `block ${blockDef.category}`;
            block.dataset.blockId = blockDef.id;
            block.dataset.category = blockDef.category;
            
            if (blockDef.isContainer) {
                block.innerHTML = `<span class="icon">${blockDef.icon}</span><span>${blockDef.label}</span>`;
                if (blockDef.hasCount) {
                    block.innerHTML += ` <span style="opacity:0.7">[n]Âõû</span>`;
                }
            } else {
                block.innerHTML = `<span class="icon">${blockDef.icon}</span><span>${blockDef.label}</span>`;
            }
            
            // Mouse down - start drag
            block.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startDrag(e, blockDef);
            });
            
            // Touch support
            block.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                startDrag({ clientX: touch.clientX, clientY: touch.clientY }, blockDef);
            });
            
            return block;
        }
        
        // Start dragging
        function startDrag(e, blockDef) {
            isDragging = true;
            draggedBlock = blockDef;
            
            // Create drag clone
            dragClone = document.createElement('div');
            dragClone.className = `block ${blockDef.category}`;
            dragClone.style.position = 'fixed';
            dragClone.style.pointerEvents = 'none';
            dragClone.style.zIndex = '10000';
            dragClone.style.opacity = '0.85';
            dragClone.style.transform = 'scale(0.9)';
            dragClone.style.fontSize = '0.7rem';
            dragClone.style.padding = '0.35rem 0.5rem';
            dragClone.innerHTML = `<span class="icon">${blockDef.icon}</span><span>${blockDef.label}</span>`;
            
            document.body.appendChild(dragClone);
            updateDragPosition(e.clientX, e.clientY);
            
            // Add move listeners
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('mouseup', onDragEnd);
            document.addEventListener('touchmove', onTouchMove);
            document.addEventListener('touchend', onDragEnd);
        }
        
        function updateDragPosition(x, y) {
            if (dragClone) {
                dragClone.style.left = (x - 40) + 'px';
                dragClone.style.top = (y - 12) + 'px';
            }
        }
        
        function onDragMove(e) {
            if (isDragging) {
                updateDragPosition(e.clientX, e.clientY);
                highlightDropZone(e.clientX, e.clientY);
            }
        }
        
        function onTouchMove(e) {
            if (isDragging && e.touches[0]) {
                const touch = e.touches[0];
                updateDragPosition(touch.clientX, touch.clientY);
                highlightDropZone(touch.clientX, touch.clientY);
            }
        }
        
        function highlightDropZone(x, y) {
            const wrapper = document.querySelector('.block-workspace-wrapper');
            const workspace = document.getElementById('blockWorkspace');
            const rect = wrapper.getBoundingClientRect();
            
            if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                workspace.style.background = 'rgba(0, 245, 255, 0.1)';
                wrapper.style.borderColor = 'var(--accent-primary)';
            } else {
                workspace.style.background = '';
                wrapper.style.borderColor = '';
            }
        }
        
        function onDragEnd(e) {
            if (!isDragging) return;
            
            const clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
            const clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
            
            const wrapper = document.querySelector('.block-workspace-wrapper');
            const workspace = document.getElementById('blockWorkspace');
            const rect = wrapper.getBoundingClientRect();
            
            // Check if dropped in workspace
            if (clientX >= rect.left && clientX <= rect.right && 
                clientY >= rect.top && clientY <= rect.bottom) {
                
                // Find if dropped inside a container body
                const dropTarget = findDropTarget(clientX, clientY);
                addBlockToWorkspace(draggedBlock, dropTarget);
            }
            
            // Cleanup
            if (dragClone) {
                dragClone.remove();
                dragClone = null;
            }
            
            workspace.style.background = '';
            wrapper.style.borderColor = '';
            
            isDragging = false;
            draggedBlock = null;
            
            document.removeEventListener('mousemove', onDragMove);
            document.removeEventListener('mouseup', onDragEnd);
            document.removeEventListener('touchmove', onTouchMove);
            document.removeEventListener('touchend', onDragEnd);
        }
        
        function findDropTarget(x, y) {
            const bodies = document.querySelectorAll('#blockWorkspace .block-body');
            for (const body of bodies) {
                const rect = body.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    return body;
                }
            }
            return null;
        }
        
        // Add block to workspace
        function addBlockToWorkspace(blockDef, dropTarget) {
            const workspace = document.getElementById('blockWorkspace');
            const block = createWorkspaceBlock(blockDef);
            
            if (dropTarget) {
                dropTarget.appendChild(block);
            } else {
                workspace.appendChild(block);
            }
            
            updateWorkspaceHint();
            generateCodeFromBlocks();
        }
        
        // Create a workspace block (the actual block in workspace)
        function createWorkspaceBlock(blockDef) {
            const wrapper = document.createElement('div');
            wrapper.className = 'workspace-block';
            wrapper.dataset.blockId = blockDef.id;
            wrapper.dataset.category = blockDef.category;
            wrapper.dataset.code = blockDef.code;
            
            if (blockDef.isContainer) {
                wrapper.classList.add('container-block');
                
                // Header
                const header = document.createElement('div');
                header.className = `block ${blockDef.category}`;
                header.style.borderRadius = '8px 8px 0 0';
                header.style.marginBottom = '0';
                
                let headerContent = `<span class="icon">${blockDef.icon}</span><span>${blockDef.label}</span>`;
                
                if (blockDef.hasCount) {
                    headerContent += ` <input type="number" class="block-input" value="${blockDef.defaultCount || 3}" min="1" max="99" data-type="count"> Âõû`;
                }
                
                if (blockDef.hasCondition) {
                    headerContent += ` <select class="block-select" data-type="condition">`;
                    conditionOptions.forEach(opt => {
                        headerContent += `<option value="${opt.value}">${opt.label}</option>`;
                    });
                    headerContent += `</select>`;
                }
                
                header.innerHTML = headerContent;
                wrapper.appendChild(header);
                
                // Body
                const body = document.createElement('div');
                body.className = 'block-body';
                body.dataset.dropzone = 'true';
                body.style.borderLeftColor = getBlockColor(blockDef.category);
                wrapper.appendChild(body);
                
                // Else section if needed
                if (blockDef.hasElse) {
                    const elseHeader = document.createElement('div');
                    elseHeader.className = `block ${blockDef.category}`;
                    elseHeader.style.borderRadius = '0';
                    elseHeader.style.marginBottom = '0';
                    elseHeader.innerHTML = `<span class="icon">‚Ü™Ô∏è</span><span>„Åß„Å™„Åë„Çå„Å∞</span>`;
                    wrapper.appendChild(elseHeader);
                    
                    const elseBody = document.createElement('div');
                    elseBody.className = 'block-body';
                    elseBody.dataset.dropzone = 'true';
                    elseBody.dataset.isElse = 'true';
                    elseBody.style.borderLeftColor = getBlockColor(blockDef.category);
                    wrapper.appendChild(elseBody);
                }
                
                // Footer
                const footer = document.createElement('div');
                footer.className = 'block-footer';
                footer.style.borderLeftColor = getBlockColor(blockDef.category);
                footer.style.borderBottomColor = getBlockColor(blockDef.category);
                wrapper.appendChild(footer);
                
            } else {
                const block = document.createElement('div');
                block.className = `block ${blockDef.category}`;
                block.innerHTML = `<span class="icon">${blockDef.icon}</span><span>${blockDef.label}</span>`;
                wrapper.appendChild(block);
            }
            
            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '√ó';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                wrapper.remove();
                updateWorkspaceHint();
                generateCodeFromBlocks();
            });
            wrapper.appendChild(deleteBtn);
            
            // Add input change listeners
            wrapper.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('change', generateCodeFromBlocks);
                input.addEventListener('input', generateCodeFromBlocks);
            });
            
            return wrapper;
        }
        
        function getBlockColor(category) {
            const colors = {
                motion: '#4C97FF',
                collect: '#59C059',
                check: '#FF8C1A',
                control: '#FFAB19',
                loop: '#9966FF'
            };
            return colors[category] || '#666';
        }
        
        // Initialize workspace
        function initBlockWorkspace() {
            // Workspace is initialized via event listeners in startDrag/onDragEnd
        }
        
        function updateWorkspaceHint() {
            const workspace = document.getElementById('blockWorkspace');
            const hint = document.getElementById('workspaceHint');
            const hasBlocks = workspace.querySelectorAll('.workspace-block').length > 0;
            hint.classList.toggle('hidden', hasBlocks);
        }
        
        // Generate JavaScript code from blocks
        function generateCodeFromBlocks() {
            const workspace = document.getElementById('blockWorkspace');
            const blocks = workspace.querySelectorAll(':scope > .workspace-block');
            
            let code = '';
            blocks.forEach(block => {
                code += generateBlockCode(block, 0);
            });
            
            // Update the code editor and preview
            document.getElementById('codeInput').value = code;
            document.getElementById('generatedCodePre').textContent = code || '// „Éñ„É≠„ÉÉ„ÇØ„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶„Éó„É≠„Ç∞„É©„É†„Çí‰Ωú„Çç„ÅÜÔºÅ';
            updateLineNumbers();
        }
        
        function generateBlockCode(wrapper, indent) {
            const indentStr = '  '.repeat(indent);
            const blockId = wrapper.dataset.blockId;
            const blockCode = wrapper.dataset.code;
            
            // Find block definition
            let blockDef = null;
            for (const category in blockDefinitions) {
                const found = blockDefinitions[category].find(b => b.id === blockId);
                if (found) {
                    blockDef = found;
                    break;
                }
            }
            
            if (!blockDef) return '';
            
            if (blockDef.isContainer) {
                let code = '';
                
                if (blockDef.hasCount) {
                    // For loop
                    const countInput = wrapper.querySelector('input[data-type="count"]');
                    const count = countInput ? countInput.value : 3;
                    code += `${indentStr}for (let i = 0; i < ${count}; i++) {\n`;
                } else if (blockDef.hasCondition) {
                    // If or While
                    const conditionSelect = wrapper.querySelector('select[data-type="condition"]');
                    const condition = conditionSelect ? conditionSelect.value : 'true';
                    
                    if (blockCode === 'if' || blockCode === 'ifElse') {
                        code += `${indentStr}if (${condition}) {\n`;
                    } else {
                        code += `${indentStr}while (${condition}) {\n`;
                    }
                }
                
                // Process body blocks
                const bodies = wrapper.querySelectorAll(':scope > .block-body');
                if (bodies[0]) {
                    const bodyBlocks = bodies[0].querySelectorAll(':scope > .workspace-block');
                    bodyBlocks.forEach(childBlock => {
                        code += generateBlockCode(childBlock, indent + 1);
                    });
                }
                
                code += `${indentStr}}\n`;
                
                // Handle else block
                if (blockDef.hasElse && bodies[1]) {
                    code = code.slice(0, -1); // Remove last newline
                    code += ` else {\n`;
                    const elseBlocks = bodies[1].querySelectorAll(':scope > .workspace-block');
                    elseBlocks.forEach(childBlock => {
                        code += generateBlockCode(childBlock, indent + 1);
                    });
                    code += `${indentStr}}\n`;
                }
                
                return code;
            } else {
                return `${indentStr}${blockCode}\n`;
            }
        }
        
        // Mode toggle handlers
        function switchToCodeMode() {
            currentEditorMode = 'code';
            document.getElementById('codeModeBtn').classList.add('active');
            document.getElementById('blockModeBtn').classList.remove('active');
            document.getElementById('codeEditorWrapper').classList.remove('hidden');
            document.getElementById('blockEditor').classList.remove('active');
        }
        
        function switchToBlockMode() {
            currentEditorMode = 'block';
            document.getElementById('blockModeBtn').classList.add('active');
            document.getElementById('codeModeBtn').classList.remove('active');
            document.getElementById('codeEditorWrapper').classList.add('hidden');
            document.getElementById('blockEditor').classList.add('active');
            document.getElementById('generatedCode').classList.add('show');
            generateCodeFromBlocks();
        }
        
        // Clear block workspace
        function clearBlockWorkspace() {
            const workspace = document.getElementById('blockWorkspace');
            const blocks = workspace.querySelectorAll('.workspace-block');
            blocks.forEach(block => block.remove());
            updateWorkspaceHint();
            document.getElementById('generatedCodePre').textContent = '// „Éñ„É≠„ÉÉ„ÇØ„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶„Éó„É≠„Ç∞„É©„É†„Çí‰Ωú„Çç„ÅÜÔºÅ';
        }
        
        // Zoom functions
        function setBlockZoom(zoom) {
            blockZoom = Math.max(50, Math.min(150, zoom)); // Limit 50% - 150%
            const workspace = document.getElementById('blockWorkspace');
            workspace.style.transform = `scale(${blockZoom / 100})`;
            document.getElementById('zoomLevel').textContent = blockZoom + '%';
            
            // Adjust workspace size to fit scaled content
            const wrapper = document.querySelector('.block-workspace-wrapper');
            if (wrapper) {
                workspace.style.minWidth = (100 / (blockZoom / 100)) + '%';
                workspace.style.minHeight = (100 / (blockZoom / 100)) + '%';
            }
        }
        
        function zoomIn() {
            setBlockZoom(blockZoom + 10);
        }
        
        function zoomOut() {
            setBlockZoom(blockZoom - 10);
        }

        // ===== EVENT HANDLERS =====
        document.getElementById('runBtn').addEventListener('click', async () => {
            const code = document.getElementById('codeInput').value;
            clearLog();
            robot.reset();
            collectedStarsInLevel.clear();
            collectedGemsInLevel.clear();
            drawCanvas();
            
            try {
                log('üöÄ „Ç≥„Éº„Éâ„ÇíÂÆüË°å‰∏≠...');
                
                // Execute user code
                const wrappedCode = `
                    (function() {
                        ${code}
                    })();
                `;
                eval(wrappedCode);
                
                await animateRobot();
                
                const level = levels[currentLevelIndex];
                if (level.validate(robot)) {
                    // Calculate stars
                    const codeLength = code.replace(/\s+/g, '').length;
                    let starsEarned = 1;
                    if (codeLength < 200) starsEarned = 2;
                    if (codeLength < 100) starsEarned = 3;
                    
                    // Update progress
                    const isNewCompletion = !completedLevels.has(level.id);
                    const isStarsImproved = !levelStars[level.id] || levelStars[level.id] < starsEarned;
                    
                    if (isNewCompletion) {
                        completedLevels.add(level.id);
                    }
                    
                    // Track completion mode
                    const currentMode = currentEditorMode; // 'code' or 'block'
                    const previousMode = levelCompletionMode[level.id];
                    
                    if (!previousMode) {
                        // First time completion
                        levelCompletionMode[level.id] = currentMode;
                    } else if (previousMode !== currentMode && previousMode !== 'both') {
                        // Completed in different mode - now both!
                        levelCompletionMode[level.id] = 'both';
                    }
                    
                    if (isStarsImproved) {
                        totalStarsEarned += starsEarned - (levelStars[level.id] || 0);
                        levelStars[level.id] = starsEarned;
                    }
                    
                    // „ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠òÔºàÊñ∞Ë¶è„ÇØ„É™„Ç¢„Åæ„Åü„ÅØÊòü„ÅåÂ¢ó„Åà„ÅüÂ†¥ÂêàÔºâ
                    if (isNewCompletion || isStarsImproved) {
                        saveProgressToCloud(level.id, starsEarned);
                    }
                    
                    updateStats();
                    updateLevelButtons();
                    
                    setTimeout(() => showLevelComplete(starsEarned), 500);
                } else {
                    updateStats();
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    errorDiv.textContent = '‚ùå „Ç¥„Éº„É´„Å´Âà∞ÈÅî„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶!';
                    output.appendChild(errorDiv);
                }
            } catch (error) {
                updateStats();
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = '‚ùå „Ç®„É©„Éº: ' + error.message;
                output.appendChild(errorDiv);
            }
        });

        document.getElementById('hintBtn').addEventListener('click', () => {
            const hintBox = document.getElementById('hintBox');
            const level = levels[currentLevelIndex];
            hintBox.innerHTML = `<strong>üí° „Éí„É≥„Éà:</strong><code>${level.hint}</code>`;
            hintBox.classList.toggle('show');
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            loadLevel(currentLevelIndex);
        });

        document.getElementById('nextLevelBtn').addEventListener('click', () => {
            document.getElementById('levelCompleteModal').classList.remove('show');
            if (currentLevelIndex < levels.length - 1) {
                loadLevel(currentLevelIndex + 1);
            }
        });

        document.querySelectorAll('.world-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentWorld = parseInt(btn.dataset.world);
                const worldLevels = getWorldLevels(currentWorld);
                const firstLevelIndex = levels.findIndex(l => l.id === worldLevels[0].id);
                loadLevel(firstLevelIndex);
            });
        });

        document.getElementById('codeInput').addEventListener('input', updateLineNumbers);
        document.getElementById('codeInput').addEventListener('scroll', function() {
            document.getElementById('lineNumbers').scrollTop = this.scrollTop;
        });

        // Initialize
        loadSavedPreferences();
        initCharacterSelector();
        loadLevel(0);
        
        // Initialize Block Mode
        initBlockPalette();
        initBlockWorkspace();
        
        // Block Mode Toggle
        document.getElementById('codeModeBtn').addEventListener('click', switchToCodeMode);
        document.getElementById('blockModeBtn').addEventListener('click', switchToBlockMode);
        
        // Zoom Controls
        document.getElementById('zoomInBtn').addEventListener('click', zoomIn);
        document.getElementById('zoomOutBtn').addEventListener('click', zoomOut);
        
        // Mouse wheel zoom in workspace
        document.querySelector('.block-workspace-wrapper')?.addEventListener('wheel', (e) => {
            if (e.ctrlKey) {
                e.preventDefault();
                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }
            }
        }, { passive: false });
        
        // Theme Toggle
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        
        // Character Selector
        const characterBtn = document.getElementById('characterBtn');
        const characterModal = document.getElementById('characterModal');
        const closeCharacterModal = document.getElementById('closeCharacterModal');
        
        characterBtn.addEventListener('click', () => {
            initCharacterSelector();
            characterModal.classList.add('show');
        });
        
        closeCharacterModal.addEventListener('click', () => {
            characterModal.classList.remove('show');
        });
        
        characterModal.addEventListener('click', (e) => {
            if (e.target === characterModal) {
                characterModal.classList.remove('show');
            }
        });
        
        // Quick Reference Panel Toggle
        const floatingHelpBtn = document.getElementById('floatingHelpBtn');
        const quickRefPanel = document.getElementById('quickRefPanel');
        const closeQuickRef = document.getElementById('closeQuickRef');
        
        floatingHelpBtn.addEventListener('click', () => {
            quickRefPanel.classList.toggle('open');
            floatingHelpBtn.classList.toggle('active');
        });
        
        closeQuickRef.addEventListener('click', () => {
            quickRefPanel.classList.remove('open');
            floatingHelpBtn.classList.remove('active');
        });
        
        // ===== AUTH MODAL SETUP =====
        const authModal = document.getElementById('authModal');
        const closeAuthModal = document.getElementById('closeAuthModal');
        const authTabs = document.querySelectorAll('.auth-tab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        closeAuthModal.addEventListener('click', () => {
            authModal.classList.remove('show');
            document.getElementById('authError').classList.remove('show');
            document.getElementById('authSuccess').classList.remove('show');
        });
        
        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„Åß„ÅØÈñâ„Åò„Å™„ÅÑÔºà‚úï„Éú„Çø„É≥„Åß„ÅÆ„ÅøÈñâ„Åò„ÇãÔºâ
        // authModal.addEventListener('click', (e) => {
        //     if (e.target === authModal) {
        //         authModal.classList.remove('show');
        //     }
        // });
        
        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        authTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                authTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.getElementById('authError').classList.remove('show');
                document.getElementById('authSuccess').classList.remove('show');
                
                if (tab.dataset.tab === 'login') {
                    loginForm.classList.add('active');
                    registerForm.classList.remove('active');
                } else {
                    loginForm.classList.remove('active');
                    registerForm.classList.add('active');
                }
            });
        });
        
        // „É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É†ÈÄÅ‰ø°
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const btn = loginForm.querySelector('.auth-btn');
            btn.disabled = true;
            btn.textContent = '„É≠„Ç∞„Ç§„É≥‰∏≠...';
            
            await handleLogin(email, password);
            
            btn.disabled = false;
            btn.textContent = '„É≠„Ç∞„Ç§„É≥';
        });
        
        // ÁôªÈå≤„Éï„Ç©„Éº„É†ÈÄÅ‰ø°
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nickname = document.getElementById('registerNickname').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            const btn = registerForm.querySelector('.auth-btn');
            btn.disabled = true;
            btn.textContent = 'ÁôªÈå≤‰∏≠...';
            
            await handleRegister(email, password, nickname);
            
            btn.disabled = false;
            btn.textContent = '„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê';
        });
        
        // Google„É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥
        document.getElementById('googleLoginBtn').addEventListener('click', async () => {
            const btn = document.getElementById('googleLoginBtn');
            btn.disabled = true;
            btn.textContent = '„É™„ÉÄ„Ç§„É¨„ÇØ„Éà‰∏≠...';
            
            await handleGoogleLogin();
            
            btn.disabled = false;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Google„Åß„É≠„Ç∞„Ç§„É≥
            `;
        });
        
        // „Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„ÅüÊñπ„É™„É≥„ÇØ
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const backToLoginBtn = document.getElementById('backToLoginBtn');
        const authTabsContainer = document.querySelector('.auth-tabs');
        const authDivider = document.querySelector('.auth-divider');
        const googleBtn = document.getElementById('googleLoginBtn');
        
        forgotPasswordBtn.addEventListener('click', () => {
            loginForm.classList.remove('active');
            registerForm.classList.remove('active');
            forgotPasswordForm.classList.add('active');
            authTabsContainer.style.display = 'none';
            authDivider.style.display = 'none';
            googleBtn.style.display = 'none';
            document.getElementById('authError').classList.remove('show');
            document.getElementById('authSuccess').classList.remove('show');
        });
        
        backToLoginBtn.addEventListener('click', () => {
            forgotPasswordForm.classList.remove('active');
            loginForm.classList.add('active');
            authTabsContainer.style.display = 'flex';
            authDivider.style.display = 'flex';
            googleBtn.style.display = 'flex';
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.auth-tab[data-tab="login"]').classList.add('active');
            document.getElementById('authError').classList.remove('show');
            document.getElementById('authSuccess').classList.remove('show');
        });
        
        // „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„Éï„Ç©„Éº„É†ÈÄÅ‰ø°
        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;
            
            const btn = forgotPasswordForm.querySelector('.auth-btn');
            btn.disabled = true;
            btn.textContent = 'ÈÄÅ‰ø°‰∏≠...';
            
            await handlePasswordReset(email);
            
            btn.disabled = false;
            btn.textContent = '„É™„Çª„ÉÉ„Éà„É™„É≥„ÇØ„ÇíÈÄÅ‰ø°';
        });
        
        // „Éë„Çπ„ÉØ„Éº„ÉâË°®Á§∫/ÈùûË°®Á§∫„Éà„Ç∞„É´
        document.querySelectorAll('.password-toggle').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.getAttribute('data-target');
                const input = document.getElementById(targetId);
                
                if (input.type === 'password') {
                    input.type = 'text';
                    btn.textContent = 'üôà';
                    btn.classList.add('showing');
                } else {
                    input.type = 'password';
                    btn.textContent = 'üëÅÔ∏è';
                    btn.classList.remove('showing');
                }
            });
        });
        
        // ===== SETTINGS MODAL =====
        const settingsModal = document.getElementById('settingsModal');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        
        // Ë®≠ÂÆö„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('show');
            updateSettingsStats();
        });
        
        // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        closeSettingsModal.addEventListener('click', () => {
            settingsModal.classList.remove('show');
            document.getElementById('settingsMessage').className = 'settings-message';
        });
        
        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„Åß„ÅØÈñâ„Åò„Å™„ÅÑÔºà‚úï„Éú„Çø„É≥„Åß„ÅÆ„ÅøÈñâ„Åò„ÇãÔºâ
        // settingsModal.addEventListener('click', (e) => {
        //     if (e.target === settingsModal) {
        //         settingsModal.classList.remove('show');
        //     }
        // });
        
        // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥ÔºàË®≠ÂÆöÁîªÈù¢„Åã„ÇâÔºâ
        document.getElementById('openLoginBtn').addEventListener('click', () => {
            settingsModal.classList.remove('show');
            document.getElementById('authModal').classList.add('show');
            // „É≠„Ç∞„Ç§„É≥„Çø„Éñ„ÇíÈÅ∏Êäû
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.auth-tab[data-tab="login"]').classList.add('active');
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('registerForm').classList.remove('active');
            document.getElementById('forgotPasswordForm').classList.remove('active');
            document.querySelector('.auth-tabs').style.display = 'flex';
            document.querySelector('.auth-divider').style.display = 'flex';
            document.getElementById('googleLoginBtn').style.display = 'flex';
        });
        
        // Êñ∞Ë¶èÁôªÈå≤„Éú„Çø„É≥ÔºàË®≠ÂÆöÁîªÈù¢„Åã„ÇâÔºâ
        document.getElementById('openRegisterBtn').addEventListener('click', () => {
            settingsModal.classList.remove('show');
            document.getElementById('authModal').classList.add('show');
            // ÁôªÈå≤„Çø„Éñ„ÇíÈÅ∏Êäû
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.auth-tab[data-tab="register"]').classList.add('active');
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('registerForm').classList.add('active');
            document.getElementById('forgotPasswordForm').classList.remove('active');
            document.querySelector('.auth-tabs').style.display = 'flex';
            document.querySelector('.auth-divider').style.display = 'flex';
            document.getElementById('googleLoginBtn').style.display = 'flex';
        });
        
        // „É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥ÔºàË®≠ÂÆöÁîªÈù¢„Åã„ÇâÔºâ
        document.getElementById('settingsLogoutBtn').addEventListener('click', async () => {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                await handleLogout();
                showSettingsMessage('success', '„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü');
            }
        });
        
        // „Éã„ÉÉ„ÇØ„Éç„Éº„É†‰øùÂ≠ò
        document.getElementById('saveNicknameBtn').addEventListener('click', async () => {
            const newNickname = document.getElementById('settingsNickname').value.trim();
            if (!newNickname) {
                showSettingsMessage('error', '„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (!supabaseClient || !currentUser) {
                showSettingsMessage('error', '„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ nickname: newNickname })
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                userProfile.nickname = newNickname;
                updateAuthUI();
                showSettingsMessage('success', '„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
            } catch (error) {
                showSettingsMessage('error', '„Ç®„É©„Éº: ' + error.message);
            }
        });
        
        // „É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÂ§âÊõ¥
        document.getElementById('saveEmailBtn').addEventListener('click', async () => {
            const newEmail = document.getElementById('settingsEmail').value.trim();
            if (!newEmail) {
                showSettingsMessage('error', '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (!supabaseClient || !currentUser) {
                showSettingsMessage('error', '„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            try {
                const { error } = await supabaseClient.auth.updateUser({
                    email: newEmail
                });
                
                if (error) throw error;
                
                showSettingsMessage('success', 'Á¢∫Ë™ç„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„É°„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } catch (error) {
                showSettingsMessage('error', '„Ç®„É©„Éº: ' + error.message);
            }
        });
        
        // „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥ÁîªÈù¢Ë°®Á§∫
        document.getElementById('changePasswordBtn').addEventListener('click', () => {
            document.getElementById('settingsLoggedIn').style.display = 'none';
            document.getElementById('settingsPasswordChange').style.display = 'block';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        });
        
        // „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥„Ç≠„É£„É≥„Çª„É´
        document.getElementById('cancelPasswordChangeBtn').addEventListener('click', () => {
            document.getElementById('settingsPasswordChange').style.display = 'none';
            document.getElementById('settingsLoggedIn').style.display = 'block';
        });
        
        // „Éë„Çπ„ÉØ„Éº„Éâ‰øùÂ≠ò
        document.getElementById('savePasswordBtn').addEventListener('click', async () => {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword.length < 6) {
                showSettingsMessage('error', '„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showSettingsMessage('error', '„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì');
                return;
            }
            
            if (!supabaseClient || !currentUser) {
                showSettingsMessage('error', '„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            try {
                const { error } = await supabaseClient.auth.updateUser({
                    password: newPassword
                });
                
                if (error) throw error;
                
                document.getElementById('settingsPasswordChange').style.display = 'none';
                document.getElementById('settingsLoggedIn').style.display = 'block';
                showSettingsMessage('success', '„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü');
            } catch (error) {
                showSettingsMessage('error', '„Ç®„É©„Éº: ' + error.message);
            }
        });
        
        // SupabaseÂàùÊúüÂåñ
        initSupabase();
    </script>
</body>
</html>