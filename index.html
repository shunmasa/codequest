<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeQuest 道場 - JavaScript冒険</title>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Fredoka:wght@600;700&family=Nunito:wght@400;700&display=swap');

        :root {
            /* Aurora Borealis Theme */
            --bg-primary: #0a1520;
            --bg-secondary: #0f1d2d;
            --bg-tertiary: #162538;
            --bg-card: #121f30;
            --accent-primary: #00d4aa;
            --accent-secondary: #ff6b9d;
            --accent-tertiary: #7c5cff;
            --accent-success: #4ade80;
            --accent-warning: #fbbf24;
            --accent-orange: #fb923c;
            --text-primary: #e2f1e7;
            --text-secondary: #94a8b3;
            --text-code: #6ee7b7;
            --glow-primary: rgba(0, 212, 170, 0.5);
            --glow-secondary: rgba(124, 92, 255, 0.5);
            --aurora-green: #00d4aa;
            --aurora-teal: #14b8a6;
            --aurora-blue: #3b82f6;
            --aurora-purple: #8b5cf6;
            --aurora-pink: #ec4899;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Off Theme - Pure Black Background Only */
        body.theme-off {
            background: #000000;
        }

        body.theme-off::before {
            display: none !important;
        }

        /* Aurora Borealis Background - Theme 1 */
        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        /* Aurora waves container */
        .starfield::before {
            content: '';
            position: absolute;
            top: 0;
            left: -50%;
            width: 200%;
            height: 60%;
            background:
                linear-gradient(180deg,
                    transparent 0%,
                    rgba(0, 212, 170, 0.03) 20%,
                    rgba(0, 212, 170, 0.08) 35%,
                    rgba(20, 184, 166, 0.12) 45%,
                    rgba(59, 130, 246, 0.1) 55%,
                    rgba(139, 92, 246, 0.08) 65%,
                    rgba(236, 72, 153, 0.05) 75%,
                    transparent 100%
                );
            filter: blur(40px);
            animation: auroraWave 12s ease-in-out infinite;
            transform-origin: center top;
        }

        .starfield::after {
            content: '';
            position: absolute;
            top: 5%;
            left: -30%;
            width: 160%;
            height: 50%;
            background:
                linear-gradient(180deg,
                    transparent 0%,
                    rgba(139, 92, 246, 0.05) 25%,
                    rgba(59, 130, 246, 0.1) 40%,
                    rgba(0, 212, 170, 0.15) 50%,
                    rgba(20, 184, 166, 0.1) 60%,
                    rgba(139, 92, 246, 0.06) 75%,
                    transparent 100%
                );
            filter: blur(50px);
            animation: auroraWave2 15s ease-in-out infinite;
            transform-origin: center top;
        }

        @keyframes auroraWave {
            0%, 100% {
                transform: translateX(0%) skewX(0deg) scaleY(1);
                opacity: 0.7;
            }
            25% {
                transform: translateX(5%) skewX(-3deg) scaleY(1.1);
                opacity: 0.9;
            }
            50% {
                transform: translateX(-3%) skewX(2deg) scaleY(0.95);
                opacity: 0.8;
            }
            75% {
                transform: translateX(4%) skewX(-2deg) scaleY(1.05);
                opacity: 1;
            }
        }

        @keyframes auroraWave2 {
            0%, 100% {
                transform: translateX(0%) skewX(0deg) scaleY(1);
                opacity: 0.6;
            }
            33% {
                transform: translateX(-4%) skewX(3deg) scaleY(1.15);
                opacity: 0.85;
            }
            66% {
                transform: translateX(6%) skewX(-2deg) scaleY(0.9);
                opacity: 0.75;
            }
        }

        /* Nebula background - Theme 2 (Aurora variant) */
        .nebula-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            display: none;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(0, 212, 170, 0.2) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 30%, rgba(59, 130, 246, 0.18) 0%, transparent 45%),
                radial-gradient(ellipse at 60% 70%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 10% 60%, rgba(20, 184, 166, 0.12) 0%, transparent 40%);
            animation: nebulaMove 20s ease-in-out infinite;
        }

        @keyframes nebulaMove {
            0%, 100% {
                background-position: 0% 0%, 100% 0%, 50% 100%, 0% 50%;
            }
            25% {
                background-position: 10% 20%, 90% 10%, 60% 90%, 5% 60%;
            }
            50% {
                background-position: 20% 10%, 80% 20%, 40% 80%, 10% 40%;
            }
            75% {
                background-position: 5% 15%, 95% 5%, 55% 95%, 2% 55%;
            }
        }

        .nebula-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,0.9), transparent),
                radial-gradient(2px 2px at 40% 70%, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 90% 40%, rgba(255,255,255,0.5), transparent),
                radial-gradient(2px 2px at 60% 20%, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 30% 80%, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 70% 60%, rgba(255,255,255,0.4), transparent),
                radial-gradient(1px 1px at 80% 90%, rgba(255,255,255,0.7), transparent),
                radial-gradient(2px 2px at 10% 50%, rgba(255,255,255,0.5), transparent);
            background-size: 100% 100%;
            animation: twinkleStars 4s ease-in-out infinite;
        }

        @keyframes twinkleStars {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Universe background - Theme 3 (Aurora intense) */
        .universe-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            display: none;
            background: linear-gradient(180deg,
                #000000 0%,
                #050005 30%,
                #0a000a 50%,
                #050005 70%,
                #000000 100%);
            overflow: hidden;
        }

        /* Stars */
        .universe-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 55%;
            background-image:
                radial-gradient(1px 1px at 10% 10%, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 20% 25%, rgba(255,255,255,0.6), transparent),
                radial-gradient(1.5px 1.5px at 35% 8%, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 50% 15%, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 65% 20%, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 80% 12%, rgba(255,255,255,0.6), transparent),
                radial-gradient(1.5px 1.5px at 90% 30%, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 15% 35%, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 45% 40%, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 75% 38%, rgba(255,255,255,0.7), transparent),
                radial-gradient(2px 2px at 55% 5%, rgba(255,255,255,0.95), transparent),
                radial-gradient(1px 1px at 25% 45%, rgba(255,255,255,0.5), transparent);
        }

        /* Horizon sky glow */
        .universe-bg::after {
            content: '';
            position: absolute;
            top: 35%;
            left: 0;
            width: 100%;
            height: 25%;
            background: radial-gradient(ellipse 60% 100% at 50% 100%,
                rgba(200, 0, 100, 0.25) 0%,
                rgba(150, 0, 80, 0.15) 40%,
                transparent 70%);
            filter: blur(30px);
        }

        @keyframes arcPulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        /* Universe grid floor - Red/Purple */
        .universe-grid {
            position: absolute;
            bottom: 0;
            left: -100%;
            width: 300%;
            height: 45%;
            background:
                linear-gradient(90deg, transparent 0%, rgba(255, 0, 100, 0.5) 1px, transparent 1px),
                linear-gradient(0deg, transparent 0%, rgba(200, 0, 150, 0.4) 1px, transparent 1px);
            background-size: 80px 40px;
            transform: perspective(300px) rotateX(75deg);
            transform-origin: center top;
            animation: universeGridMove 4s linear infinite;
        }

        @keyframes universeGridMove {
            0% { background-position: 0 0; }
            100% { background-position: 0 40px; }
        }

        /* Bright red-purple horizon line */
        .universe-glow {
            position: absolute;
            bottom: 40%;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg,
                rgba(200, 0, 80, 0.2) 0%,
                rgba(255, 0, 120, 1) 50%,
                rgba(200, 0, 80, 0.2) 100%);
            box-shadow:
                0 0 10px rgba(255, 0, 100, 1),
                0 0 30px rgba(255, 0, 100, 0.8),
                0 0 60px rgba(200, 0, 150, 0.6),
                0 0 100px rgba(150, 0, 100, 0.4),
                0 -30px 80px rgba(200, 0, 100, 0.3);
        }

        /* Mountains silhouette */
        .universe-mountains {
            position: absolute;
            bottom: 40%;
            left: 0;
            width: 100%;
            height: 150px;
            background: #000000;
            clip-path: polygon(
                0% 100%,
                0% 80%,
                8% 60%,
                15% 75%,
                22% 45%,
                30% 65%,
                38% 35%,
                45% 55%,
                50% 40%,
                55% 55%,
                62% 35%,
                70% 65%,
                78% 45%,
                85% 75%,
                92% 60%,
                100% 80%,
                100% 100%
            );
        }

        .star {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 1;
            }
        }

        /* Realistic Aurora - Theme 4 */
        .realistic-aurora {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            display: none;
            background: linear-gradient(180deg, #000515 0%, #001030 40%, #002060 70%, #003080 100%);
            overflow: hidden;
        }

        /* Stars layer */
        .realistic-aurora::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50%;
            background-image:
                radial-gradient(1px 1px at 10% 15%, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 25% 25%, rgba(255,255,255,0.6), transparent),
                radial-gradient(1.5px 1.5px at 40% 10%, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 55% 20%, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 70% 8%, rgba(255,255,255,0.7), transparent),
                radial-gradient(1.5px 1.5px at 85% 18%, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 15% 40%, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 35% 35%, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 60% 42%, rgba(255,255,255,0.7), transparent),
                radial-gradient(1.5px 1.5px at 80% 38%, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 50% 5%, rgba(255,255,255,0.95), transparent);
        }

        /* Center horizon glow */
        .aurora-curtain {
            position: absolute;
            bottom: 35%;
            left: 30%;
            width: 40%;
            height: 150px;
            background: radial-gradient(ellipse at center bottom, rgba(0, 180, 255, 0.6) 0%, rgba(0, 150, 255, 0.3) 30%, transparent 70%);
            filter: blur(30px);
        }

        /* Grid floor */
        .aurora-curtain-2 {
            position: absolute;
            bottom: 0;
            left: -100%;
            width: 300%;
            height: 40%;
            background:
                linear-gradient(90deg, transparent 0%, rgba(0, 200, 255, 0.5) 1px, transparent 1px),
                linear-gradient(0deg, transparent 0%, rgba(0, 200, 255, 0.35) 1px, transparent 1px);
            background-size: 80px 40px;
            transform: perspective(350px) rotateX(75deg);
            transform-origin: center top;
            animation: cyberGridMove 3s linear infinite;
        }

        @keyframes cyberGridMove {
            0% { background-position: 0 0; }
            100% { background-position: 0 40px; }
        }

        /* Left buildings */
        .aurora-curtain-3 {
            position: absolute;
            bottom: 35%;
            left: 0;
            width: 25%;
            height: 55%;
            background:
                linear-gradient(90deg,
                    rgba(0, 150, 255, 0.15) 0%,
                    transparent 100%
                );
        }

        .aurora-curtain-3::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                /* Building outlines - left side */
                linear-gradient(to right, rgba(0, 200, 255, 0.4) 1px, transparent 1px) 5% 0 / 15% 80% no-repeat,
                linear-gradient(to bottom, rgba(0, 200, 255, 0.4) 1px, transparent 1px) 5% 20% / 15% 1px no-repeat,
                linear-gradient(to right, rgba(0, 200, 255, 0.3) 1px, transparent 1px) 20% 0 / 12% 90% no-repeat,
                linear-gradient(to right, rgba(0, 200, 255, 0.5) 1px, transparent 1px) 8% 0 / 20% 70% no-repeat,
                linear-gradient(to right, rgba(0, 200, 255, 0.35) 1px, transparent 1px) 25% 0 / 18% 95% no-repeat,
                linear-gradient(to bottom, rgba(0, 200, 255, 0.3) 1px, transparent 1px) 8% 30% / 20% 1px no-repeat,
                linear-gradient(to right, rgba(0, 180, 255, 0.25) 1px, transparent 1px) 35% 0 / 10% 60% no-repeat;
        }

        /* Right buildings */
        .aurora-accent {
            position: absolute;
            bottom: 35%;
            right: 0;
            width: 25%;
            height: 55%;
            background:
                linear-gradient(270deg,
                    rgba(0, 150, 255, 0.15) 0%,
                    transparent 100%
                );
        }

        .aurora-accent::before {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background:
                /* Building outlines - right side */
                linear-gradient(to left, rgba(0, 200, 255, 0.4) 1px, transparent 1px) 95% 0 / 15% 85% no-repeat,
                linear-gradient(to left, rgba(0, 200, 255, 0.3) 1px, transparent 1px) 80% 0 / 12% 75% no-repeat,
                linear-gradient(to left, rgba(0, 200, 255, 0.5) 1px, transparent 1px) 88% 0 / 18% 90% no-repeat,
                linear-gradient(to bottom, rgba(0, 200, 255, 0.3) 1px, transparent 1px) 88% 10% / 18% 1px no-repeat,
                linear-gradient(to left, rgba(0, 200, 255, 0.35) 1px, transparent 1px) 72% 0 / 14% 65% no-repeat,
                linear-gradient(to left, rgba(0, 180, 255, 0.25) 1px, transparent 1px) 65% 0 / 10% 55% no-repeat;
        }

        /* Additional glow effects */
        .aurora-landscape {
            position: absolute;
            bottom: 35%;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg,
                rgba(0, 200, 255, 0.3) 0%,
                rgba(0, 220, 255, 0.8) 50%,
                rgba(0, 200, 255, 0.3) 100%);
            filter: blur(3px);
            box-shadow: 0 0 30px rgba(0, 200, 255, 0.5), 0 0 60px rgba(0, 200, 255, 0.3);
        }

        /* Futuristic Theme - Synthwave */
        .futuristic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            display: none;
            background: linear-gradient(180deg, #000010 0%, #000020 40%, #001030 70%, #002050 100%);
            overflow: hidden;
        }

        /* Stars */
        .glow-orbs {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            background-image:
                radial-gradient(1px 1px at 10% 10%, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 35% 15%, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 50% 25%, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 65% 8%, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 80% 20%, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 90% 35%, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 15% 45%, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 40% 40%, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 70% 50%, rgba(255,255,255,0.7), transparent),
                radial-gradient(2px 2px at 25% 5%, rgba(255,255,255,0.9), transparent),
                radial-gradient(2px 2px at 75% 12%, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 5% 25%, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 95% 45%, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 55% 5%, rgba(255,255,255,0.7), transparent);
        }

        /* Horizon glow */
        .cyber-lines {
            position: absolute;
            bottom: 40%;
            left: 0;
            width: 100%;
            height: 80px;
            background: linear-gradient(180deg, transparent 0%, rgba(0, 200, 255, 0.15) 50%, rgba(0, 200, 255, 0.3) 100%);
            filter: blur(20px);
        }

        /* Neon Grid Floor */
        .grid-floor {
            position: absolute;
            bottom: 0;
            left: -100%;
            width: 300%;
            height: 45%;
            background:
                linear-gradient(90deg, transparent 0%, rgba(0, 220, 255, 0.6) 1px, transparent 1px),
                linear-gradient(0deg, transparent 0%, rgba(0, 220, 255, 0.4) 1px, transparent 1px);
            background-size: 100px 50px;
            transform: perspective(300px) rotateX(75deg);
            transform-origin: center top;
            animation: gridMove 4s linear infinite;
        }

        @keyframes gridMove {
            0% { background-position: 0 0; }
            100% { background-position: 0 50px; }
        }

        /* Aurora glow overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 30% 10%, rgba(0, 212, 170, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 20%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(139, 92, 246, 0.06) 0%, transparent 60%);
            animation: auroraGlow 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes auroraGlow {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.85;
                transform: scale(1.02);
            }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            text-align: center;
            margin-bottom: 1.5rem;
            animation: fadeInDown 0.8s ease;
        }

        .logo-container {
            display: inline-block;
            position: relative;
        }

        h1 {
            font-family: 'Nunito', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--aurora-green) 0%, var(--aurora-teal) 25%, var(--aurora-blue) 50%, var(--aurora-purple) 75%, var(--aurora-pink) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% 200%;
            letter-spacing: 0.05em;
            position: relative;
            animation: logoGlow 3s ease-in-out infinite, auroraText 8s ease-in-out infinite;
        }

        @keyframes auroraText {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes logoGlow {

            0%,
            100% {
                filter: drop-shadow(0 0 20px var(--glow-primary)) drop-shadow(0 0 40px var(--glow-secondary));
            }

            50% {
                filter: drop-shadow(0 0 30px var(--glow-primary)) drop-shadow(0 0 60px var(--glow-secondary));
            }
        }

        .subtitle {
            font-family: 'Fredoka', sans-serif;
            color: var(--text-secondary);
            font-size: 1.1rem;
            letter-spacing: 0.3em;
            margin-top: 0.5rem;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: 20px;
            border: 1px solid rgba(0, 212, 170, 0.2);
        }

        .stat-icon {
            font-size: 1.2rem;
        }

        .stat-value {
            font-family: 'Nunito', sans-serif;
            color: var(--accent-primary);
            font-weight: 700;
        }

        .help-link {
            text-decoration: none;
            color: var(--accent-warning);
            border: 1px solid var(--accent-warning);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .help-link:hover {
            background: var(--accent-warning);
            color: var(--bg-primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 204, 0, 0.3);
        }

        .theme-toggle,
        .character-btn {
            cursor: pointer;
            border: 1px solid var(--accent-tertiary);
            color: var(--accent-tertiary);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover,
        .character-btn:hover {
            background: var(--accent-tertiary);
            color: var(--bg-primary);
            transform: translateY(-2px);
        }

        /* Character Selector Modal */
        .character-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .character-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .character-modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 20px 60px rgba(0, 212, 170, 0.3);
        }

        .character-modal h2 {
            font-family: 'Nunito', sans-serif;
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .character-card {
            background: var(--bg-secondary);
            border: 3px solid var(--bg-tertiary);
            border-radius: 16px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .character-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 170, 0.2);
        }

        .character-card.selected {
            border-color: var(--accent-success);
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .character-preview {
            width: 120px;
            height: 120px;
            margin: 0 auto 0.75rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .character-name {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .character-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .character-modal-close {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            color: var(--bg-primary);
            border: none;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .character-modal-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 170, 0.4);
        }

        /* ===== AUTH MODAL ===== */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .auth-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .auth-modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 20px 60px rgba(0, 212, 170, 0.3);
        }

        .auth-modal h2 {
            font-family: 'Nunito', sans-serif;
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .auth-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 10px;
            color: var(--text-secondary);
            font-family: 'Fredoka', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-tab:hover {
            border-color: var(--accent-primary);
        }

        .auth-tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-input-group {
            margin-bottom: 1rem;
        }

        .auth-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .auth-input-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Quicksand', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .auth-input-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 10px rgba(0, 212, 170, 0.3);
        }

        /* Password Input with Toggle */
        .password-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-wrapper input {
            width: 100%;
            padding-right: 3rem;
        }

        .password-toggle {
            position: absolute;
            right: 0.75rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            opacity: 0.6;
            transition: opacity 0.3s ease;
            padding: 0.25rem;
        }

        .password-toggle:hover {
            opacity: 1;
        }

        .password-toggle.showing {
            opacity: 1;
        }

        .auth-btn {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            color: var(--bg-primary);
            border: none;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 170, 0.4);
        }

        .auth-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .auth-error {
            background: rgba(255, 45, 117, 0.2);
            border: 1px solid var(--accent-secondary);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            color: var(--accent-secondary);
            font-size: 0.85rem;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        .auth-success {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid var(--accent-success);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            color: var(--accent-success);
            font-size: 0.85rem;
            display: none;
        }

        .auth-success.show {
            display: block;
        }

        .auth-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .auth-close:hover {
            color: var(--accent-secondary);
        }

        .auth-modal-content {
            position: relative;
        }

        /* Google Login Button */
        .google-login-btn {
            width: 100%;
            padding: 0.875rem;
            background: #ffffff;
            color: #333;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .google-login-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .google-login-btn svg {
            flex-shrink: 0;
        }

        /* Auth Divider */
        .auth-divider {
            display: flex;
            align-items: center;
            margin: 1.25rem 0;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--bg-tertiary);
        }

        .auth-divider span {
            padding: 0 1rem;
        }

        /* Forgot Password Link */
        .forgot-password-link {
            display: block;
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.75rem;
            background: none;
            border: none;
            color: var(--accent-primary);
            font-family: 'Quicksand', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: color 0.3s ease;
            text-align: center;
        }

        .forgot-password-link:hover {
            color: var(--accent-tertiary);
            text-decoration: underline;
        }

        /* Forgot Password Form */
        .forgot-password-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .back-to-login-link {
            display: block;
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.75rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-family: 'Quicksand', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: color 0.3s ease;
            text-align: center;
        }

        .back-to-login-link:hover {
            color: var(--accent-primary);
        }

        /* User Info Display */
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: 20px;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .user-name {
            font-family: 'Fredoka', sans-serif;
            color: var(--accent-success);
            font-size: 0.9rem;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.3s ease;
        }

        .logout-btn:hover {
            color: var(--accent-secondary);
        }

        .logout-btn-visible {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--accent-secondary), #ff6b6b);
            color: white;
            border: none;
            border-radius: 20px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .logout-btn-visible:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 45, 117, 0.4);
            filter: brightness(1.1);
        }

        #authSection {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .login-btn {
            padding: 0.5rem 1.25rem;
            background: linear-gradient(135deg, var(--accent-success), var(--accent-primary));
            color: var(--bg-primary);
            border: none;
            border-radius: 20px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .sync-indicator {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .sync-indicator.syncing {
            color: var(--accent-warning);
        }

        .sync-indicator.synced {
            color: var(--accent-success);
        }

        /* Settings Button */
        .settings-btn {
            position: relative;
            cursor: pointer;
            border: 1px solid var(--accent-warning);
            color: var(--accent-warning);
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            background: var(--accent-warning);
            color: var(--bg-primary);
            transform: translateY(-2px);
        }

        .login-status {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #888;
            border: 2px solid var(--bg-secondary);
        }

        .login-status.logged-in {
            background: var(--accent-success);
            box-shadow: 0 0 8px var(--accent-success);
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 1rem;
        }

        .settings-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .settings-modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            border: 2px solid var(--accent-warning);
            box-shadow: 0 20px 60px rgba(255, 204, 0, 0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .settings-modal h2 {
            font-family: 'Nunito', sans-serif;
            color: var(--accent-warning);
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .settings-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .settings-close:hover {
            color: var(--accent-secondary);
        }

        /* Login Status Card */
        .login-status-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 2px solid var(--bg-tertiary);
        }

        .login-status-card.logged-in {
            border-color: var(--accent-success);
            background: rgba(0, 255, 136, 0.1);
        }

        .login-status-card .status-icon {
            font-size: 2rem;
        }

        .login-status-card .status-info {
            display: flex;
            flex-direction: column;
        }

        .login-status-card .status-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .login-status-card .status-text {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .login-status-card.logged-in .status-text {
            color: var(--accent-success);
        }

        /* Settings Message */
        .settings-message {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        .settings-message.success {
            display: block;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid var(--accent-success);
            color: var(--accent-success);
        }

        .settings-message.error {
            display: block;
            background: rgba(255, 45, 117, 0.2);
            border: 1px solid var(--accent-secondary);
            color: var(--accent-secondary);
        }

        /* Settings Sections */
        .settings-section {
            margin-bottom: 1rem;
        }

        .settings-group {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .settings-group h3 {
            font-family: 'Fredoka', sans-serif;
            color: var(--accent-primary);
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .settings-toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--accent-success);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .settings-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .theme-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .theme-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .theme-btn:hover {
            border-color: var(--accent-primary);
        }

        .theme-btn.active {
            border-color: var(--accent-success);
            background: rgba(16, 185, 129, 0.1);
        }

        .theme-preview {
            width: 50px;
            height: 35px;
            border-radius: 6px;
            overflow: hidden;
        }

        /* Text Color Selector */
        .text-color-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .text-color-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .text-color-btn:hover {
            border-color: var(--accent-primary);
        }

        .text-color-btn.active {
            border-color: var(--accent-success);
            background: rgba(16, 185, 129, 0.1);
        }

        .text-color-preview {
            width: 40px;
            height: 25px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.75rem;
            background: var(--bg-primary);
        }

        .text-color-preview.default-preview {
            color: #6ee7b7;
        }

        .text-color-preview.blue-preview {
            color: #5cb8ff;
        }

        .text-color-preview.yellow-preview {
            color: #fbbf24;
        }

        .text-color-preview.white-preview {
            color: #ffffff;
        }

        .theme1-preview {
            background: linear-gradient(135deg, #0a0f1c 0%, #1a1f3c 100%);
            position: relative;
        }

        .theme1-preview::before {
            content: '✦ ✧ ✦';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            color: white;
            letter-spacing: 2px;
        }

        .theme2-preview {
            background: linear-gradient(135deg, #1a0a2e 0%, #16213e 50%, #0f3460 100%);
            position: relative;
        }

        .theme2-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 40%, rgba(147, 51, 234, 0.4) 0%, transparent 50%),
                        radial-gradient(circle at 70% 60%, rgba(59, 130, 246, 0.4) 0%, transparent 50%);
        }

        .theme-futuristic-preview {
            background: linear-gradient(180deg, #000010 0%, #000020 50%, #002050 100%);
            position: relative;
            overflow: hidden;
        }

        .theme-futuristic-preview::before {
            content: '';
            position: absolute;
            bottom: 45%;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(180deg, transparent, rgba(0, 220, 255, 0.5), rgba(0, 220, 255, 0.3));
            filter: blur(2px);
        }

        .theme-futuristic-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 45%;
            background: linear-gradient(90deg, rgba(0, 220, 255, 0.4) 1px, transparent 1px),
                        linear-gradient(0deg, rgba(0, 220, 255, 0.3) 1px, transparent 1px);
            background-size: 8px 5px;
        }

        .themeoff-preview {
            background: #000000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .themeoff-preview::before {
            content: '−';
            color: #444444;
            font-size: 16px;
        }

        .theme-universe-preview {
            background: #000000;
            position: relative;
            overflow: hidden;
        }

        .theme-universe-preview::before {
            content: '';
            position: absolute;
            bottom: 45%;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(255, 0, 120, 0.9);
            box-shadow: 0 0 8px rgba(255, 0, 100, 0.8);
        }

        .theme-universe-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 45%;
            background:
                linear-gradient(90deg, rgba(255, 0, 100, 0.4) 1px, transparent 1px),
                linear-gradient(0deg, rgba(200, 0, 150, 0.3) 1px, transparent 1px);
            background-size: 6px 4px;
        }

        .theme-realistic-preview {
            background: linear-gradient(180deg, #000515 0%, #001030 50%, #002060 100%);
            position: relative;
            overflow: hidden;
        }

        .theme-realistic-preview::before {
            content: '';
            position: absolute;
            bottom: 40%;
            left: 25%;
            width: 50%;
            height: 10px;
            background: radial-gradient(ellipse at center, rgba(0, 200, 255, 0.8), transparent);
            filter: blur(4px);
        }

        .theme-realistic-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40%;
            background:
                linear-gradient(90deg, rgba(0, 200, 255, 0.4) 1px, transparent 1px),
                linear-gradient(0deg, rgba(0, 200, 255, 0.3) 1px, transparent 1px);
            background-size: 6px 4px;
        }

        .settings-field {
            margin-bottom: 1rem;
        }

        .settings-field:last-child {
            margin-bottom: 0;
        }

        .settings-field label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .settings-field-row {
            display: flex;
            gap: 0.5rem;
        }

        .settings-field-row input {
            flex: 1;
            padding: 0.625rem 0.875rem;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Quicksand', sans-serif;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .settings-field-row input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Settings Password Input */
        .settings-field .password-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .settings-field .password-input-wrapper input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--bg-secondary);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Quicksand', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .settings-field .password-input-wrapper input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 10px rgba(0, 212, 170, 0.2);
        }

        .settings-field .password-input-wrapper input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .settings-field .password-input-wrapper .password-toggle {
            position: absolute;
            right: 0.75rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            opacity: 0.6;
            transition: opacity 0.3s ease;
            padding: 0.25rem;
        }

        .settings-field .password-input-wrapper .password-toggle:hover {
            opacity: 1;
        }

        /* Password Change Section Styling */
        #settingsPasswordChange {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.25rem;
        }

        #settingsPasswordChange h3 {
            font-family: 'Fredoka', sans-serif;
            color: var(--accent-warning);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        #settingsPasswordChange .settings-note {
            margin-bottom: 1.25rem;
            margin-top: 0;
        }

        #settingsPasswordChange .settings-field {
            margin-bottom: 1rem;
        }

        #settingsPasswordChange .settings-buttons {
            margin-top: 1.5rem;
        }

        .settings-save-btn {
            padding: 0.625rem 1rem;
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .settings-save-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        /* Settings Buttons */
        .settings-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .settings-action-btn {
            width: 100%;
            padding: 0.875rem;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .settings-action-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            color: var(--bg-primary);
        }

        .settings-action-btn.secondary {
            background: linear-gradient(135deg, var(--accent-success), var(--accent-primary));
            color: var(--bg-primary);
        }

        .settings-action-btn.outline {
            background: transparent;
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .settings-action-btn.danger {
            background: linear-gradient(135deg, var(--accent-secondary), #ff6b6b);
            color: white;
        }

        .settings-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .settings-action-btn.outline:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        .settings-note {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 1rem;
            text-align: center;
            line-height: 1.5;
        }

        /* Settings Stats */
        .settings-stats {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-row span:first-child {
            color: var(--text-secondary);
        }

        .stat-row span:last-child {
            color: var(--accent-primary);
            font-family: 'Nunito', sans-serif;
        }

        /* ===== LIGHT MODE ===== */
        body.light-mode {
            --bg-primary: #e8ecf2;
            --bg-secondary: #ffffff;
            --bg-tertiary: #d1d9e6;
            --bg-card: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #374151;
            --text-code: #7c3aed;
            --grid-color: #94a3b8;
            --border-color: #cbd5e1;
            --accent-primary: #0891b2;
            --accent-secondary: #db2777;
            --accent-tertiary: #7c3aed;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
        }

        body.light-mode::before {
            background:
                radial-gradient(circle at 20% 30%, rgba(0, 180, 220, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(147, 51, 234, 0.12) 0%, transparent 50%);
        }

        body.light-mode .starfield .star {
            background: rgba(100, 116, 139, 0.3);
        }

        body.light-mode .panel {
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.08),
                0 0 0 1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border-color);
        }

        body.light-mode .panel::before {
            background: linear-gradient(90deg, #0891b2, #7c3aed);
        }

        body.light-mode canvas {
            background: #f1f5f9;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 2px solid #cbd5e1;
        }

        body.light-mode .code-editor textarea {
            background: #1e293b;
            color: #e879f9;
            border: 2px solid #475569;
        }

        body.light-mode .output {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #1e293b;
        }

        body.light-mode .hint-box {
            background: rgba(251, 191, 36, 0.15);
            border-color: #f59e0b;
        }

        body.light-mode .level-btn {
            background: #f1f5f9;
            border-color: #94a3b8;
            color: #475569;
        }

        body.light-mode .level-btn:hover {
            border-color: #0891b2;
            color: #0891b2;
            background: #e0f2fe;
        }

        body.light-mode .level-btn.active {
            background: linear-gradient(135deg, #0891b2, #7c3aed);
            color: white;
            border-color: #0891b2;
        }

        body.light-mode .world-btn {
            background: #f1f5f9;
            border-color: #94a3b8;
            color: #475569;
        }

        body.light-mode .world-btn:hover {
            border-color: #0891b2;
            color: #0891b2;
        }

        body.light-mode .world-btn.active {
            background: linear-gradient(135deg, #0891b2, #7c3aed);
            color: white;
        }

        body.light-mode .stat-item {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
        }

        body.light-mode .challenge-description {
            background: #f8fafc;
            border-left-color: #7c3aed;
            color: #1e293b;
        }

        body.light-mode .challenge-description code {
            background: #e0e7ff;
            color: #4338ca;
        }

        body.light-mode .success-message {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            color: #047857;
        }

        body.light-mode .error-message {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #dc2626;
        }

        body.light-mode .character-modal-content {
            background: #ffffff;
            border-color: #0891b2;
        }

        body.light-mode .character-card {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        body.light-mode .character-card:hover {
            border-color: #0891b2;
            background: #e0f2fe;
        }

        body.light-mode .character-card.selected {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        body.light-mode .quick-ref-panel {
            background: #ffffff;
            border-color: #cbd5e1;
        }

        body.light-mode .floating-help-btn {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        body.light-mode .panel-title {
            color: #0891b2;
        }

        body.light-mode .game-info {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
        }

        body.light-mode .info-item .label {
            color: #475569;
        }

        body.light-mode .run-btn {
            background: linear-gradient(135deg, #0891b2, #0e7490);
            box-shadow: 0 4px 12px rgba(8, 145, 178, 0.3);
        }

        body.light-mode .level-complete-modal {
            background: #ffffff;
            border-color: #0891b2;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 1.5rem;
            animation: fadeInUp 0.8s ease 0.2s backwards;
        }

        .panel {
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow:
                0 10px 40px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(0, 212, 170, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-tertiary), var(--accent-secondary));
        }

        .panel::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 20px;
            background: linear-gradient(180deg, rgba(0, 212, 170, 0.2) 0%, transparent 100%);
            border-radius: 0 0 50% 50%;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .world-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .world-btn {
            padding: 0.4rem 0.8rem;
            border: 2px solid var(--bg-tertiary);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .world-btn:hover {
            border-color: var(--accent-tertiary);
            color: var(--accent-tertiary);
        }

        .world-btn.active {
            background: linear-gradient(135deg, var(--accent-tertiary), var(--accent-secondary));
            border-color: var(--accent-tertiary);
            color: white;
        }

        .level-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.4rem;
            margin-bottom: 1rem;
        }

        .level-btn {
            padding: 0.5rem;
            border: 2px solid var(--bg-tertiary);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .level-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 170, 0.2);
        }

        .level-btn.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            border-color: var(--accent-primary);
            color: var(--bg-primary);
            box-shadow: 0 0 20px var(--glow-primary);
        }

        .level-btn.completed {
            background: linear-gradient(135deg, var(--accent-success), #00cc6a);
            border-color: var(--accent-success);
            color: var(--bg-primary);
        }

        /* Block mode completion - purple */
        .level-btn.completed-block {
            background: linear-gradient(135deg, #9966FF, #774DCB);
            border-color: #9966FF;
            color: white;
        }

        /* Both modes completion - green to purple gradient with prize */
        .level-btn.completed-both {
            background: linear-gradient(135deg, var(--accent-success), #00cc6a, #9966FF, #774DCB);
            border-color: #FFD700;
            color: white;
            position: relative;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .level-btn.completed-both::after {
            content: '🏆';
            position: absolute;
            top: -6px;
            right: -6px;
            font-size: 0.7rem;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
        }

        .level-btn .stars {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            white-space: nowrap;
        }

        .challenge-box {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-secondary);
            position: relative;
            overflow: hidden;
        }

        .challenge-box::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(255, 45, 117, 0.1) 0%, transparent 70%);
        }

        .challenge-title {
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            color: var(--accent-warning);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .challenge-description {
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .challenge-description code {
            background: var(--bg-primary);
            color: var(--text-code);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Quicksand', sans-serif;
        }

        .new-concept {
            display: inline-block;
            background: linear-gradient(135deg, var(--accent-tertiary), var(--accent-secondary));
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(177, 78, 255, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(177, 78, 255, 0);
            }
        }

        .code-editor-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .editor-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .editor-tab {
            padding: 0.4rem 1rem;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px 8px 0 0;
            color: var(--text-secondary);
            font-family: 'Quicksand', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .editor-tab.active {
            background: var(--bg-primary);
            color: var(--accent-primary);
        }

        .code-editor {
            position: relative;
            background: var(--bg-primary);
            border-radius: 0 12px 12px 12px;
            overflow: hidden;
            border: 2px solid var(--bg-tertiary);
            transition: border-color 0.3s ease;
        }

        .code-editor:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px rgba(0, 212, 170, 0.1);
        }

        .line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3rem;
            background: var(--bg-secondary);
            border-right: 1px solid var(--bg-tertiary);
            padding: 1rem 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            user-select: none;
            line-height: 1.5;
            text-align: right;
            overflow: hidden;
        }

        textarea {
            width: 100%;
            height: 220px;
            background: transparent;
            color: var(--text-code);
            border: none;
            padding: 1rem 1rem 1rem 4rem;
            font-family: 'Quicksand', sans-serif;
            font-size: 0.9rem;
            resize: none;
            line-height: 1.5;
        }

        /* ===== BLOCK MODE STYLES ===== */
        .editor-mode-toggle {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 20px;
            padding: 3px;
            margin-left: auto;
        }

        .mode-btn {
            padding: 0.4rem 1rem;
            border: none;
            border-radius: 17px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: var(--text-secondary);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            color: var(--bg-primary);
        }

        .mode-btn:hover:not(.active) {
            color: var(--text-primary);
        }

        .block-editor {
            display: none;
            flex-direction: column;
            height: 300px;
            background: var(--bg-primary);
            border-radius: 12px;
            border: 2px solid var(--bg-tertiary);
            overflow: hidden;
        }

        .block-editor.active {
            display: flex;
        }

        .code-editor-wrapper {
            display: block;
        }

        .code-editor-wrapper.hidden {
            display: none;
        }

        .block-palette {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--bg-tertiary);
            flex-wrap: wrap;
            align-items: center;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-left: auto;
            background: var(--bg-tertiary);
            border-radius: 15px;
            padding: 0.2rem 0.4rem;
        }

        .zoom-btn {
            width: 22px;
            height: 22px;
            border: none;
            border-radius: 50%;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .zoom-btn:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        .zoom-level {
            font-family: 'Quicksand', sans-serif;
            font-size: 0.65rem;
            color: var(--text-secondary);
            min-width: 35px;
            text-align: center;
        }

        .palette-category {
            padding: 0.35rem 0.75rem;
            border: none;
            border-radius: 15px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .palette-category:hover {
            opacity: 1;
            transform: scale(1.05);
        }

        .palette-category.active {
            opacity: 1;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .palette-category.motion {
            background: #4C97FF;
            color: white;
        }

        .palette-category.collect {
            background: #59C059;
            color: white;
        }

        .palette-category.check {
            background: #FF8C1A;
            color: white;
        }

        .palette-category.control {
            background: #FFAB19;
            color: white;
        }

        .palette-category.loop {
            background: #9966FF;
            color: white;
        }

        .block-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .block-list {
            width: 160px;
            padding: 0.5rem;
            background: var(--bg-secondary);
            overflow-y: auto;
            border-right: 1px solid var(--bg-tertiary);
        }

        .block-list::-webkit-scrollbar {
            width: 6px;
        }

        .block-list::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .block-workspace-wrapper {
            flex: 1;
            overflow: auto;
            position: relative;
            border: 2px solid transparent;
            border-radius: 0 0 8px 0;
            transition: border-color 0.2s ease;
        }

        .block-workspace {
            min-width: 100%;
            min-height: 100%;
            padding: 0.75rem;
            position: relative;
            background-color: var(--bg-primary);
            background-image:
                linear-gradient(90deg, var(--bg-tertiary) 1px, transparent 1px),
                linear-gradient(var(--bg-tertiary) 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: -1px -1px;
            transition: background 0.2s ease;
            transform-origin: top left;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }

        .workspace-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-align: center;
            pointer-events: none;
            opacity: 0.5;
            z-index: 0;
        }

        .workspace-hint.hidden {
            display: none;
        }

        .block-workspace>.workspace-block {
            z-index: 1;
        }

        /* Block styles */
        .block {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.35rem 0.5rem;
            margin-bottom: 0.3rem;
            border-radius: 6px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.7rem;
            cursor: grab;
            user-select: none;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        .block .icon {
            font-size: 0.85rem;
        }

        .block-list .block {
            cursor: grab;
            display: flex;
            width: fit-content;
        }

        .block-list .block:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        .block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .block:active {
            cursor: grabbing;
        }

        .block.dragging {
            opacity: 0.8;
            z-index: 1000;
            pointer-events: none;
        }

        /* Block colors by category */
        .block.motion {
            background: linear-gradient(135deg, #4C97FF, #3373CC);
            color: white;
        }

        .block.collect {
            background: linear-gradient(135deg, #59C059, #45A045);
            color: white;
        }

        .block.check {
            background: linear-gradient(135deg, #FF8C1A, #E67300);
            color: white;
        }

        .block.control {
            background: linear-gradient(135deg, #FFAB19, #E69500);
            color: white;
        }

        .block.loop {
            background: linear-gradient(135deg, #9966FF, #774DCB);
            color: white;
        }

        /* Container blocks (if, while, for) */
        .block.container {
            flex-direction: column;
            align-items: stretch;
            padding: 0;
            background: none !important;
            box-shadow: none !important;
        }

        .block.container:hover {
            transform: none;
            box-shadow: none !important;
        }

        .block-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .block.container.control .block-header {
            background: linear-gradient(135deg, #FFAB19, #E69500);
        }

        .block.container.loop .block-header {
            background: linear-gradient(135deg, #9966FF, #774DCB);
        }

        .block-body {
            min-height: 40px;
            margin-left: 12px;
            padding: 0.5rem;
            border-left: 4px solid;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0 0 0 8px;
        }

        .block.container.control .block-body {
            border-color: #FFAB19;
        }

        .block.container.loop .block-body {
            border-color: #9966FF;
        }

        .block-footer {
            height: 8px;
            margin-left: 12px;
            border-left: 4px solid;
            border-bottom: 4px solid;
            border-radius: 0 0 0 8px;
            width: 40px;
        }

        .block.container.control .block-footer {
            border-color: #FFAB19;
        }

        .block.container.loop .block-footer {
            border-color: #9966FF;
        }

        /* Workspace container blocks */
        .workspace-block.container-block {
            margin-bottom: 0.3rem;
            display: block;
            width: fit-content;
        }

        .workspace-block.container-block>.block {
            margin-bottom: 0;
        }

        .workspace-block .block-body {
            min-height: 30px;
            margin-left: 8px;
            padding: 0.35rem;
            padding-left: 0.5rem;
            border-left: 3px solid;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.15rem;
        }

        .workspace-block .block-body .workspace-block {
            display: block;
            margin-bottom: 0.1rem;
        }

        .workspace-block .block-footer {
            height: 8px;
            margin-left: 8px;
            border-left: 3px solid;
            border-bottom: 3px solid;
            border-radius: 0 0 0 6px;
            width: 35px;
        }

        /* Block input fields */
        .block-input {
            width: 28px;
            padding: 0.1rem 0.2rem;
            border: none;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-family: 'Quicksand', sans-serif;
            font-size: 0.65rem;
            text-align: center;
        }

        .block-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
        }

        .block-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Block select dropdown */
        .block-select {
            padding: 0.1rem 0.2rem;
            border: none;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.6rem;
            cursor: pointer;
            max-width: 80px;
        }

        .block-select:focus {
            outline: none;
        }

        .block-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Workspace blocks */
        .workspace-block {
            position: relative;
            margin-bottom: 0.15rem;
            display: block;
            width: fit-content;
        }

        .workspace-block>.block {
            cursor: default;
            display: inline-flex;
        }

        .workspace-block .delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 14px;
            height: 14px;
            background: var(--accent-secondary);
            border: 1px solid var(--bg-primary);
            border-radius: 50%;
            color: white;
            font-size: 0.55rem;
            font-weight: bold;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            line-height: 1;
        }

        .workspace-block:hover>.delete-btn {
            opacity: 1;
        }

        .workspace-block .delete-btn:hover {
            transform: scale(1.2);
            background: #ff1744;
        }

        /* Drop zone highlight */
        .drop-zone {
            min-height: 30px;
            border: 2px dashed var(--accent-primary);
            border-radius: 8px;
            margin: 0.25rem 0;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .drop-zone.active {
            opacity: 1;
            background: rgba(0, 212, 170, 0.1);
        }

        /* Generated code preview */
        .generated-code {
            display: none;
            background: var(--bg-secondary);
            border-top: 1px solid var(--bg-tertiary);
            padding: 0.5rem 0.75rem;
            max-height: 100px;
            overflow-y: auto;
            font-family: 'Quicksand', sans-serif;
            font-size: 0.75rem;
            color: var(--text-code);
        }

        .generated-code.show {
            display: block;
        }

        .generated-code pre {
            margin: 0;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .generated-code::before {
            content: '📄 生成されたコード:';
            display: block;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        textarea:focus {
            outline: none;
        }

        .controls {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        button {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .run-btn {
            background: linear-gradient(135deg, var(--accent-primary), #00b8c8);
            color: var(--bg-primary);
            flex: 1;
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .run-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 170, 0.4);
        }

        .run-btn:active {
            transform: translateY(0);
        }

        .hint-btn {
            background: var(--bg-tertiary);
            color: var(--accent-warning);
            border: 2px solid var(--accent-warning);
        }

        .hint-btn:hover {
            background: var(--accent-warning);
            color: var(--bg-primary);
        }

        .reset-btn {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 2px solid var(--text-secondary);
        }

        .reset-btn:hover {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
            color: white;
        }

        .hint-box {
            background: linear-gradient(135deg, rgba(255, 204, 0, 0.1), rgba(255, 123, 0, 0.1));
            border: 2px solid var(--accent-warning);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .hint-box.show {
            display: block;
        }

        .hint-box code {
            display: block;
            background: var(--bg-primary);
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            color: var(--text-code);
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .output {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            min-height: 80px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.5;
            border: 1px solid var(--bg-tertiary);
        }

        .output p {
            margin: 0.25rem 0;
            padding-left: 0.5rem;
            border-left: 2px solid var(--accent-primary);
        }

        .canvas-container {
            background: linear-gradient(180deg, #0d1321 0%, #151d32 100%);
            border-radius: 16px;
            padding: 1rem;
            position: relative;
            border: 2px solid var(--bg-tertiary);
            overflow: hidden;
        }

        .canvas-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 30% 30%, rgba(0, 212, 170, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 70% 70%, rgba(177, 78, 255, 0.05) 0%, transparent 40%);
            pointer-events: none;
        }

        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 8px;
            box-shadow:
                0 0 30px rgba(0, 0, 0, 0.5),
                inset 0 0 50px rgba(0, 212, 170, 0.03);
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .game-info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .game-info-item .icon {
            font-size: 1.2rem;
        }

        .game-info-item .value {
            font-family: 'Nunito', sans-serif;
            color: var(--accent-primary);
            font-weight: 700;
        }

        .success-message {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 204, 106, 0.2));
            border: 2px solid var(--accent-success);
            color: var(--accent-success);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            font-weight: 700;
            animation: successPop 0.5s ease;
            margin-top: 1rem;
        }

        .error-message {
            background: linear-gradient(135deg, rgba(255, 45, 117, 0.2), rgba(255, 45, 117, 0.1));
            border: 2px solid var(--accent-secondary);
            color: var(--accent-secondary);
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes successPop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Celebration effects */
        .celebration-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .level-complete-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 23, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
            animation: fadeIn 0.3s ease;
            overflow: hidden;
        }

        .level-complete-modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            padding: 2.5rem;
            border-radius: 24px;
            text-align: center;
            max-width: 400px;
            border: 3px solid var(--accent-success);
            box-shadow: 0 0 60px rgba(0, 255, 136, 0.3), 0 0 100px rgba(0, 255, 136, 0.2);
            animation: modalPop 0.5s ease, glowPulse 2s ease-in-out infinite;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes modalPop {
            0% {
                transform: scale(0.5) rotate(-5deg);
                opacity: 0;
            }

            50% {
                transform: scale(1.1) rotate(2deg);
            }

            70% {
                transform: scale(0.95) rotate(-1deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes glowPulse {

            0%,
            100% {
                box-shadow: 0 0 60px rgba(0, 255, 136, 0.3), 0 0 100px rgba(0, 255, 136, 0.2);
            }

            50% {
                box-shadow: 0 0 80px rgba(0, 255, 136, 0.5), 0 0 120px rgba(0, 255, 136, 0.3), 0 0 150px rgba(177, 78, 255, 0.2);
            }
        }

        .modal-title {
            font-family: 'Nunito', sans-serif;
            font-size: 2rem;
            color: var(--accent-success);
            margin-bottom: 1rem;
            animation: titleShimmer 1.5s ease-in-out infinite, titleBounce 0.6s ease;
            background: linear-gradient(90deg, var(--accent-success), #00ffcc, var(--accent-primary), var(--accent-success));
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes titleShimmer {
            0% {
                background-position: 0% center;
            }

            100% {
                background-position: 200% center;
            }
        }

        @keyframes titleBounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .modal-stars {
            font-size: 3rem;
            margin: 1rem 0;
            animation: starsBounce 1s ease infinite;
        }

        @keyframes starsBounce {

            0%,
            100% {
                transform: scale(1) translateY(0);
            }

            25% {
                transform: scale(1.2) translateY(-10px);
            }

            50% {
                transform: scale(1) translateY(0);
            }

            75% {
                transform: scale(1.1) translateY(-5px);
            }
        }

        .modal-message {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            animation: fadeSlideUp 0.8s ease 0.3s both;
        }

        @keyframes fadeSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-btn {
            background: linear-gradient(135deg, var(--accent-success), #00cc6a);
            color: var(--bg-primary);
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 12px;
            cursor: pointer;
            animation: btnPulse 2s ease-in-out infinite, fadeSlideUp 0.8s ease 0.5s both;
            border: none;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
        }

        @keyframes btnPulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 25px rgba(0, 255, 136, 0.5);
            }
        }

        .modal-btn:hover {
            transform: translateY(-2px) scale(1.08);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }

        /* Level Up Modal */
        .level-up-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 23, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            animation: fadeIn 0.3s ease;
        }

        .level-up-modal.show {
            display: flex;
        }

        .level-up-content {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            padding: 3rem;
            border-radius: 30px;
            text-align: center;
            max-width: 420px;
            border: 3px solid #ffd700;
            box-shadow: 0 0 80px rgba(255, 215, 0, 0.4), 0 0 120px rgba(177, 78, 255, 0.3);
            animation: levelUpPop 0.6s ease, rainbowGlow 2s ease-in-out infinite;
        }

        @keyframes levelUpPop {
            0% {
                transform: scale(0.3) rotate(-10deg);
                opacity: 0;
            }

            50% {
                transform: scale(1.15) rotate(3deg);
            }

            70% {
                transform: scale(0.95) rotate(-1deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes rainbowGlow {

            0%,
            100% {
                box-shadow: 0 0 80px rgba(255, 215, 0, 0.4), 0 0 120px rgba(177, 78, 255, 0.3);
            }

            33% {
                box-shadow: 0 0 80px rgba(0, 212, 170, 0.5), 0 0 120px rgba(255, 45, 117, 0.3);
            }

            66% {
                box-shadow: 0 0 80px rgba(0, 255, 136, 0.5), 0 0 120px rgba(255, 215, 0, 0.3);
            }
        }

        .level-up-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: rocketLaunch 1s ease infinite;
        }

        @keyframes rocketLaunch {

            0%,
            100% {
                transform: translateY(0) rotate(-15deg);
            }

            50% {
                transform: translateY(-20px) rotate(-15deg);
            }
        }

        .level-up-title {
            font-family: 'Nunito', sans-serif;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, #ffd700, #ff6b6b, #b14eff, #00f5ff, #ffd700);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleShimmer 1.5s ease-in-out infinite;
        }

        .level-up-number {
            font-family: 'Nunito', sans-serif;
            font-size: 4rem;
            font-weight: 700;
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            animation: levelPulse 1s ease-in-out infinite;
            margin: 1rem 0;
        }

        @keyframes levelPulse {

            0%,
            100% {
                transform: scale(1);
                text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            }

            50% {
                transform: scale(1.1);
                text-shadow: 0 0 50px rgba(255, 215, 0, 1);
            }
        }

        .level-up-message {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }

        .level-up-btn {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            padding: 1rem 2.5rem;
            font-size: 1.2rem;
            border-radius: 15px;
            cursor: pointer;
            border: none;
            font-family: 'Fredoka', sans-serif;
            font-weight: 700;
            transition: all 0.3s ease;
            animation: btnPulse 2s ease-in-out infinite;
        }

        .level-up-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
        }

        /* Quick Reference Panel */
        .quick-ref-panel {
            position: fixed;
            right: -350px;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            max-height: 80vh;
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border-radius: 20px 0 0 20px;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
            z-index: 998;
            transition: right 0.4s ease;
            overflow: hidden;
            border: 1px solid rgba(0, 212, 170, 0.2);
            border-right: none;
        }

        .quick-ref-panel.open {
            right: 0;
        }

        .quick-ref-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quick-ref-header h3 {
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            color: var(--accent-primary);
            margin: 0;
        }

        .quick-ref-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .quick-ref-close:hover {
            background: var(--accent-secondary);
            color: white;
        }

        .quick-ref-content {
            padding: 1rem 1.25rem;
            overflow-y: auto;
            max-height: calc(80vh - 60px);
        }

        .quick-ref-section {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quick-ref-section:last-of-type {
            border-bottom: none;
        }

        .quick-ref-section h4 {
            font-family: 'Fredoka', sans-serif;
            font-size: 0.9rem;
            color: var(--accent-warning);
            margin-bottom: 0.5rem;
        }

        .quick-ref-section code {
            display: inline-block;
            background: var(--bg-primary);
            color: var(--text-code);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 0.15rem 0;
        }

        .full-ref-link {
            display: block;
            text-align: center;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            color: var(--bg-primary);
            text-decoration: none;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            margin-top: 0.5rem;
            transition: all 0.3s ease;
        }

        .full-ref-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 170, 0.3);
        }

        /* Floating Help Button */
        .floating-help-btn {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-tertiary), var(--accent-secondary));
            border: none;
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            cursor: pointer;
            z-index: 997;
            box-shadow: 0 4px 20px rgba(177, 78, 255, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(177, 78, 255, 0.6);
        }

        .floating-help-btn.active {
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent-tertiary));
            transform: rotate(45deg);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2.5rem;
            }

            .level-selector {
                grid-template-columns: repeat(5, 1fr);
            }

            .floating-robot,
            .rocket-decoration {
                display: none !important;
            }
        }

        @media (max-width: 600px) {
            .level-selector {
                grid-template-columns: repeat(4, 1fr);
            }

            .stats-bar {
                gap: 0.5rem;
            }

            .stat-item {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }
        }


        /* 追加: デバッグモード用のスタイル */
        .debug-mode {
            position: relative;
            border: 2px solid var(--accent-warning) !important;
            animation: debugPulse 2s infinite;
        }

        @keyframes debugPulse {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
            }

            50% {
                box-shadow: 0 0 20px rgba(255, 204, 0, 0.6);
            }
        }

        .bug-spot {
            position: absolute;
            width: 15px;
            height: 15px;
            background: var(--accent-secondary);
            border-radius: 50%;
            animation: bugJump 0.5s infinite alternate;
            z-index: 5;
        }

        @keyframes bugJump {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(-5px);
            }
        }

        .debug-console {
            background: #1e1e1e;
            color: #d4d4d4;
            border-left: 4px solid #ffcc00;
            padding: 0.75rem;
            font-family: 'Quicksand', sans-serif;
            font-size: 0.8rem;
            line-height: 1.4;
            margin-top: 0.5rem;
            border-radius: 0 4px 4px 0;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .debug-line {
            background: rgba(255, 204, 0, 0.1);
            border-left: 3px solid var(--accent-warning);
            margin: 2px 0;
            padding-left: 0.5rem;
        }

        .bug-highlight {
            background: rgba(255, 45, 117, 0.2);
            border: 1px dashed var(--accent-secondary);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            animation: highlightBug 1s infinite;
        }

        @keyframes highlightBug {

            0%,
            100% {
                background: rgba(255, 45, 117, 0.2);
            }

            50% {
                background: rgba(255, 45, 117, 0.4);
            }
        }

        .debug-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .debug-btn {
            padding: 0.4rem 0.8rem;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-warning);
            color: var(--accent-warning);
            border-radius: 6px;
            font-family: 'Quicksand', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .debug-btn:hover {
            background: var(--accent-warning);
            color: var(--bg-primary);
        }

        .line-error {
            background: rgba(255, 45, 117, 0.1);
            border-left: 3px solid var(--accent-secondary);
        }

        .line-warning {
            background: rgba(255, 204, 0, 0.1);
            border-left: 3px solid var(--accent-warning);
        }

        /* Floating Robot Background */
        .floating-robot {
            position: fixed;
            width: 400px;
            height: 400px;
            opacity: 0.45;
            z-index: 1;
            pointer-events: none;
            animation: floatLeftRight 8s ease-in-out infinite, floatUpDown 4s ease-in-out infinite;
            filter: drop-shadow(0 0 15px rgba(255, 100, 0, 0.85));
        }

        .floating-robot-1 {
            top: 3%;
            right: calc(5% - 35px);
            animation-delay: 0s;
        }

        .floating-robot-2 {
            top: 12%;
            right: calc(20% - 85px);
            width: 300px;
            height: 300px;
            animation-delay: -2s;
            animation-duration: 10s, 5s;
        }

        .floating-robot-3 {
            top: 25%;
            right: calc(3% - 35px);
            width: 250px;
            height: 250px;
            animation-delay: -4s;
            animation-duration: 12s, 3s;
        }

        @keyframes floatLeftRight {

            0%,
            100% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(50px);
            }
        }

        @keyframes floatUpDown {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        body.light-mode .floating-robot {
            opacity: 0.15;
        }

        /* Rocket decoration */
        .rocket-decoration {
            position: fixed;
            top: 15px;
            left: -140px;
            width: auto;
            height: auto;
            transform: scale(1.5) rotate(5deg);
            z-index: 1;
            pointer-events: none;
            opacity: 0.85;
            filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.5));
        }

        @keyframes rocketFloat {

            0%,
            100% {
                transform: scale(1.5) rotate(5deg) translateY(0);
            }

            50% {
                transform: scale(1.5) rotate(5deg) translateY(-15px);
            }
        }
    </style>
</head>

<body>
    <!-- Rocket decoration -->
    <img src="rocket.png" class="rocket-decoration" alt="Rocket">

    <!-- Floating Robots Background -->
    <img src="robot_default.png" class="floating-robot floating-robot-1" id="floatingRobot1" alt="">
    <img src="robot_default.png" class="floating-robot floating-robot-2" id="floatingRobot2" alt="">
    <img src="robot_default.png" class="floating-robot floating-robot-3" id="floatingRobot3" alt="">

    <div class="starfield" id="starfield"></div>
    <div class="nebula-bg" id="nebulaBg"></div>
    <div class="universe-bg" id="universeBg">
        <div class="universe-mountains"></div>
        <div class="universe-grid"></div>
        <div class="universe-glow"></div>
    </div>
    <div class="realistic-aurora" id="realisticAurora">
        <div class="aurora-curtain"></div>
        <div class="aurora-curtain-2"></div>
        <div class="aurora-curtain-3"></div>
        <div class="aurora-accent"></div>
        <div class="aurora-landscape"></div>
    </div>
    <div class="futuristic-bg" id="futuristicBg">
        <div class="grid-floor"></div>
        <div class="cyber-lines"></div>
        <div class="glow-orbs"></div>
    </div>

    <div class="container">
        <header>
            <div class="logo-container">
                <h1>⚡ CODEQUEST 道場</h1>
            </div>
            <p class="subtitle">JavaScript マスターへの道</p>

            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-icon">🎯</span>
                    <span>Level:</span>
                    <span class="stat-value" id="levelDisplay">1</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">🏆</span>
                    <span>クリア:</span>
                    <span class="stat-value" id="completedCount">0</span>
                    <span>/100</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">⭐</span>
                    <span>スター:</span>
                    <span class="stat-value" id="totalStars">0</span>
                </div>
                <button class="stat-item character-btn" id="characterBtn" title="キャラクター選択">
                    <span class="stat-icon">🤖</span>
                    <span>キャラ</span>
                </button>
                <a href="codequest-reference.html" class="stat-item help-link">
                    <span class="stat-icon">📖</span>
                    <span>リファレンス</span>
                </a>

                <!-- Settings Button -->
                <button class="stat-item settings-btn" id="settingsBtn" title="設定">
                    <span class="stat-icon">⚙️</span>
                    <span>設定</span>
                    <span class="login-status" id="loginStatusDot"></span>
                </button>
            </div>

            <!-- Sync Status -->
            <div class="sync-indicator" id="syncIndicator" style="display: none;">
                <span id="syncIcon">☁️</span>
                <span id="syncText">同期中...</span>
            </div>
        </header>

        <div class="main-grid">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">📝 コードエディタ</h2>
                </div>

                <div class="world-selector" id="worldSelector">
                    <button class="world-btn active" data-world="1">🌍 基礎</button>
                    <button class="world-btn" data-world="2">🔁 ループ</button>
                    <button class="world-btn" data-world="3">🔀 条件</button>
                    <button class="world-btn" data-world="4">⚙️ 関数</button>
                    <button class="world-btn" data-world="5">🔍 デバッグ</button>
                </div>

                <div class="level-selector" id="levelSelector"></div>

                <div class="challenge-box">
                    <div class="challenge-title" id="challengeTitle">
                        <span>🎯 ミッション</span>
                    </div>
                    <div class="challenge-description" id="challengeDescription"></div>
                </div>

                <div class="hint-box" id="hintBox"></div>

                <div class="code-editor-container">
                    <div class="editor-tabs">
                        <button class="editor-tab active">main.js</button>
                        <div class="editor-mode-toggle">
                            <button class="mode-btn active" id="codeModeBtn">📝 コード</button>
                            <button class="mode-btn" id="blockModeBtn">🧩 ブロック</button>
                        </div>
                    </div>

                    <!-- Code Editor (default) -->
                    <div class="code-editor-wrapper" id="codeEditorWrapper">
                        <div class="code-editor">
                            <div class="line-numbers" id="lineNumbers">1</div>
                            <textarea id="codeInput" spellcheck="false"></textarea>
                        </div>
                    </div>

                    <!-- Block Editor -->
                    <div class="block-editor" id="blockEditor">
                        <div class="block-palette">
                            <button class="palette-category motion active" data-category="motion">🚶 移動</button>
                            <button class="palette-category collect" data-category="collect">⭐ 収集</button>
                            <button class="palette-category check" data-category="check">🔍 チェック</button>
                            <button class="palette-category control" data-category="control">🔀 条件</button>
                            <button class="palette-category loop" data-category="loop">🔄 ループ</button>
                            <div class="zoom-controls">
                                <button class="zoom-btn" id="zoomOutBtn" title="縮小">−</button>
                                <span class="zoom-level" id="zoomLevel">100%</span>
                                <button class="zoom-btn" id="zoomInBtn" title="拡大">+</button>
                            </div>
                        </div>
                        <div class="block-container">
                            <div class="block-list" id="blockList">
                                <!-- Blocks will be inserted here by JS -->
                            </div>
                            <div class="block-workspace-wrapper">
                                <div class="block-workspace" id="blockWorkspace">
                                    <div class="workspace-hint" id="workspaceHint">
                                        ← ブロックをここにドラッグ！
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="generated-code" id="generatedCode">
                            <pre id="generatedCodePre"></pre>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button class="run-btn" id="runBtn">
                        <span>▶</span>
                        <span>実行</span>
                    </button>
                    <button class="hint-btn" id="hintBtn">💡</button>
                    <button class="reset-btn" id="resetBtn">↺</button>
                </div>

                <div class="output" id="output"></div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">🎮 シミュレーター</h2>
                </div>

                <div class="canvas-container">
                    <canvas id="gameCanvas" width="580" height="420"></canvas>
                </div>

                <div class="game-info">
                    <div class="game-info-item">
                        <span class="icon">🤖</span>
                        <span>位置:</span>
                        <span class="value" id="robotPos">(0, 0)</span>
                    </div>
                    <div class="game-info-item">
                        <span class="icon">⭐</span>
                        <span>収集:</span>
                        <span class="value" id="starsCollected">0</span>
                    </div>
                    <div class="game-info-item">
                        <span class="icon">💎</span>
                        <span>ジェム:</span>
                        <span class="value" id="gemsCollected">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="celebration-container" id="celebrationContainer"></div>

    <div class="level-complete-modal" id="levelCompleteModal">
        <div class="modal-content">
            <h2 class="modal-title">🎉 クリア!</h2>
            <div class="modal-stars" id="modalStars">⭐⭐⭐</div>
            <p class="modal-message" id="modalMessage">素晴らしい! 次のレベルに挑戦しよう!</p>
            <button class="modal-btn" id="nextLevelBtn">次へ進む →</button>
        </div>
    </div>

    <!-- Level Up Modal -->
    <div class="level-up-modal" id="levelUpModal">
        <div class="level-up-content">
            <div class="level-up-icon">🚀</div>
            <h2 class="level-up-title">LEVEL UP!</h2>
            <div class="level-up-number" id="levelUpNumber">Lv. 1</div>
            <p class="level-up-message" id="levelUpMessage">ワールド1をマスターした!</p>
            <button class="level-up-btn" id="levelUpCloseBtn">続ける →</button>
        </div>
    </div>

    <!-- Quick Reference Panel -->
    <div class="quick-ref-panel" id="quickRefPanel">
        <div class="quick-ref-header">
            <h3>📖 クイックリファレンス</h3>
            <button class="quick-ref-close" id="closeQuickRef">✕</button>
        </div>
        <div class="quick-ref-content">
            <div class="quick-ref-section">
                <h4>🚶 移動</h4>
                <code>robot.move()</code> - 右に1マス<br>
                <code>robot.moveUp()</code> - 上に1マス<br>
                <code>robot.moveDown()</code> - 下に1マス<br>
                <code>robot.jump()</code> - ジャンプ（障害物越え）
            </div>
            <div class="quick-ref-section">
                <h4>⭐ 収集</h4>
                <code>robot.collect()</code> - 星を収集<br>
                <code>robot.collectGem()</code> - ジェムを収集
            </div>
            <div class="quick-ref-section">
                <h4>🔍 チェック</h4>
                <code>robot.isObstacle()</code> - 前方に障害物?<br>
                <code>robot.isStar()</code> - 星がある?<br>
                <code>robot.isGem()</code> - ジェムがある?<br>
                <code>robot.isGoal()</code> - ゴール?
            </div>
            <div class="quick-ref-section">
                <h4>📊 状態</h4>
                <code>robot.x</code> - X座標<br>
                <code>robot.y</code> - Y座標<br>
                <code>robot.starsCollected</code> - 星の数
            </div>
            <a href="codequest-reference.html" class="full-ref-link">📚 詳しいリファレンスを見る →</a>
        </div>
    </div>

    <!-- Floating Help Button -->
    <button class="floating-help-btn" id="floatingHelpBtn" title="クイックリファレンス">
        <span>?</span>
    </button>

    <!-- Character Selection Modal -->
    <div class="character-modal" id="characterModal">
        <div class="character-modal-content">
            <h2>🤖 キャラクター選択</h2>
            <div class="character-grid" id="characterGrid">
                <!-- Characters will be added by JavaScript -->
            </div>
            <button class="character-modal-close" id="closeCharacterModal">決定</button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-modal-content">
            <button class="auth-close" id="closeAuthModal">✕</button>
            <h2>🔐 ログイン / 登録</h2>

            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">ログイン</button>
                <button class="auth-tab" data-tab="register">新規登録</button>
            </div>

            <div class="auth-error" id="authError"></div>
            <div class="auth-success" id="authSuccess"></div>

            <!-- Google Login Button -->
            <button type="button" class="google-login-btn" id="googleLoginBtn">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path fill="#4285F4"
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path fill="#34A853"
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path fill="#FBBC05"
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                    <path fill="#EA4335"
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                Googleでログイン
            </button>

            <div class="auth-divider">
                <span>または</span>
            </div>

            <!-- Login Form -->
            <form class="auth-form active" id="loginForm">
                <div class="auth-input-group">
                    <label for="loginEmail">📧 メールアドレス</label>
                    <input type="email" id="loginEmail" required placeholder="example@mail.com">
                </div>
                <div class="auth-input-group">
                    <label for="loginPassword">🔑 パスワード</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="loginPassword" required placeholder="パスワード">
                        <button type="button" class="password-toggle" data-target="loginPassword">👁️</button>
                    </div>
                </div>
                <button type="submit" class="auth-btn">ログイン</button>
                <button type="button" class="forgot-password-link" id="forgotPasswordBtn">パスワードを忘れた方</button>
            </form>

            <!-- Register Form -->
            <form class="auth-form" id="registerForm">
                <div class="auth-input-group">
                    <label for="registerNickname">👤 ニックネーム</label>
                    <input type="text" id="registerNickname" required placeholder="あなたの名前" maxlength="20">
                </div>
                <div class="auth-input-group">
                    <label for="registerEmail">📧 メールアドレス</label>
                    <input type="email" id="registerEmail" required placeholder="example@mail.com">
                </div>
                <div class="auth-input-group">
                    <label for="registerPassword">🔑 パスワード（6文字以上）</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="registerPassword" required placeholder="パスワード" minlength="6">
                        <button type="button" class="password-toggle" data-target="registerPassword">👁️</button>
                    </div>
                </div>
                <button type="submit" class="auth-btn">アカウント作成</button>
            </form>

            <!-- Forgot Password Form -->
            <form class="auth-form" id="forgotPasswordForm">
                <p class="forgot-password-text">メールアドレスを入力してください。パスワードリセット用のリンクを送信します。</p>
                <div class="auth-input-group">
                    <label for="resetEmail">📧 メールアドレス</label>
                    <input type="email" id="resetEmail" required placeholder="example@mail.com">
                </div>
                <button type="submit" class="auth-btn">リセットリンクを送信</button>
                <button type="button" class="back-to-login-link" id="backToLoginBtn">← ログインに戻る</button>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-modal-content">
            <button class="settings-close" id="closeSettingsModal">✕</button>
            <h2>⚙️ 設定</h2>

            <!-- Login Status -->
            <div class="settings-login-status" id="settingsLoginStatus">
                <div class="login-status-card not-logged-in" id="loginStatusCard">
                    <div class="status-icon">👤</div>
                    <div class="status-info">
                        <span class="status-label">ログイン状態</span>
                        <span class="status-text" id="loginStatusText">ログインしていません</span>
                    </div>
                </div>
            </div>

            <div class="settings-message" id="settingsMessage"></div>

            <!-- Sound Settings -->
            <div class="settings-section">
                <div class="settings-group">
                    <h3>🔊 サウンド</h3>
                    <div class="settings-toggle-row">
                        <span>効果音</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="soundToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Display Settings -->
            <div class="settings-section">
                <div class="settings-group">
                    <h3>🎨 表示設定</h3>

                    <!-- Background Theme Selection -->
                    <div class="settings-label">🌌 背景テーマ</div>
                    <div class="theme-selector">
                        <button class="theme-btn active" id="theme1Btn" data-theme="1">
                            <span class="theme-preview theme1-preview"></span>
                            <span>スター</span>
                        </button>
                        <button class="theme-btn" id="theme2Btn" data-theme="2">
                            <span class="theme-preview theme2-preview"></span>
                            <span>オーロラ</span>
                        </button>
                        <button class="theme-btn" id="theme3Btn" data-theme="3">
                            <span class="theme-preview theme-universe-preview"></span>
                            <span>ユニバース</span>
                        </button>
                        <button class="theme-btn" id="theme4Btn" data-theme="4">
                            <span class="theme-preview theme-realistic-preview"></span>
                            <span>コスモ</span>
                        </button>
                        <button class="theme-btn" id="theme5Btn" data-theme="5">
                            <span class="theme-preview theme-futuristic-preview"></span>
                            <span>フューチャー</span>
                        </button>
                        <button class="theme-btn" id="themeOffBtn" data-theme="off">
                            <span class="theme-preview themeoff-preview"></span>
                            <span>オフ</span>
                        </button>
                    </div>

                    <!-- Text Color Selection -->
                    <div class="settings-label">✏️ テキストカラー</div>
                    <div class="text-color-selector">
                        <button class="text-color-btn active" data-textcolor="default">
                            <span class="text-color-preview default-preview">Aa</span>
                            <span>デフォルト</span>
                        </button>
                        <button class="text-color-btn" data-textcolor="blue">
                            <span class="text-color-preview blue-preview">Aa</span>
                            <span>ブルー</span>
                        </button>
                        <button class="text-color-btn" data-textcolor="yellow">
                            <span class="text-color-preview yellow-preview">Aa</span>
                            <span>イエロー</span>
                        </button>
                        <button class="text-color-btn" data-textcolor="white">
                            <span class="text-color-preview white-preview">Aa</span>
                            <span>ホワイト</span>
                        </button>
                    </div>

                    <div class="settings-toggle-row">
                        <span>🌙 ダークモード</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-toggle-row">
                        <span>🤖 ロボット表示</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="robotToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-toggle-row">
                        <span>🚀 ロケット表示</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="rocketToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Not Logged In View -->
            <div class="settings-section" id="settingsNotLoggedIn">
                <div class="settings-buttons">
                    <button class="settings-action-btn primary" id="openLoginBtn">
                        🔐 ログイン
                    </button>
                    <button class="settings-action-btn secondary" id="openRegisterBtn">
                        ✨ 新規登録
                    </button>
                </div>
                <p class="settings-note">ログインすると、進捗がクラウドに保存され、他のデバイスでも続きからプレイできます。</p>
            </div>

            <!-- Logged In View -->
            <div class="settings-section" id="settingsLoggedIn" style="display: none;">
                <!-- Profile Section -->
                <div class="settings-group">
                    <h3>👤 プロフィール</h3>

                    <div class="settings-field">
                        <label>ニックネーム</label>
                        <div class="settings-field-row">
                            <input type="text" id="settingsNickname" maxlength="20" placeholder="ニックネーム">
                            <button class="settings-save-btn" id="saveNicknameBtn">保存</button>
                        </div>
                    </div>

                    <div class="settings-field">
                        <label>メールアドレス</label>
                        <div class="settings-field-row">
                            <input type="email" id="settingsEmail" placeholder="メールアドレス">
                            <button class="settings-save-btn" id="saveEmailBtn">変更</button>
                        </div>
                    </div>
                </div>

                <!-- Security Section -->
                <div class="settings-group">
                    <h3>🔒 セキュリティ</h3>

                    <button class="settings-action-btn outline" id="changePasswordBtn">
                        🔑 パスワードを変更
                    </button>
                </div>

                <!-- Data Section -->
                <div class="settings-group">
                    <h3>📊 データ</h3>
                    <div class="settings-stats">
                        <div class="stat-row">
                            <span>クリアしたレベル</span>
                            <span id="settingsCompletedLevels">0 / 100</span>
                        </div>
                        <div class="stat-row">
                            <span>獲得した星</span>
                            <span id="settingsTotalStars">0</span>
                        </div>
                        <div class="stat-row">
                            <span>使用キャラクター</span>
                            <span id="settingsCharacter">-</span>
                        </div>
                    </div>
                </div>

                <!-- Logout Section -->
                <div class="settings-group">
                    <button class="settings-action-btn danger" id="settingsLogoutBtn">
                        🚪 ログアウト
                    </button>
                </div>
            </div>

            <!-- Password Change Form -->
            <div class="settings-section" id="settingsPasswordChange" style="display: none;">
                <h3>🔑 パスワード変更</h3>
                <p class="settings-note">新しいパスワードを入力してください。</p>

                <div class="settings-field">
                    <label>新しいパスワード（6文字以上）</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="newPassword" minlength="6" placeholder="新しいパスワード">
                        <button type="button" class="password-toggle" data-target="newPassword">👁️</button>
                    </div>
                </div>

                <div class="settings-field">
                    <label>パスワード確認</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="confirmPassword" minlength="6" placeholder="パスワード確認">
                        <button type="button" class="password-toggle" data-target="confirmPassword">👁️</button>
                    </div>
                </div>

                <div class="settings-buttons">
                    <button class="settings-action-btn primary" id="savePasswordBtn">パスワードを変更</button>
                    <button class="settings-action-btn outline" id="cancelPasswordChangeBtn">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <script>



        async function fetchKeys() {
            try {
                const res = await fetch("https://codequest.masashilandjob.workers.dev/", {
                    method: "GET",
                    mode: "cors",
                    headers: {
                        "Accept": "application/json"
                    }
                });

                if (!res.ok) {
                    throw new Error(`Worker error: ${res.status}`);
                }

                const data = await res.json();
                console.log("Worker data:", data);
                return data;

            } catch (err) {
                console.error("Error fetching data from Worker:", err);
                return null;
            }
        }



        // Supabase クライアント初期化
        let supabaseClient = null;
        let currentUser = null;
        let userProfile = null;

        async function initSupabase() {
            const keys = await fetchKeys();

            if (!keys || !keys.supabaseUrl || !keys.supabaseAnonKey) {
                console.error("Supabase keys not available");
                return;
            }

            supabaseClient = supabase.createClient(
                keys.supabaseUrl,
                keys.supabaseAnonKey
            );


            try {
                supabaseClient = supabase.createClient(keys.supabaseUrl, keys.supabaseAnonKey, {
                    auth: {
                        detectSessionInUrl: true,
                        autoRefreshToken: true,
                        persistSession: true
                    }
                });
                console.log('✅ Supabase接続成功');

                // URLからOAuthコールバックを検出
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const queryParams = new URLSearchParams(window.location.search);

                const hasHashToken = hashParams.get('access_token') || hashParams.get('refresh_token');
                const hasAuthCode = queryParams.get('code');

                console.log('🔍 URL検査:', {
                    hasHashToken: !!hasHashToken,
                    hasAuthCode: !!hasAuthCode,
                    hash: window.location.hash.substring(0, 50) + '...',
                    search: window.location.search.substring(0, 50)
                });

                // OAuth コールバック処理
                if (hasHashToken || hasAuthCode) {
                    console.log('🔑 OAuthコールバック検出、セッション処理中...');

                    // 少し待ってからセッションを取得（Supabaseの処理を待つ）
                    await new Promise(resolve => setTimeout(resolve, 500));

                    const { data, error } = await supabaseClient.auth.getSession();

                    console.log('📋 セッション取得結果:', {
                        hasSession: !!data?.session,
                        error: error?.message
                    });

                    if (error) {
                        console.error('OAuth セッションエラー:', error);
                    }

                    if (data?.session) {
                        console.log('✅ OAuthログイン成功:', data.session.user.email);
                        currentUser = data.session.user;
                        await loadUserProfile();
                        await syncProgressFromCloud();
                        updateAuthUI();

                        // URLをクリーンアップ
                        window.history.replaceState(null, '', window.location.pathname);
                        return;
                    } else {
                        console.log('⚠️ OAuthトークンはあるがセッションなし');
                    }
                }

                // 通常のセッション確認
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

                if (sessionError) {
                    console.error('セッションエラー:', sessionError);
                }

                if (session) {
                    console.log('✅ ログイン済みユーザー検出:', session.user.email);
                    currentUser = session.user;
                    await loadUserProfile();
                    await syncProgressFromCloud();
                    updateAuthUI();
                } else {
                    console.log('ℹ️ 未ログイン状態');
                    updateAuthUI();
                }

                // 認証状態の変更を監視
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    console.log('🔔 認証状態変更:', event, session?.user?.email);

                    if (event === 'SIGNED_IN' && session) {
                        console.log('📥 ログインイベント検出');
                        currentUser = session.user;
                        await loadUserProfile();
                        await syncProgressFromCloud();
                        updateAuthUI();
                    } else if (event === 'SIGNED_OUT') {
                        console.log('📤 ログアウトイベント検出');
                        currentUser = null;
                        userProfile = null;
                        updateAuthUI();
                    } else if (event === 'TOKEN_REFRESHED') {
                        console.log('🔄 トークンリフレッシュ');
                    } else if (event === 'INITIAL_SESSION') {
                        console.log('🏁 初期セッション:', session?.user?.email || 'なし');
                        if (session) {
                            currentUser = session.user;
                            await loadUserProfile();
                            await syncProgressFromCloud();
                            updateAuthUI();
                        }
                    }
                });
            } catch (error) {
                console.error('Supabase初期化エラー:', error);
            }
        }

        // ユーザープロフィール読み込み
        async function loadUserProfile() {
            if (!supabaseClient || !currentUser) return;

            console.log('👤 プロフィール読み込み中...', currentUser.id);
            console.log('📧 メタデータ:', currentUser.user_metadata);

            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('nickname')
                    .eq('id', currentUser.id)
                    .single();

                if (data) {
                    console.log('✅ プロフィール取得成功:', data);
                    userProfile = data;
                } else {
                    console.log('ℹ️ プロフィールなし、作成中...');
                    // プロフィールがない場合（Googleログインなど）、作成を試みる
                    const nickname = currentUser.user_metadata?.nickname ||
                        currentUser.user_metadata?.full_name ||
                        currentUser.user_metadata?.name ||
                        currentUser.email?.split('@')[0] ||
                        'Player';

                    console.log('📝 ニックネーム候補:', nickname);

                    const { data: newProfile, error: insertError } = await supabaseClient
                        .from('profiles')
                        .upsert({ id: currentUser.id, nickname: nickname })
                        .select()
                        .single();

                    if (newProfile) {
                        console.log('✅ プロフィール作成成功:', newProfile);
                        userProfile = newProfile;
                    } else {
                        console.log('⚠️ プロフィール作成失敗、フォールバック使用:', insertError);
                        // 挿入失敗してもフォールバック
                        userProfile = { nickname: nickname };
                    }
                }
            } catch (error) {
                console.error('プロフィール読み込みエラー:', error);
                // エラー時もフォールバック
                const nickname = currentUser.user_metadata?.nickname ||
                    currentUser.user_metadata?.full_name ||
                    currentUser.email?.split('@')[0] ||
                    'Player';
                userProfile = { nickname: nickname };
                console.log('⚠️ フォールバックプロフィール使用:', userProfile);
            }
        }

        // 認証UI更新
        function updateAuthUI() {
            const loginStatusDot = document.getElementById('loginStatusDot');
            const loginStatusCard = document.getElementById('loginStatusCard');
            const loginStatusText = document.getElementById('loginStatusText');
            const settingsNotLoggedIn = document.getElementById('settingsNotLoggedIn');
            const settingsLoggedIn = document.getElementById('settingsLoggedIn');
            const settingsPasswordChange = document.getElementById('settingsPasswordChange');

            console.log('🔄 UI更新中... currentUser:', !!currentUser, 'userProfile:', userProfile);

            if (currentUser && userProfile) {
                console.log('✅ ログイン状態でUI更新:', userProfile.nickname);

                // Header status dot
                if (loginStatusDot) {
                    loginStatusDot.classList.add('logged-in');
                }

                // Settings modal - logged in view
                if (loginStatusCard) {
                    loginStatusCard.classList.add('logged-in');
                    loginStatusCard.classList.remove('not-logged-in');
                }
                if (loginStatusText) {
                    loginStatusText.textContent = `${userProfile.nickname} でログイン中`;
                }

                // Show/hide sections
                if (settingsNotLoggedIn) settingsNotLoggedIn.style.display = 'none';
                if (settingsLoggedIn) settingsLoggedIn.style.display = 'block';
                if (settingsPasswordChange) settingsPasswordChange.style.display = 'none';

                // Update profile fields
                const nicknameInput = document.getElementById('settingsNickname');
                const emailInput = document.getElementById('settingsEmail');
                if (nicknameInput) nicknameInput.value = userProfile.nickname || '';
                if (emailInput) emailInput.value = currentUser.email || '';

                // Update stats
                updateSettingsStats();

            } else {
                console.log('ℹ️ 未ログイン状態でUI更新');

                // Header status dot
                if (loginStatusDot) {
                    loginStatusDot.classList.remove('logged-in');
                }

                // Settings modal - not logged in view
                if (loginStatusCard) {
                    loginStatusCard.classList.remove('logged-in');
                    loginStatusCard.classList.add('not-logged-in');
                }
                if (loginStatusText) {
                    loginStatusText.textContent = 'ログインしていません';
                }

                // Show/hide sections
                if (settingsNotLoggedIn) settingsNotLoggedIn.style.display = 'block';
                if (settingsLoggedIn) settingsLoggedIn.style.display = 'none';
                if (settingsPasswordChange) settingsPasswordChange.style.display = 'none';
            }
        }

        // 設定画面の統計情報を更新
        function updateSettingsStats() {
            const completedEl = document.getElementById('settingsCompletedLevels');
            const starsEl = document.getElementById('settingsTotalStars');
            const charEl = document.getElementById('settingsCharacter');

            if (completedEl) completedEl.textContent = `${completedLevels.size} / 100`;
            if (starsEl) starsEl.textContent = totalStarsEarned;
            if (charEl && selectedCharacter) charEl.textContent = selectedCharacter.name;
        }

        // 設定画面のメッセージ表示
        function showSettingsMessage(type, message) {
            const msgEl = document.getElementById('settingsMessage');
            if (msgEl) {
                msgEl.textContent = message;
                msgEl.className = 'settings-message ' + type;
                setTimeout(() => {
                    msgEl.className = 'settings-message';
                }, 3000);
            }
        }

        // ログイン処理
        async function handleLogin(email, password) {
            if (!supabaseClient) {
                showAuthError('Supabaseが設定されていません');
                return false;
            }

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                showAuthSuccess('ログイン成功！');
                setTimeout(() => {
                    document.getElementById('authModal').classList.remove('show');
                }, 1000);

                return true;
            } catch (error) {
                showAuthError(error.message);
                return false;
            }
        }

        // 登録処理
        async function handleRegister(email, password, nickname) {
            if (!supabaseClient) {
                showAuthError('Supabaseが設定されていません');
                return false;
            }

            try {
                // ユーザー作成（ニックネームをメタデータとして送信）
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            nickname: nickname
                        }
                    }
                });

                if (authError) throw authError;

                // メール確認が必要な場合
                if (authData.user && !authData.session) {
                    showAuthSuccess('登録成功！メールを確認してください。');
                } else {
                    showAuthSuccess('登録成功！');
                    setTimeout(() => {
                        document.getElementById('authModal').classList.remove('show');
                    }, 1000);
                }

                return true;
            } catch (error) {
                showAuthError(error.message);
                return false;
            }
        }

        // ログアウト処理
        async function handleLogout() {
            if (!supabaseClient) return;

            try {
                showSyncStatus('syncing', 'ログアウト中...');
                await supabaseClient.auth.signOut();
                currentUser = null;
                userProfile = null;

                // ローカルの進捗をリセット（オプション：コメントアウトで進捗を保持）
                completedLevels = new Set();
                totalStarsEarned = 0;
                levelStars = {};
                updateStats();
                updateLevelButtons();

                updateAuthUI();
                showSyncStatus('synced', 'ログアウト完了');
            } catch (error) {
                console.error('ログアウトエラー:', error);
                showSyncStatus('error', 'ログアウトエラー');
            }
        }

        // Googleログイン処理
        async function handleGoogleLogin() {
            if (!supabaseClient) {
                showAuthError('Supabaseが設定されていません');
                return false;
            }

            try {
                const redirectUrl = window.location.origin + window.location.pathname;
                console.log('🔗 Googleログイン開始, リダイレクト先:', redirectUrl);

                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: redirectUrl,
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent'
                        }
                    }
                });

                if (error) throw error;

                console.log('📤 Googleへリダイレクト中...');
                return true;
            } catch (error) {
                console.error('Googleログインエラー:', error);
                showAuthError(error.message);
                return false;
            }
        }

        // パスワードリセット処理
        async function handlePasswordReset(email) {
            if (!supabaseClient) {
                showAuthError('Supabaseが設定されていません');
                return false;
            }

            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + window.location.pathname
                });

                if (error) throw error;

                showAuthSuccess('パスワードリセット用のメールを送信しました。メールを確認してください。');
                return true;
            } catch (error) {
                showAuthError(error.message);
                return false;
            }
        }

        async function syncProgressFromCloud() {
            if (!supabaseClient || !currentUser) return;

            showSyncStatus('syncing', 'データ復元中...');

            try {
                // ユーザー設定を取得（キャラクター、テーマ、総星数）
                const { data: profileData, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('total_stars, selected_character, theme, player_level')
                    .eq('id', currentUser.id)
                    .single();

                if (profileData) {
                    // キャラクター復元
                    if (profileData.selected_character) {
                        const charIndex = characters.findIndex(c => c.id === profileData.selected_character);
                        if (charIndex !== -1) {
                            selectedCharacter = characters[charIndex];
                            localStorage.setItem('codequest-character', profileData.selected_character);
                            console.log('🤖 キャラクター復元:', profileData.selected_character);
                        }
                    }

                    // テーマ復元
                    if (profileData.theme) {
                        const isDark = profileData.theme === 'dark';
                        if (isDark) {
                            document.body.classList.remove('light-mode');
                        } else {
                            document.body.classList.add('light-mode');
                        }
                        localStorage.setItem('codequest-theme', profileData.theme);
                        updateThemeButton();
                        console.log('🎨 テーマ復元:', profileData.theme);
                    }

                    // プレイヤーレベル復元
                    if (profileData.player_level !== undefined && profileData.player_level !== null) {
                        userLevel = profileData.player_level;
                        localStorage.setItem('codequest-userLevel', userLevel);
                        console.log('📈 プレイヤーレベル復元:', userLevel);
                    }
                }

                // 進捗データを取得（レベルIDと星の数）
                const { data: progressData, error: progressError } = await supabaseClient
                    .from('progress')
                    .select('level_id, stars')
                    .eq('user_id', currentUser.id);

                if (progressError) throw progressError;

                if (progressData && progressData.length > 0) {
                    // クラウドのデータで上書き
                    completedLevels = new Set();
                    levelStars = {};
                    totalStarsEarned = 0;

                    progressData.forEach(p => {
                        completedLevels.add(p.level_id);
                        const stars = p.stars || 1;
                        levelStars[p.level_id] = stars;
                        totalStarsEarned += stars;
                    });

                    console.log('📊 進捗復元:', completedLevels.size, 'レベル,', totalStarsEarned, '星');
                    updateStats();
                    updateLevelButtons();
                }

                showSyncStatus('synced', 'データ復元完了');
            } catch (error) {
                console.error('同期エラー:', error);
                showSyncStatus('error', '同期エラー');
            }
        }

        // 進捗をクラウドに保存
        async function saveProgressToCloud(levelId, stars = 1) {
            if (!supabaseClient || !currentUser) return;

            showSyncStatus('syncing', '保存中...');

            try {
                // 進捗を保存
                const { error: progressError } = await supabaseClient
                    .from('progress')
                    .upsert({
                        user_id: currentUser.id,
                        level_id: levelId,
                        stars: stars,
                        completed_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,level_id'
                    });

                if (progressError) throw progressError;

                // 総星数とプレイヤーレベルを更新
                await supabaseClient
                    .from('profiles')
                    .update({
                        total_stars: totalStarsEarned,
                        player_level: userLevel
                    })
                    .eq('id', currentUser.id);

                showSyncStatus('synced', '保存完了');
            } catch (error) {
                console.error('保存エラー:', error);
                showSyncStatus('error', '保存エラー');
            }
        }

        // ユーザー設定をクラウドに保存
        async function saveUserSettingsToCloud() {
            if (!supabaseClient || !currentUser) return;

            try {
                const theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
                const characterId = selectedCharacter?.id || 'pixel';

                await supabaseClient
                    .from('profiles')
                    .update({
                        selected_character: characterId,
                        theme: theme,
                        total_stars: totalStarsEarned
                    })
                    .eq('id', currentUser.id);

                console.log('💾 設定保存:', { character: characterId, theme: theme });
            } catch (error) {
                console.error('設定保存エラー:', error);
            }
        }

        // テーマボタン更新
        function updateThemeButton() {
            const isDark = !document.body.classList.contains('light-mode');
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            if (themeIcon) themeIcon.textContent = isDark ? '🌙' : '☀️';
            if (themeText) themeText.textContent = isDark ? 'ダーク' : 'ライト';
        }

        // 同期ステータス表示
        function showSyncStatus(status, text) {
            const indicator = document.getElementById('syncIndicator');
            const icon = document.getElementById('syncIcon');
            const textEl = document.getElementById('syncText');

            indicator.style.display = 'flex';
            indicator.className = 'sync-indicator ' + status;
            textEl.textContent = text;

            if (status === 'syncing') {
                icon.textContent = '🔄';
            } else if (status === 'synced') {
                icon.textContent = '✅';
                setTimeout(() => { indicator.style.display = 'none'; }, 2000);
            } else {
                icon.textContent = '❌';
            }
        }

        // エラー表示
        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            document.getElementById('authSuccess').classList.remove('show');
        }

        // 成功表示
        function showAuthSuccess(message) {
            const successEl = document.getElementById('authSuccess');
            successEl.textContent = message;
            successEl.classList.add('show');
            document.getElementById('authError').classList.remove('show');
        }

        // ===== CHARACTERS =====
        const characters = [
            {
                id: 'pixel',
                name: 'Pixel',
                desc: 'クラシックロボット',
                image: 'robot_default.png'
            },
            {
                id: 'blaze',
                name: 'Blaze',
                desc: '炎のロボット',
                image: 'robot_orange.png'
            },
            {
                id: 'nova',
                name: 'Nova',
                desc: '愛のロボット',
                image: 'robot_purpul.png'
            },
            {
                id: 'leaf',
                name: 'Leaf',
                desc: '自然ロボット',
                image: 'robot_green.png'
            },
            {
                id: 'frost',
                name: 'Thunder',
                desc: '雷のロボット',
                image: 'robot_yellow.png'
            },
            {
                id: 'shadow',
                name: 'Shadow',
                desc: '影のロボット',
                image: 'robot_green_red.png'
            }
        ];

        // Preload character images
        const characterImages = {};
        let imagesLoaded = 0;
        characters.forEach(char => {
            const img = new Image();
            img.onload = () => {
                imagesLoaded++;
                // Redraw canvas when default character image loads
                if (char.id === 'pixel' || imagesLoaded === characters.length) {
                    if (typeof drawCanvas === 'function') {
                        drawCanvas();
                    }
                }
            };
            img.src = char.image;
            characterImages[char.id] = img;
        });


        let selectedCharacter = characters[0];
        let isDarkMode = localStorage.getItem('isDarkMode') !== 'false';

        // ===== THEME TOGGLE =====
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('isDarkMode', isDarkMode);
            document.body.classList.toggle('light-mode', !isDarkMode);
            document.getElementById('themeIcon').textContent = isDarkMode ? '🌙' : '☀️';
            document.getElementById('themeText').textContent = isDarkMode ? 'ダーク' : 'ライト';
            localStorage.setItem('codequest-theme', isDarkMode ? 'dark' : 'light');
            drawCanvas();

            // クラウドに保存
            saveUserSettingsToCloud();
        }

        // ===== CHARACTER SELECTOR =====
        function initCharacterSelector() {
            const grid = document.getElementById('characterGrid');
            grid.innerHTML = '';

            characters.forEach((char, index) => {
                const card = document.createElement('div');
                card.className = 'character-card' + (char.id === selectedCharacter.id ? ' selected' : '');
                card.innerHTML = `
                    <div class="character-preview">
                        <canvas id="charPreview${index}" width="90" height="90"></canvas>
                    </div>
                    <div class="character-name">${char.name}</div>
                    <div class="character-desc">${char.desc}</div>
                `;
                card.addEventListener('click', () => selectCharacter(char, card));
                grid.appendChild(card);

                // Draw preview
                setTimeout(() => drawCharacterPreview(index, char), 10);
            });
        }

        function drawCharacterPreview(index, char) {
            const canvas = document.getElementById('charPreview' + index);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 90, 90);

            // Draw the PNG image (1.5x bigger)
            const img = characterImages[char.id];
            if (img && img.complete) {
                ctx.drawImage(img, 7, 7, 76, 76);
            } else {
                // If image not loaded yet, wait and redraw
                img.onload = () => {
                    ctx.clearRect(0, 0, 90, 90);
                    ctx.drawImage(img, 7, 7, 76, 76);
                };
            }
        }

        function selectCharacter(char, card) {
            selectedCharacter = char;
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            localStorage.setItem('codequest-character', char.id);
            drawCanvas();

            // Update floating background robots
            updateFloatingRobots(char.image);

            // クラウドに保存
            saveUserSettingsToCloud();
        }

        function updateFloatingRobots(imageSrc) {
            document.getElementById('floatingRobot1').src = imageSrc;
            document.getElementById('floatingRobot2').src = imageSrc;
            document.getElementById('floatingRobot3').src = imageSrc;
        }

        function loadSavedPreferences() {
            // Load theme
            const savedTheme = localStorage.getItem('codequest-theme');
            if (savedTheme === 'light') {
                isDarkMode = false;
                document.body.classList.add('light-mode');
                document.getElementById('themeIcon').textContent = '☀️';
                document.getElementById('themeText').textContent = 'ライト';
            }

            // Load character
            const savedChar = localStorage.getItem('codequest-character');
            if (savedChar) {
                const found = characters.find(c => c.id === savedChar);
                if (found) {
                    selectedCharacter = found;
                    updateFloatingRobots(found.image);
                }
            }
        }

        // ===== LEVEL DATA =====
        const levels = [
            // ===== WORLD 1: BASICS (1-20) =====
            {
                id: 1, world: 1,
                title: "🚀 最初の一歩",
                description: "ロボットを右に <strong>2マス</strong> 動かそう!<br><code>robot.move()</code> で1マス移動。",
                initialCode: "// robot.move() を使おう!\n\n",
                hint: "move() を2回書こう",
                goalX: 2, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 2 && r.y === 0
            },
            {
                id: 2, world: 1,
                title: "🏃 3マス進め",
                description: "右に <strong>3マス</strong> 移動しよう!",
                initialCode: "// 3マス進もう!\n\n",
                hint: "move() を3回",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === 0
            },
            {
                id: 3, world: 1,
                title: "🎯 4マス進め",
                description: "右に <strong>4マス</strong> 移動しよう!",
                initialCode: "// 4マス進もう!\n\n",
                hint: "move() を4回",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 4 && r.y === 0
            },
            {
                id: 4, world: 1,
                title: "⬆️ 上に移動",
                description: "<code>robot.moveUp()</code> で上に移動!<br>右に1マス、上に1マス。",
                initialCode: "// moveUp() を使おう!\n\n",
                hint: "move() で右、moveUp() で上",
                goalX: 1, goalY: -1,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 1 && r.y === -1
            },
            {
                id: 5, world: 1,
                title: "⬇️ 下に移動",
                description: "<code>robot.moveDown()</code> で下に移動!<br>右に1マス、下に1マス。",
                initialCode: "// moveDown() を使おう!\n\n",
                hint: "move() で右、moveDown() で下",
                goalX: 1, goalY: 1,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 1 && r.y === 1
            },
            {
                id: 6, world: 1,
                title: "↗️ 斜め移動",
                description: "右に2マス、上に1マス進もう!",
                initialCode: "// 右と上を組み合わせ!\n\n",
                hint: "move()を2回、moveUp()を1回",
                goalX: 2, goalY: -1,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 2 && r.y === -1
            },
            {
                id: 7, world: 1,
                title: "↘️ 反対の斜め",
                description: "右に2マス、下に1マス進もう!",
                initialCode: "// 右と下を組み合わせ!\n\n",
                hint: "move()を2回、moveDown()を1回",
                goalX: 2, goalY: 1,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 2 && r.y === 1
            },
            {
                id: 8, world: 1,
                title: "🔼 上に2マス",
                description: "右に1マス、上に2マス進もう!",
                initialCode: "// 上に2回移動!\n\n",
                hint: "moveUp()を2回使おう",
                goalX: 1, goalY: -2,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 1 && r.y === -2
            },
            {
                id: 9, world: 1,
                title: "⭐ 星を集めよう",
                description: "<code>robot.collect()</code> で星を収集!<br>位置1の星を集めてゴールへ。",
                initialCode: "// collect() で星を集めよう!\n\n",
                hint: "星の位置で collect() を呼ぼう",
                goalX: 2, goalY: 0,
                obstacles: [], stars: [1], gems: [],
                validate: (r) => r.x === 2 && r.starsCollected >= 1
            },
            {
                id: 10, world: 1,
                title: "⭐⭐ 2つの星",
                description: "2つの星を集めよう!<br>星は位置1と2にあります。",
                initialCode: "// 2つ集めよう!\n\n",
                hint: "移動して collect() を繰り返す",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [1, 2], gems: [],
                validate: (r) => r.x === 3 && r.starsCollected >= 2
            },
            {
                id: 11, world: 1,
                title: "🧱 障害物だ!",
                description: "<code>robot.jump()</code> で障害物を飛び越えよう!",
                initialCode: "// jump() でジャンプ!\n\n",
                hint: "障害物の手前で jump()",
                goalX: 2, goalY: 0,
                obstacles: [{ x: 1, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 2 && !r.hitObstacle
            },
            {
                id: 12, world: 1,
                title: "🧱➡️ ジャンプと移動",
                description: "ジャンプして、さらに1マス進もう!",
                initialCode: "// ジャンプ後も移動!\n\n",
                hint: "jump() の後に move()",
                goalX: 3, goalY: 0,
                obstacles: [{ x: 1, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 3 && !r.hitObstacle
            },
            {
                id: 13, world: 1,
                title: "💎 ジェムを集めろ",
                description: "<code>robot.collectGem()</code> でジェム収集!",
                initialCode: "// collectGem() を使おう!\n\n",
                hint: "ジェムの位置で collectGem()",
                goalX: 2, goalY: 0,
                obstacles: [], stars: [], gems: [1],
                validate: (r) => r.x === 2 && r.gemsCollected >= 1
            },
            {
                id: 14, world: 1,
                title: "⭐💎 星とジェム",
                description: "星とジェムを両方集めよう!",
                initialCode: "// 両方集めよう!\n\n",
                hint: "collect() と collectGem() を使い分け",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [1], gems: [2],
                validate: (r) => r.x === 3 && r.starsCollected >= 1 && r.gemsCollected >= 1
            },
            {
                id: 15, world: 1,
                title: "🏔️ 上下の冒険",
                description: "上に行って星を取り、下に戻ろう!",
                initialCode: "// 上下移動で星を取ろう!\n\n",
                hint: "moveUp() → collect() → moveDown()",
                goalX: 1, goalY: 0,
                obstacles: [], stars: [1], gems: [],
                validate: (r) => r.x === 1 && r.y === 0 && r.starsCollected >= 1
            },
            {
                id: 16, world: 1,
                title: "🎯 精密操作",
                description: "障害物を避けて星を集めよう!",
                initialCode: "// ジャンプして星を取ろう!\n\n",
                hint: "jump() で飛び越えた後に collect()",
                goalX: 3, goalY: 0,
                obstacles: [{ x: 1, y: 0 }], stars: [2], gems: [],
                validate: (r) => r.x === 3 && r.starsCollected >= 1 && !r.hitObstacle
            },
            {
                id: 17, world: 1,
                title: "🌟 3つの星",
                description: "3つの星を全部集めよう!",
                initialCode: "// 3つ全部!\n\n",
                hint: "位置1,2,3で collect()",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [],
                validate: (r) => r.x === 4 && r.starsCollected >= 3
            },
            {
                id: 18, world: 1,
                title: "🧱🧱 2つの障害物",
                description: "2つの障害物を飛び越えよう!",
                initialCode: "// 2回ジャンプ!\n\n",
                hint: "jump() を2回使おう",
                goalX: 4, goalY: 0,
                obstacles: [{ x: 1, y: 0 }, { x: 3, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 4 && !r.hitObstacle
            },
            {
                id: 19, world: 1,
                title: "💎💎 2つのジェム",
                description: "2つのジェムを集めよう!",
                initialCode: "// ジェム2つ!\n\n",
                hint: "collectGem() を2回",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [], gems: [1, 2],
                validate: (r) => r.x === 3 && r.gemsCollected >= 2
            },
            {
                id: 20, world: 1,
                title: "🏆 基礎マスター",
                description: "全スキルを使ってゴールへ!<br>障害物、星、ジェムに対応!",
                initialCode: "// 基礎の集大成!\n\n",
                hint: "jump, collect, collectGem を組み合わせ",
                goalX: 5, goalY: 0,
                obstacles: [{ x: 2, y: 0 }], stars: [1, 4], gems: [3],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && r.gemsCollected >= 1 && !r.hitObstacle
            },

            // ===== WORLD 2: LOOPS (21-40) =====
            {
                id: 21, world: 2,
                title: "🔄 forループ入門",
                description: "<code>for</code>ループで3マス移動!",
                initialCode: "// for (let i = 0; i < 回数; i++) { }\n\n",
                hint: "for の中に move() を入れよう",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === 0
            },
            {
                id: 22, world: 2,
                title: "🔄 5マスループ",
                description: "forループで5マス移動しよう!",
                initialCode: "// 5回ループ!\n\n",
                hint: "i < 5 でループ",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 5 && r.y === 0
            },
            {
                id: 23, world: 2,
                title: "🔁 whileループ",
                description: "<code>while (robot.x < 4)</code> で移動!",
                initialCode: "// while (条件) { }\n\n",
                hint: "robot.x < 4 の間ループ",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 4 && r.y === 0
            },
            {
                id: 24, world: 2,
                title: "⭐ ループで星",
                description: "ループで移動して星を集めよう!",
                initialCode: "// ループで星集め!\n\n",
                hint: "ループ内で move() と collect()",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [],
                validate: (r) => r.x === 4 && r.starsCollected >= 3
            },
            {
                id: 25, world: 2,
                title: "🔢 変数を使おう",
                description: "<code>let steps = 3;</code> でループ回数を指定!",
                initialCode: "let steps = 3;\n// steps を使ってループ!\n\n",
                hint: "for の条件に steps を使う",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === 0
            },
            {
                id: 26, world: 2,
                title: "🧱 ループでジャンプ",
                description: "連続した障害物をループでジャンプ!",
                initialCode: "// ループでジャンプ!\n\n",
                hint: "for で jump() を繰り返す",
                goalX: 3, goalY: 0,
                obstacles: [{ x: 1, y: 0 }, { x: 2, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 3 && !r.hitObstacle
            },
            {
                id: 27, world: 2,
                title: "💎 ループでジェム",
                description: "ループでジェムを全部集めよう!",
                initialCode: "// ジェムをループで!\n\n",
                hint: "move() と collectGem() をループ",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [1, 2, 3],
                validate: (r) => r.x === 4 && r.gemsCollected >= 3
            },
            {
                id: 28, world: 2,
                title: "⬆️ ループで上昇",
                description: "ループで上に3マス移動!",
                initialCode: "// ループで上へ!\n\n",
                hint: "moveUp() をループ",
                goalX: 1, goalY: -3,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 1 && r.y === -3
            },
            {
                id: 29, world: 2,
                title: "🔀 2つのループ",
                description: "右に3マス、上に2マス!<br>2つのループを使おう。",
                initialCode: "// 2つのループ!\n\n",
                hint: "最初のforで右、次のforで上",
                goalX: 3, goalY: -2,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === -2
            },
            {
                id: 30, world: 2,
                title: "⭐💎 両方集め",
                description: "ループで星とジェムを両方!",
                initialCode: "// 両方集めよう!\n\n",
                hint: "collect() と collectGem() を両方ループ内で",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [1, 2, 3],
                validate: (r) => r.x === 4 && r.starsCollected >= 3 && r.gemsCollected >= 3
            },
            {
                id: 31, world: 2,
                title: "🔄 6マスループ",
                description: "forループで6マス移動!",
                initialCode: "// 6回ループ!\n\n",
                hint: "i < 6 でループ",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 6 && r.y === 0
            },
            {
                id: 32, world: 2,
                title: "🌀 whileで星集め",
                description: "whileループで星を集めながら進もう!",
                initialCode: "// whileで星集め!\n\n",
                hint: "while (robot.x < 5) で星を集めながら",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 2, 3, 4], gems: [],
                validate: (r) => r.x === 5 && r.starsCollected >= 4
            },
            {
                id: 33, world: 2,
                title: "🧱🧱🧱 3つの障害物",
                description: "3つの連続障害物をループでジャンプ!",
                initialCode: "// 3回ジャンプ!\n\n",
                hint: "for で3回 jump()",
                goalX: 4, goalY: 0,
                obstacles: [{ x: 1, y: 0 }, { x: 2, y: 0 }, { x: 3, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 4 && !r.hitObstacle
            },
            {
                id: 34, world: 2,
                title: "⬇️ ループで下降",
                description: "右に2マス、下に3マス!",
                initialCode: "// 右と下のループ!\n\n",
                hint: "2つのfor文を使おう",
                goalX: 2, goalY: 3,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 2 && r.y === 3
            },
            {
                id: 35, world: 2,
                title: "🔢 変数で星",
                description: "変数 count で何個集めたか数えよう!",
                initialCode: "let count = 0;\n// ループで数えながら集めよう!\n\n",
                hint: "collect() の後に count++ で数える",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [],
                validate: (r) => r.x === 4 && r.starsCollected >= 3
            },
            {
                id: 36, world: 2,
                title: "🔁 while条件",
                description: "星が3個になるまで進もう!",
                initialCode: "// while (robot.starsCollected < 3)\n\n",
                hint: "starsCollected をチェック",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 3, 5], gems: [],
                validate: (r) => r.starsCollected >= 3
            },
            {
                id: 37, world: 2,
                title: "💎💎💎💎 4つのジェム",
                description: "4つのジェムをループで!",
                initialCode: "// 4つ集めよう!\n\n",
                hint: "4回ループで collectGem()",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [1, 2, 3, 4],
                validate: (r) => r.x === 5 && r.gemsCollected >= 4
            },
            {
                id: 38, world: 2,
                title: "📐 四角形パス",
                description: "右に2マス、上に2マス進もう!",
                initialCode: "// 四角形の角へ!\n\n",
                hint: "2つのfor文で右と上",
                goalX: 2, goalY: -2,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 2 && r.y === -2
            },
            {
                id: 39, world: 2,
                title: "⭐ 5つの星",
                description: "5つの星を全部集めよう!",
                initialCode: "// 5つ全部!\n\n",
                hint: "5回ループで move() と collect()",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [1, 2, 3, 4, 5], gems: [],
                validate: (r) => r.x === 6 && r.starsCollected >= 5
            },
            {
                id: 40, world: 2,
                title: "🏆 ループマスター",
                description: "ループを駆使して全部集めよう!",
                initialCode: "// ループの集大成!\n\n",
                hint: "for文で障害物を避けながら星とジェムを",
                goalX: 7, goalY: 0,
                obstacles: [{ x: 3, y: 0 }], stars: [1, 2, 5, 6], gems: [4],
                validate: (r) => r.x === 7 && r.starsCollected >= 4 && r.gemsCollected >= 1 && !r.hitObstacle
            },

            // ===== WORLD 3: CONDITIONS (41-60) =====
            {
                id: 41, world: 3,
                title: "❓ if文入門",
                description: "<code>if (robot.isObstacle())</code> で障害物チェック!",
                initialCode: "// if で障害物をチェック!\nfor (let i = 0; i < 3; i++) {\n  // ここにif文\n}\n",
                hint: "isObstacle() が true なら jump()",
                goalX: 3, goalY: 0,
                obstacles: [{ x: 1, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 3 && !r.hitObstacle
            },
            {
                id: 42, world: 3,
                title: "🔀 if-else",
                description: "障害物があれば jump、なければ move!",
                initialCode: "// if-else を使おう!\nfor (let i = 0; i < 4; i++) {\n  \n}\n",
                hint: "if (障害物) { jump } else { move }",
                goalX: 4, goalY: 0,
                obstacles: [{ x: 2, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 4 && !r.hitObstacle
            },
            {
                id: 43, world: 3,
                title: "⭐ 星チェック",
                description: "<code>robot.isStar()</code> で星をチェック!",
                initialCode: "// 星があるときだけ collect!\n\n",
                hint: "if (robot.isStar()) { collect() }",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [2, 4], gems: [],
                validate: (r) => r.x === 4 && r.starsCollected >= 2
            },
            {
                id: 44, world: 3,
                title: "💎 ジェムチェック",
                description: "<code>robot.isGem()</code> でジェムをチェック!",
                initialCode: "// ジェムがあるときだけ collectGem!\n\n",
                hint: "if (robot.isGem()) { collectGem() }",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [1, 3],
                validate: (r) => r.x === 4 && r.gemsCollected >= 2
            },
            {
                id: 45, world: 3,
                title: "🔀 else if",
                description: "複数の条件を else if で処理!",
                initialCode: "// if, else if, else を使おう!\n\n",
                hint: "障害物→星→移動 の順でチェック",
                goalX: 5, goalY: 0,
                obstacles: [{ x: 2, y: 0 }], stars: [1, 4], gems: [],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && !r.hitObstacle
            },
            {
                id: 46, world: 3,
                title: "🎯 ゴールチェック",
                description: "<code>robot.isGoal()</code> でゴールを検知!",
                initialCode: "// ゴールまで進もう!\n\n",
                hint: "while (!robot.isGoal()) でループ",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 5
            },
            {
                id: 47, world: 3,
                title: "🧠 AND演算子",
                description: "<code>&&</code> で複数条件をチェック!",
                initialCode: "// && は「かつ」\n\n",
                hint: "条件A && 条件B で両方チェック",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 2, 3, 4], gems: [],
                validate: (r) => r.x === 5 && r.starsCollected >= 4
            },
            {
                id: 48, world: 3,
                title: "🧠 OR演算子",
                description: "<code>||</code> でどちらかの条件!",
                initialCode: "// || は「または」\n\n",
                hint: "星またはジェムがあれば収集",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 3], gems: [2, 4],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && r.gemsCollected >= 2
            },
            {
                id: 49, world: 3,
                title: "🚫 NOT演算子",
                description: "<code>!</code> で条件を反転!",
                initialCode: "// ! は「でない」\n\n",
                hint: "!robot.isObstacle() = 障害物がない",
                goalX: 4, goalY: 0,
                obstacles: [{ x: 2, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 4 && !r.hitObstacle
            },
            {
                id: 50, world: 3,
                title: "🔄 条件付きループ",
                description: "条件を満たす間ループしよう!",
                initialCode: "// while と if の組み合わせ!\n\n",
                hint: "while でループ、中で if で分岐",
                goalX: 6, goalY: 0,
                obstacles: [{ x: 2, y: 0 }, { x: 4, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 6 && !r.hitObstacle
            },
            {
                id: 51, world: 3,
                title: "⭐💎 両方チェック",
                description: "星とジェム、それぞれの条件で収集!",
                initialCode: "// 両方チェックしよう!\n\n",
                hint: "if (isStar) と if (isGem) を別々に",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 3], gems: [2, 4],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && r.gemsCollected >= 2
            },
            {
                id: 52, world: 3,
                title: "🧱⭐ 障害物と星",
                description: "障害物を避けつつ星を集めよう!",
                initialCode: "// 両方に対応!\n\n",
                hint: "まず障害物チェック、次に星チェック",
                goalX: 6, goalY: 0,
                obstacles: [{ x: 2, y: 0 }], stars: [1, 4, 5], gems: [],
                validate: (r) => r.x === 6 && r.starsCollected >= 3 && !r.hitObstacle
            },
            {
                id: 53, world: 3,
                title: "🔢 カウント条件",
                description: "星を3個集めるまで進もう!",
                initialCode: "// starsCollected で条件!\n\n",
                hint: "while (robot.starsCollected < 3)",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [1, 3, 5], gems: [],
                validate: (r) => r.starsCollected >= 3
            },
            {
                id: 54, world: 3,
                title: "📍 位置条件",
                description: "robot.x を使って条件分岐!",
                initialCode: "// 位置で条件を変えよう!\n\n",
                hint: "if (robot.x === 2) などで位置チェック",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [2], gems: [4],
                validate: (r) => r.x === 5 && r.starsCollected >= 1 && r.gemsCollected >= 1
            },
            {
                id: 55, world: 3,
                title: "🔀 複合条件",
                description: "複数の条件を組み合わせよう!",
                initialCode: "// && と || を組み合わせ!\n\n",
                hint: "(条件A && 条件B) || 条件C",
                goalX: 6, goalY: 0,
                obstacles: [{ x: 3, y: 0 }], stars: [1, 2, 5], gems: [4],
                validate: (r) => r.x === 6 && r.starsCollected >= 3 && r.gemsCollected >= 1 && !r.hitObstacle
            },
            {
                id: 56, world: 3,
                title: "🎯 ゴールまで収集",
                description: "ゴールまで全部集めよう!",
                initialCode: "// isGoal() まで収集!\n\n",
                hint: "while (!isGoal()) で収集しながら",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [1, 2, 3, 4, 5], gems: [],
                validate: (r) => r.x === 6 && r.starsCollected >= 5
            },
            {
                id: 57, world: 3,
                title: "🧱🧱 2障害物条件",
                description: "2つの障害物を条件で避けよう!",
                initialCode: "// 条件で障害物対応!\n\n",
                hint: "ループ内で isObstacle() チェック",
                goalX: 5, goalY: 0,
                obstacles: [{ x: 1, y: 0 }, { x: 3, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 5 && !r.hitObstacle
            },
            {
                id: 58, world: 3,
                title: "⭐⭐⭐⭐ 4つの星",
                description: "条件付きで4つの星を集めよう!",
                initialCode: "// 4つ全部!\n\n",
                hint: "if (isStar()) で星がある時だけ collect",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [1, 2, 4, 5], gems: [],
                validate: (r) => r.x === 6 && r.starsCollected >= 4
            },
            {
                id: 59, world: 3,
                title: "🌀 ネスト条件",
                description: "if の中に if を入れよう!",
                initialCode: "// ネストした条件!\n\n",
                hint: "if (条件A) { if (条件B) { ... } }",
                goalX: 5, goalY: 0,
                obstacles: [{ x: 2, y: 0 }], stars: [3, 4], gems: [],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && !r.hitObstacle
            },
            {
                id: 60, world: 3,
                title: "🏆 条件マスター",
                description: "全ての条件技術を使おう!",
                initialCode: "// 条件の集大成!\n\n",
                hint: "while, if, else, &&, || を全部使おう",
                goalX: 8, goalY: 0,
                obstacles: [{ x: 2, y: 0 }, { x: 5, y: 0 }], stars: [1, 3, 4, 6, 7], gems: [4],
                validate: (r) => r.x === 8 && r.starsCollected >= 5 && r.gemsCollected >= 1 && !r.hitObstacle
            },

            // ===== WORLD 4: FUNCTIONS (61-80) =====
            {
                id: 61, world: 4,
                title: "⚙️ 関数入門",
                description: "<code>function 名前() { }</code> で関数を作ろう!",
                initialCode: "// 関数を作って呼び出そう!\nfunction moveOnce() {\n  robot.move();\n}\n\n// 3回呼び出してゴールへ\n",
                hint: "関数を定義して、複数回呼び出す",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === 0
            },
            {
                id: 62, world: 4,
                title: "⚙️ moveTwo関数",
                description: "2マス移動する関数を作ろう!",
                initialCode: "function moveTwo() {\n  // 2マス移動する関数\n}\n\n// 呼び出して4マス進もう\n",
                hint: "関数内に move() を2回書く",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 4 && r.y === 0
            },
            {
                id: 63, world: 4,
                title: "📦 引数入門",
                description: "<code>function move(n)</code> で引数を使おう!",
                initialCode: "function moveN(n) {\n  // n回移動する関数\n}\n\n// moveN(4) で4マス進もう\n",
                hint: "関数内で for ループと引数 n を使う",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 4 && r.y === 0
            },
            {
                id: 64, world: 4,
                title: "⭐ 収集関数",
                description: "移動して収集する関数を作ろう!",
                initialCode: "function moveAndCollect() {\n  // 移動して収集\n}\n\n// 3回呼び出そう\n",
                hint: "関数内で move() と collect()",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [],
                validate: (r) => r.x === 3 && r.starsCollected >= 3
            },
            {
                id: 65, world: 4,
                title: "🧱 ジャンプ関数",
                description: "障害物処理を関数にしよう!",
                initialCode: "function handleMove() {\n  // 障害物があればジャンプ\n}\n\n// 4回呼び出そう\n",
                hint: "if (isObstacle()) を関数内に",
                goalX: 4, goalY: 0,
                obstacles: [{ x: 2, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 4 && !r.hitObstacle
            },
            {
                id: 66, world: 4,
                title: "🔙 return入門",
                description: "<code>return</code> で値を返そう!",
                initialCode: "function getX() {\n  return robot.x;\n}\n\n// 関数を使って移動\nwhile (getX() < 4) {\n  robot.move();\n}\n",
                hint: "return で現在位置を返す",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 4
            },
            {
                id: 67, world: 4,
                title: "🔢 カウント関数",
                description: "収集した数を返す関数を作ろう!",
                initialCode: "function collectAndCount() {\n  robot.move();\n  robot.collect();\n  return robot.starsCollected;\n}\n\n// 3回呼び出そう\n",
                hint: "collect() 後に starsCollected を return",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [],
                validate: (r) => r.x === 3 && r.starsCollected >= 3
            },
            {
                id: 68, world: 4,
                title: "⚙️⚙️ 2つの関数",
                description: "2つの関数を組み合わせよう!",
                initialCode: "function goRight() {\n  robot.move();\n}\n\nfunction goUp() {\n  robot.moveUp();\n}\n\n// 組み合わせて使おう\n",
                hint: "それぞれの関数を適切に呼び出す",
                goalX: 2, goalY: -2,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 2 && r.y === -2
            },
            {
                id: 69, world: 4,
                title: "📦 複数引数",
                description: "引数を2つ使う関数を作ろう!",
                initialCode: "function moveXY(x, y) {\n  // x回右、y回上に移動\n}\n\n// moveXY(3, 2) で移動\n",
                hint: "for文を2つ使って x と y 回移動",
                goalX: 3, goalY: -2,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === -2
            },
            {
                id: 70, world: 4,
                title: "🎯 条件付き関数",
                description: "条件分岐を含む関数を作ろう!",
                initialCode: "function smartMove() {\n  // 障害物チェックして移動\n}\n\n// ループで呼び出そう\n",
                hint: "if (isObstacle()) を関数内に",
                goalX: 5, goalY: 0,
                obstacles: [{ x: 2, y: 0 }, { x: 4, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 5 && !r.hitObstacle
            },
            {
                id: 71, world: 4,
                title: "⭐ 収集チェック関数",
                description: "星があれば収集する関数を作ろう!",
                initialCode: "function tryCollect() {\n  // 星があれば収集\n}\n\n// 移動しながら呼び出そう\n",
                hint: "if (isStar()) { collect() } を関数に",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 3, 5], gems: [],
                validate: (r) => r.x === 5 && r.starsCollected >= 3
            },
            {
                id: 72, world: 4,
                title: "💎 ジェム収集関数",
                description: "ジェムチェック関数を作ろう!",
                initialCode: "function tryCollectGem() {\n  // ジェムがあれば収集\n}\n\n",
                hint: "if (isGem()) { collectGem() }",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [1, 2, 4],
                validate: (r) => r.x === 5 && r.gemsCollected >= 3
            },
            {
                id: 73, world: 4,
                title: "🔀 分岐関数",
                description: "複数の分岐を含む関数を作ろう!",
                initialCode: "function step() {\n  // 障害物、星、ジェムをチェック\n}\n\n",
                hint: "if-else if-else で全ケース対応",
                goalX: 5, goalY: 0,
                obstacles: [{ x: 2, y: 0 }], stars: [1, 4], gems: [3],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && r.gemsCollected >= 1 && !r.hitObstacle
            },
            {
                id: 74, world: 4,
                title: "🔁 ループ関数",
                description: "ループを含む関数を作ろう!",
                initialCode: "function moveMany(n) {\n  // n回移動\n}\n\n// moveMany(5) で5マス\n",
                hint: "for (let i = 0; i < n; i++) を関数内に",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 5 && r.y === 0
            },
            {
                id: 75, world: 4,
                title: "🔙 bool関数",
                description: "true/false を返す関数を作ろう!",
                initialCode: "function canCollect() {\n  return robot.isStar() || robot.isGem();\n}\n\n// canCollect() を使おう\n",
                hint: "|| で星またはジェムをチェック",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 3], gems: [2, 4],
                validate: (r) => r.x === 5 && r.starsCollected >= 2 && r.gemsCollected >= 2
            },
            {
                id: 76, world: 4,
                title: "⚙️⚙️⚙️ 3つの関数",
                description: "3つの関数を連携させよう!",
                initialCode: "function handleObstacle() { }\nfunction collectStar() { }\nfunction collectGem() { }\n\n// 組み合わせて使おう\n",
                hint: "各関数に適切な処理を書く",
                goalX: 6, goalY: 0,
                obstacles: [{ x: 2, y: 0 }], stars: [1, 4, 5], gems: [3],
                validate: (r) => r.x === 6 && r.starsCollected >= 3 && r.gemsCollected >= 1 && !r.hitObstacle
            },
            {
                id: 77, world: 4,
                title: "🎯 ゴール関数",
                description: "ゴールまで進む関数を作ろう!",
                initialCode: "function goToGoal() {\n  // isGoal() までループ\n}\n\ngoToGoal();\n",
                hint: "while (!isGoal()) を関数内に",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 6
            },
            {
                id: 78, world: 4,
                title: "🌀 再帰的思考",
                description: "関数から関数を呼び出そう!",
                initialCode: "function step() {\n  // 1歩進む\n}\n\nfunction run() {\n  // step() を繰り返し呼ぶ\n}\n\nrun();\n",
                hint: "run() 内で for ループで step() を呼ぶ",
                goalX: 5, goalY: 0,
                obstacles: [{ x: 2, y: 0 }], stars: [1, 3, 4], gems: [],
                validate: (r) => r.x === 5 && r.starsCollected >= 3 && !r.hitObstacle
            },
            {
                id: 79, world: 4,
                title: "📊 統計関数",
                description: "収集数の合計を返す関数!",
                initialCode: "function getTotal() {\n  return robot.starsCollected + robot.gemsCollected;\n}\n\n// getTotal() を使おう\n",
                hint: "星とジェムの合計を return",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [4],
                validate: (r) => r.x === 5 && r.starsCollected >= 3 && r.gemsCollected >= 1
            },
            {
                id: 80, world: 4,
                title: "🏆 マスターチャレンジ",
                description: "全技術を使ってゴールへ!",
                initialCode: "// 最終チャレンジ!\n// 関数、ループ、条件を全部使おう!\n\n",
                hint: "smartMove, collectAll 関数を作り、whileでゴールまで",
                goalX: 9, goalY: 0,
                obstacles: [{ x: 2, y: 0 }, { x: 4, y: 0 }, { x: 7, y: 0 }],
                stars: [1, 3, 5, 6, 8], gems: [3, 6, 9],
                validate: (r) => r.x === 9 && r.starsCollected >= 5 && r.gemsCollected >= 3 && !r.hitObstacle
            },
            // ===== WORLD 5: DEBUG CHALLENGES (81-100) =====
            // バグのあるコードを修正して正しく動かそう!
            {
                id: 81, world: 5,
                title: "🐛 バグ修正1: タイプミス",
                description: "コードにタイプミスがあります。<br>正しく修正してゴールへ進もう!",
                initialCode: "// バグを見つけて修正しよう!\nrobot.mve();  // ← ここにバグ!\nrobot.move();\nrobot.move();\n",
                hint: "mve → move のタイプミス",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === 0
            },
            {
                id: 82, world: 5,
                title: "🐛 バグ修正2: 回数不足",
                description: "ゴールまで届いていません。<br>move()の回数を修正しよう!",
                initialCode: "// 5マス進むはずが...\nrobot.move();\nrobot.move();\nrobot.move();\n// ← 足りない!\n",
                hint: "move()が2回足りない",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 5 && r.y === 0
            },
            {
                id: 83, world: 5,
                title: "🐛 バグ修正3: 間違った関数",
                description: "上に行くべきなのに下に行ってる!<br>関数名を修正しよう!",
                initialCode: "// 上に行きたいのに...\nrobot.move();\nrobot.move();\nrobot.moveDown();  // ← 間違い!\n",
                hint: "moveDown → moveUp に修正",
                goalX: 2, goalY: -1,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 2 && r.y === -1
            },
            {
                id: 84, world: 5,
                title: "🐛 バグ修正4: forループ",
                description: "forループの回数が間違っています。<br>4回ではなく6回にしよう!",
                initialCode: "// 6マス進みたいのに...\nfor (let i = 0; i < 4; i++) {  // ← 回数が違う!\n  robot.move();\n}\n",
                hint: "i < 4 を i < 6 に修正",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 6 && r.y === 0
            },
            {
                id: 85, world: 5,
                title: "🐛 バグ修正5: セミコロン忘れ",
                description: "セミコロンが抜けています。<br>正しく追加しよう!",
                initialCode: "// セミコロンを忘れてる!\nrobot.move()\nrobot.move();\nrobot.move();\nrobot.move();\n",
                hint: "1行目の最後に ; を追加",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 4 && r.y === 0
            },
            {
                id: 86, world: 5,
                title: "🐛 バグ修正6: 括弧忘れ",
                description: "関数の括弧()が抜けています。<br>追加して修正しよう!",
                initialCode: "// 括弧を忘れてる!\nrobot.move;\n robot.move();\nrobot.move();\n",
                hint: "robot.move → robot.move()",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 3 && r.y === 0
            },
            {
                id: 87, world: 5,
                title: "🐛 バグ修正7: 星を忘れた",
                description: "星を集め忘れています!<br>collectStar()を追加しよう!",
                initialCode: "// 星を集め忘れてる!\nrobot.move();\nrobot.move();  // ← ここで星を集める!\nrobot.move();\nrobot.move();\n",
                hint: "2マス目でcollectStar()を追加",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [2], gems: [],
                validate: (r) => r.x === 4 && r.starsCollected >= 1
            },
            {
                id: 88, world: 5,
                title: "🐛 バグ修正8: while条件",
                description: "whileの条件が間違っています。<br>正しい条件に修正しよう!",
                initialCode: "// 5マス進みたいのに止まらない...\nwhile (robot.x < 10) {  // ← 条件が違う!\n  robot.move();\n}\n",
                hint: "x < 10 を x < 5 に修正",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 5 && r.y === 0
            },
            {
                id: 89, world: 5,
                title: "🐛 バグ修正9: 障害物衝突",
                description: "障害物にぶつかります!<br>避けるコードを追加しよう!",
                initialCode: "// 障害物を避けてない!\nrobot.move();\nrobot.move();\nrobot.move();  // ← ここで衝突!\nrobot.move();\nrobot.move();\n",
                hint: "3マス目の前でmoveUp、後でmoveDown",
                goalX: 5, goalY: 0,
                obstacles: [{ x: 3, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 5 && !r.hitObstacle
            },
            {
                id: 90, world: 5,
                title: "🐛 バグ修正10: 順序間違い",
                description: "コードの順序が間違っています。<br>正しい順序に直そう!",
                initialCode: "// 順序がおかしい!\nrobot.collectStar();  // ← まだ星の位置じゃない!\nrobot.move();\nrobot.move();\nrobot.move();\n",
                hint: "collectStarを2マス目の後に移動",
                goalX: 3, goalY: 0,
                obstacles: [], stars: [2], gems: [],
                validate: (r) => r.x === 3 && r.starsCollected >= 1
            },
            {
                id: 91, world: 5,
                title: "🐛 バグ修正11: 無限ループ",
                description: "ループが終わりません!<br>条件を修正しよう!",
                initialCode: "// 無限ループになってる!\nlet count = 0;\nwhile (count < 4) {\n  robot.move();\n  // ← countを増やし忘れ!\n}\n",
                hint: "count++ を追加",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 4 && r.y === 0
            },
            {
                id: 92, world: 5,
                title: "🐛 バグ修正12: if条件",
                description: "if文の条件が間違っています。<br>=== の数を確認しよう!",
                initialCode: "// 条件が間違ってる!\nfor (let i = 0; i < 5; i++) {\n  robot.move();\n  if (robot.x = 3) {  // ← = が1つ足りない!\n    robot.collectStar();\n  }\n}\n",
                hint: "= を === に修正",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [3], gems: [],
                validate: (r) => r.x === 5 && r.starsCollected >= 1
            },
            {
                id: 93, world: 5,
                title: "🐛 バグ修正13: 変数名",
                description: "変数名が間違っています。<br>正しい名前に修正しよう!",
                initialCode: "// 変数名が違う!\nfor (let i = 0; i < 4; i++) {\n  robot.move();\n}\nrobot.move();\nrobot.move();\n// 合計6マス進むはず\n",
                hint: "実行して結果を確認しよう",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 6 && r.y === 0
            },
            {
                id: 94, world: 5,
                title: "🐛 バグ修正14: 宝石忘れ",
                description: "宝石を集め忘れています!<br>2箇所でcollectGem()を追加!",
                initialCode: "// 宝石を集め忘れてる!\nrobot.move();\nrobot.move();  // ← 宝石!\nrobot.move();\nrobot.move();  // ← 宝石!\nrobot.move();\n",
                hint: "2マス目と4マス目でcollectGem()",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [2, 4],
                validate: (r) => r.x === 5 && r.gemsCollected >= 2
            },
            {
                id: 95, world: 5,
                title: "🐛 バグ修正15: 関数呼び出し",
                description: "関数を定義したけど呼び出していない!<br>関数を呼び出そう!",
                initialCode: "// 関数を呼び出してない!\nfunction move3() {\n  robot.move();\n  robot.move();\n  robot.move();\n}\n\n// ← ここで関数を呼び出す!\n",
                hint: "move3(); を追加して2回呼び出す",
                goalX: 6, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 6 && r.y === 0
            },
            {
                id: 96, world: 5,
                title: "🐛 バグ修正16: 中括弧",
                description: "中括弧 {} が足りません!<br>正しく追加しよう!",
                initialCode: "// 中括弧が足りない!\nfor (let i = 0; i < 4; i++)\n  robot.move();\n  robot.collectStar();  // ← ループの外になってる!\n",
                hint: "for文に {} を追加",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [1, 2, 3], gems: [],
                validate: (r) => r.x === 4 && r.starsCollected >= 3
            },
            {
                id: 97, world: 5,
                title: "🐛 バグ修正17: Off-by-one",
                description: "1つずれています!<br>開始値か終了値を修正しよう!",
                initialCode: "// 1マス足りない!\nfor (let i = 1; i < 5; i++) {  // ← 開始が1からになってる\n  robot.move();\n}\n",
                hint: "i = 1 を i = 0 に、または i < 5 を i <= 5 に",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [], gems: [],
                validate: (r) => r.x === 5 && r.y === 0
            },
            {
                id: 98, world: 5,
                title: "🐛 バグ修正18: ロジックエラー",
                description: "上下の動きが逆になっています!<br>ロジックを修正しよう!",
                initialCode: "// 上に行くべきところで下に行ってる!\nrobot.move();\nrobot.move();\nrobot.moveDown();  // 障害物を避ける\nrobot.move();\nrobot.moveUp();  // 戻る\nrobot.move();\n",
                hint: "moveDownとmoveUpを入れ替え",
                goalX: 5, goalY: 0,
                obstacles: [{ x: 3, y: 0 }], stars: [], gems: [],
                validate: (r) => r.x === 5 && !r.hitObstacle
            },
            {
                id: 99, world: 5,
                title: "🐛 バグ修正19: 複合バグ",
                description: "複数のバグがあります!<br>全部見つけて修正しよう!",
                initialCode: "// バグが2つある!\nfor (let i = 0; i < 3; i++) {  // ← 回数が違う\n  robot.move();\n}\nrobot.colectStar();  // ← タイプミス!\n",
                hint: "ループ回数を4に、colect→collect",
                goalX: 4, goalY: 0,
                obstacles: [], stars: [4], gems: [],
                validate: (r) => r.x === 4 && r.starsCollected >= 1
            },
            {
                id: 100, world: 5,
                title: "🐛 バグ修正20: 総合問題",
                description: "3つのバグを全部直そう!<br>タイプミス、条件、順序をチェック!",
                initialCode: "// 3つのバグがある!\nrobot.move();\nrobot.collectStar();  // ← まだ星の位置じゃない\nrobot.move();\nrobot.mve();  // ← タイプミス\nrobot.move();\nif (robot.x = 4) {  // ← 条件が間違い\n  robot.collectGem();\n}\nrobot.move();\n",
                hint: "星の位置、mve→move、= → ===",
                goalX: 5, goalY: 0,
                obstacles: [], stars: [2], gems: [4],
                validate: (r) => r.x === 5 && r.starsCollected >= 1 && r.gemsCollected >= 1
            }
        ];

        // ===== ROBOT CLASS =====
        class Robot {
            constructor() {
                this.reset();
            }

            reset() {
                this.x = 0;
                this.y = 0;
                this.starsCollected = 0;
                this.gemsCollected = 0;
                this.hitObstacle = false;
                this.moves = [];
                // Don't clear currentLevel here - it's set by setLevel()
                this.eyeState = 'normal';
                this.antennaGlow = 0;
            }

            setLevel(level) {
                this.currentLevel = level;
            }

            move() {
                const nextX = this.x + 1;
                if (this.checkObstacleAt(nextX, this.y)) {
                    this.hitObstacle = true;
                    log('💥 障害物にぶつかった!');
                    return;
                }
                this.moves.push({ type: 'move', fromX: this.x, fromY: this.y, toX: nextX, toY: this.y });
                this.x = nextX;
                log(`🤖 移動 → (${this.x}, ${this.y})`);
            }

            moveUp() {
                const nextY = this.y - 1;
                this.moves.push({ type: 'moveUp', fromX: this.x, fromY: this.y, toX: this.x, toY: nextY });
                this.y = nextY;
                log(`🤖 上へ移動 ↑ (${this.x}, ${this.y})`);
            }

            moveDown() {
                const nextY = this.y + 1;
                this.moves.push({ type: 'moveDown', fromX: this.x, fromY: this.y, toX: this.x, toY: nextY });
                this.y = nextY;
                log(`🤖 下へ移動 ↓ (${this.x}, ${this.y})`);
            }

            jump() {
                const nextX = this.x + 2;  // Jump over obstacle (2 cells, not 1)
                this.moves.push({ type: 'jump', fromX: this.x, fromY: this.y, toX: nextX, toY: this.y });
                this.x = nextX;
                log(`🤖 ジャンプ! → (${this.x}, ${this.y})`);
            }

            collect() {
                if (this.isStar()) {
                    this.starsCollected++;
                    this.moves.push({ type: 'collectStar', x: this.x, y: this.y });
                    log(`⭐ 星を収集! (${this.starsCollected}個)`);
                }
            }

            collectGem() {
                if (this.isGem()) {
                    this.gemsCollected++;
                    this.moves.push({ type: 'collectGem', x: this.x, y: this.y });
                    log(`💎 ジェムを収集! (${this.gemsCollected}個)`);
                }
            }

            checkObstacleAt(x, y) {
                if (!this.currentLevel) return false;
                return this.currentLevel.obstacles.some(o => o.x === x && o.y === y);
            }

            isObstacle() {
                return this.checkObstacleAt(this.x + 1, this.y);
            }

            isStar() {
                if (!this.currentLevel) return false;
                return this.currentLevel.stars.includes(this.x);
            }

            isGem() {
                if (!this.currentLevel) return false;
                return this.currentLevel.gems.includes(this.x);
            }

            isGoal() {
                if (!this.currentLevel) return false;
                return this.x === this.currentLevel.goalX && this.y === this.currentLevel.goalY;
            }
        }

        // ===== GAME STATE =====
        const robot = new Robot();
        let currentLevelIndex = 0;
        let currentWorld = 1;
        let completedLevels = new Set();
        let completedWorlds = new Set(); // Track fully completed worlds
        let userLevel = parseInt(localStorage.getItem('codequest-userLevel')) || 0; // Player level (increases by 1 per completed world)
        let levelStars = {};
        let levelCompletionMode = {}; // Track completion mode: 'code', 'block', or 'both'
        let totalStarsEarned = 0;
        let collectedStarsInLevel = new Set();
        let collectedGemsInLevel = new Set();

        // Sound settings
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false';

        function playSound(soundFile) {
            if (!soundEnabled) return;
            const sound = new Audio(soundFile);
            sound.play().catch(e => console.log('Sound play failed:', e));
        }

        // Display settings
        let bgTheme = localStorage.getItem('bgTheme') || '1';
        let robotVisible = localStorage.getItem('robotVisible') !== 'false';
        let rocketVisible = localStorage.getItem('rocketVisible') !== 'false';
        let textColor = localStorage.getItem('textColor') || 'default';

        function applyDisplaySettings() {
            // Background themes
            const starfield = document.getElementById('starfield');
            const nebula = document.getElementById('nebulaBg');
            const universe = document.getElementById('universeBg');
            const realisticAurora = document.getElementById('realisticAurora');
            const futuristic = document.getElementById('futuristicBg');

            if (starfield) starfield.style.display = 'none';
            if (nebula) nebula.style.display = 'none';
            if (universe) universe.style.display = 'none';
            if (realisticAurora) realisticAurora.style.display = 'none';
            if (futuristic) futuristic.style.display = 'none';

            // Remove off-theme class first
            document.body.classList.remove('theme-off');

            if (bgTheme === '1' && starfield) {
                starfield.style.display = 'block';
            } else if (bgTheme === '2' && nebula) {
                nebula.style.display = 'block';
            } else if (bgTheme === '3' && universe) {
                universe.style.display = 'block';
            } else if (bgTheme === '4' && realisticAurora) {
                realisticAurora.style.display = 'block';
            } else if (bgTheme === '5' && futuristic) {
                futuristic.style.display = 'block';
            } else if (bgTheme === 'off') {
                document.body.classList.add('theme-off');
            }

            // Update theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === bgTheme) {
                    btn.classList.add('active');
                }
            });

            // Floating robots
            document.querySelectorAll('.floating-robot').forEach(robot => {
                robot.style.display = robotVisible ? 'block' : 'none';
            });

            // Rocket
            const rocket = document.querySelector('.rocket-decoration');
            if (rocket) {
                rocket.style.display = rocketVisible ? 'block' : 'none';
            }

            // Text color for code editor
            const codeTextarea = document.querySelector('.code-editor textarea');
            if (codeTextarea) {
                const colorMap = {
                    'default': '#6ee7b7',
                    'blue': '#5cb8ff',
                    'yellow': '#fbbf24',
                    'white': '#ffffff'
                };
                codeTextarea.style.color = colorMap[textColor] || colorMap['default'];
            }

            // Update text color buttons
            document.querySelectorAll('.text-color-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.textcolor === textColor) {
                    btn.classList.add('active');
                }
            });
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const output = document.getElementById('output');

        // ===== STARFIELD BACKGROUND =====
        function createStarfield() {
            const starfield = document.getElementById('starfield');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = (Math.random() * 3 + 1) + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 3 + 's';
                starfield.appendChild(star);
            }
        }
        createStarfield();

        // ===== LOGGING =====
        function log(message) {
            const p = document.createElement('p');
            p.innerHTML = message;
            output.appendChild(p);
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            output.innerHTML = '';
        }

        // ===== LEVEL MANAGEMENT =====
        function getWorldLevels(world) {
            return levels.filter(l => l.world === world);
        }

        function loadLevel(index) {
            currentLevelIndex = index;
            const level = levels[index];
            currentWorld = level.world;
            robot.setLevel(level);
            robot.reset();
            collectedStarsInLevel.clear();
            collectedGemsInLevel.clear();

            // Play stage select sound
            playSound('select_stage_sound.mp3');

            document.getElementById('challengeTitle').innerHTML =
                `🎯 ${level.title}` +
                (level.concept ? `<span class="new-concept">${level.concept}</span>` : '');
            document.getElementById('challengeDescription').innerHTML = level.description;
            document.getElementById('levelDisplay').textContent = level.id;
            document.getElementById('codeInput').value = level.initialCode;
            document.getElementById('hintBox').classList.remove('show');
            clearLog();
            drawCanvas();

            // Clear block workspace when loading new level
            if (typeof clearBlockWorkspace === 'function') {
                clearBlockWorkspace();
            }

            updateWorldButtons();
            updateLevelButtons();
            updateStats();
            updateLineNumbers();
            updateGameInfo();
        }

        function updateWorldButtons() {
            document.querySelectorAll('.world-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.world) === currentWorld);
            });
        }

        function updateLevelButtons() {
            const selector = document.getElementById('levelSelector');
            selector.innerHTML = '';

            const worldLevels = getWorldLevels(currentWorld);

            worldLevels.forEach((level) => {
                const btn = document.createElement('button');
                btn.className = 'level-btn';

                const globalIndex = levels.findIndex(l => l.id === level.id);

                if (globalIndex === currentLevelIndex) btn.classList.add('active');

                // Apply completion mode styling
                if (completedLevels.has(level.id)) {
                    const mode = levelCompletionMode[level.id];
                    if (mode === 'both') {
                        btn.classList.add('completed-both');
                    } else if (mode === 'block') {
                        btn.classList.add('completed-block');
                    } else {
                        btn.classList.add('completed'); // code mode (green)
                    }
                }

                btn.textContent = level.id;

                // Add stars
                if (levelStars[level.id]) {
                    const starsDiv = document.createElement('span');
                    starsDiv.className = 'stars';
                    starsDiv.textContent = '⭐'.repeat(levelStars[level.id]);
                    btn.appendChild(starsDiv);
                }

                btn.onclick = () => {
                    loadLevel(globalIndex);
                };
                selector.appendChild(btn);
            });
        }

        function updateStats() {
            document.getElementById('completedCount').textContent = completedLevels.size;
            document.getElementById('totalStars').textContent = totalStarsEarned;
        }

        function updateGameInfo() {
            document.getElementById('robotPos').textContent = `(${robot.x}, ${robot.y})`;
            document.getElementById('starsCollected').textContent = robot.starsCollected;
            document.getElementById('gemsCollected').textContent = robot.gemsCollected;
        }

        function updateLineNumbers() {
            const textarea = document.getElementById('codeInput');
            const lines = textarea.value.split('\n').length;
            const lineNumbers = document.getElementById('lineNumbers');
            lineNumbers.innerHTML = Array.from({ length: lines }, (_, i) => i + 1).join('<br>');
        }

        // ===== DRAWING =====
        function drawCanvas() {
            const level = levels[currentLevelIndex];
            const cellSize = 50;
            const startX = 40;
            const startY = 200;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw grid background
            drawGrid(startX, startY, cellSize);

            // Draw path
            drawPath(startX, startY, cellSize, level.goalX);

            // Draw obstacles
            drawObstacles(startX, startY, cellSize, level.obstacles);

            // Draw stars
            drawStars(startX, startY, cellSize, level.stars);

            // Draw gems
            drawGems(startX, startY, cellSize, level.gems);

            // Draw goal
            drawGoal(startX + level.goalX * cellSize, startY + level.goalY * cellSize, cellSize);

            // Draw robot
            drawRobot(startX + robot.x * cellSize + cellSize / 2, startY + robot.y * cellSize - cellSize / 2 + 10, cellSize);
        }

        function drawGrid(startX, startY, cellSize) {
            const isLightMode = document.body.classList.contains('light-mode');
            ctx.strokeStyle = isLightMode ? 'rgba(71, 85, 105, 0.25)' : 'rgba(0, 212, 170, 0.1)';
            ctx.lineWidth = 1;

            for (let i = 0; i <= 12; i++) {
                ctx.beginPath();
                ctx.moveTo(startX + i * cellSize, 50);
                ctx.lineTo(startX + i * cellSize, 350);
                ctx.stroke();
            }

            for (let i = 0; i <= 6; i++) {
                ctx.beginPath();
                ctx.moveTo(startX, 50 + i * cellSize);
                ctx.lineTo(startX + 12 * cellSize, 50 + i * cellSize);
                ctx.stroke();
            }
        }

        function drawPath(startX, startY, cellSize, goalX) {
            const isLightMode = document.body.classList.contains('light-mode');

            let gradient;
            if (isLightMode) {
                gradient = ctx.createLinearGradient(startX, 0, startX + (goalX + 1) * cellSize, 0);
                gradient.addColorStop(0, 'rgba(203, 213, 225, 0.9)');
                gradient.addColorStop(1, 'rgba(16, 185, 129, 0.3)');
            } else {
                gradient = ctx.createLinearGradient(startX, 0, startX + (goalX + 1) * cellSize, 0);
                gradient.addColorStop(0, 'rgba(30, 42, 69, 0.8)');
                gradient.addColorStop(1, 'rgba(0, 255, 136, 0.2)');
            }

            ctx.fillStyle = gradient;
            ctx.fillRect(startX, startY - cellSize, (goalX + 1) * cellSize, cellSize);

            // Path border
            ctx.strokeStyle = isLightMode ? 'rgba(71, 85, 105, 0.5)' : 'rgba(0, 212, 170, 0.3)';
            ctx.lineWidth = 2;
            ctx.strokeRect(startX, startY - cellSize, (goalX + 1) * cellSize, cellSize);
        }

        function drawObstacles(startX, startY, cellSize, obstacles) {
            const isLightMode = document.body.classList.contains('light-mode');

            obstacles.forEach(obs => {
                const x = startX + obs.x * cellSize;
                const y = startY + obs.y * cellSize - cellSize + 2;  // 8px up

                // Obstacle body with gradient
                const gradient = ctx.createLinearGradient(x, y, x, y + cellSize);
                gradient.addColorStop(0, '#ff2d75');
                gradient.addColorStop(1, '#c91a5a');

                ctx.fillStyle = gradient;
                ctx.fillRect(x + 5, y + 10, cellSize - 10, cellSize - 10);

                // Danger stripes
                ctx.strokeStyle = '#ffcc00';
                ctx.lineWidth = 3;
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.moveTo(x + 10 + i * 12, y + 15);
                    ctx.lineTo(x + 10 + i * 12, y + cellSize - 5);
                    ctx.stroke();
                }

                // Border
                ctx.strokeStyle = isLightMode ? '#9f1239' : '#ff2d75';
                ctx.lineWidth = isLightMode ? 3 : 2;
                ctx.strokeRect(x + 5, y + 10, cellSize - 10, cellSize - 10);

                // Glow effect (only in dark mode)
                if (!isLightMode) {
                    ctx.shadowColor = '#ff2d75';
                    ctx.shadowBlur = 15;
                    ctx.strokeRect(x + 5, y + 10, cellSize - 10, cellSize - 10);
                    ctx.shadowBlur = 0;
                }
            });
        }

        function drawStars(startX, startY, cellSize, stars) {
            const isLightMode = document.body.classList.contains('light-mode');

            stars.forEach(starX => {
                if (collectedStarsInLevel.has(starX)) return;

                const x = startX + starX * cellSize + cellSize / 2;
                const y = startY - 63;  // 3px up

                // Glow (only in dark mode)
                if (!isLightMode) {
                    ctx.shadowColor = '#ffcc00';
                    ctx.shadowBlur = 20;
                }

                drawStarShape(ctx, x, y, 12, 5, '#ffcc00', '#ff9500');

                // Add outline in light mode
                if (isLightMode) {
                    ctx.strokeStyle = '#b45309';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                ctx.shadowBlur = 0;
            });
        }

        function drawGems(startX, startY, cellSize, gems) {
            const isLightMode = document.body.classList.contains('light-mode');

            gems.forEach(gemX => {
                if (collectedGemsInLevel.has(gemX)) return;

                const x = startX + gemX * cellSize + cellSize / 2;
                const y = startY - 75;

                // Glow (only in dark mode)
                if (!isLightMode) {
                    ctx.shadowColor = '#b14eff';
                    ctx.shadowBlur = 15;
                }

                ctx.fillStyle = '#b14eff';
                ctx.beginPath();
                ctx.moveTo(x, y - 10);
                ctx.lineTo(x + 8, y);
                ctx.lineTo(x, y + 10);
                ctx.lineTo(x - 8, y);
                ctx.closePath();
                ctx.fill();

                // Add outline in light mode
                if (isLightMode) {
                    ctx.strokeStyle = '#7c3aed';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                // Shine
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.beginPath();
                ctx.moveTo(x - 2, y - 5);
                ctx.lineTo(x + 3, y - 5);
                ctx.lineTo(x, y);
                ctx.closePath();
                ctx.fill();

                ctx.shadowBlur = 0;
            });
        }

        function drawStarShape(ctx, cx, cy, outerR, points, color1, color2) {
            const gradient = ctx.createRadialGradient(cx, cy, 0, cx, cy, outerR);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);

            ctx.fillStyle = gradient;
            ctx.beginPath();

            for (let i = 0; i < points * 2; i++) {
                const angle = (i * Math.PI) / points - Math.PI / 2;
                const radius = i % 2 === 0 ? outerR : outerR / 2;
                const x = cx + Math.cos(angle) * radius;
                const y = cy + Math.sin(angle) * radius;

                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }

            ctx.closePath();
            ctx.fill();
        }

        function drawGoal(x, y, cellSize) {
            const isLightMode = document.body.classList.contains('light-mode');
            const yOffset = -13;  // Move goal up
            const xOffset = 1;  // Move goal right

            // Goal platform
            const gradient = ctx.createLinearGradient(x, y - cellSize, x, y + 10);
            gradient.addColorStop(0, '#00ff88');
            gradient.addColorStop(1, '#00cc6a');

            ctx.fillStyle = gradient;
            ctx.fillRect(x + 5 + xOffset, y - cellSize + 10 + yOffset, cellSize - 5, cellSize);

            // Border for visibility
            ctx.strokeStyle = isLightMode ? '#047857' : '#00ff88';
            ctx.lineWidth = isLightMode ? 3 : 2;
            ctx.strokeRect(x + 5 + xOffset, y - cellSize + 10 + yOffset, cellSize - 5, cellSize);

            // Glow (only in dark mode)
            if (!isLightMode) {
                ctx.shadowColor = '#00ff88';
                ctx.shadowBlur = 20;
                ctx.strokeRect(x + 5 + xOffset, y - cellSize + 10 + yOffset, cellSize - 5, cellSize);
                ctx.shadowBlur = 0;
            }

            // Flag pole
            ctx.fillStyle = isLightMode ? '#047857' : '#00ff88';
            ctx.fillRect(x + cellSize / 2 - 2 + xOffset, y - cellSize - 20 + yOffset, 4, 40);

            // Flag
            ctx.fillStyle = '#ff2d75';
            ctx.beginPath();
            ctx.moveTo(x + cellSize / 2 + 2 + xOffset, y - cellSize - 15 + yOffset);
            ctx.lineTo(x + cellSize / 2 + 25 + xOffset, y - cellSize - 5 + yOffset);
            ctx.lineTo(x + cellSize / 2 + 2 + xOffset, y - cellSize + 5 + yOffset);
            ctx.closePath();
            ctx.fill();

            // Flag border in light mode
            if (isLightMode) {
                ctx.strokeStyle = '#9f1239';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        function drawRobot(x, y, cellSize) {
            drawRobotWithImage(ctx, x, y, selectedCharacter, 1, cellSize);
        }

        function drawRobotWithImage(ctx, x, y, character, scale = 1, cellSize = 50) {
            const img = characterImages[character.id];
            const size = cellSize * 1.8 * scale;  // Slightly smaller
            const yOffset = -size * 0.4 + 15;  // 5px down

            // Draw shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.beginPath();
            ctx.ellipse(x, y + yOffset + size / 2, size / 2, 8 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // Draw the robot image
            if (img && img.complete) {
                ctx.drawImage(img, x - size / 2, y + yOffset - size / 2, size, size);
            }
        }

        // Keep old function for compatibility but redirect to new one
        function drawRobotWithColors(ctx, x, y, colors, scale = 1, cellSize = 50) {
            drawRobotWithImage(ctx, x, y, selectedCharacter, scale, cellSize);
        }

        // ===== ANIMATION =====
        async function animateRobot() {
            const cellSize = 50;
            const startX = 40;
            const startY = 200;

            for (const move of robot.moves) {
                if (move.type === 'collectStar') {
                    collectedStarsInLevel.add(move.x);
                    createParticles(startX + move.x * cellSize + cellSize / 2, startY - 60, '#ffcc00');
                    drawCanvas();
                    await sleep(200);
                    continue;
                }

                if (move.type === 'collectGem') {
                    collectedGemsInLevel.add(move.x);
                    createParticles(startX + move.x * cellSize + cellSize / 2, startY - 75, '#b14eff');
                    drawCanvas();
                    await sleep(200);
                    continue;
                }

                const frames = 15;
                for (let frame = 0; frame <= frames; frame++) {
                    const progress = frame / frames;
                    const easeProgress = 1 - Math.pow(1 - progress, 3); // easeOutCubic

                    let currentX = move.fromX + (move.toX - move.fromX) * easeProgress;
                    let currentY = move.fromY + (move.toY - move.fromY) * easeProgress;
                    let jumpOffset = 0;

                    if (move.type === 'jump') {
                        jumpOffset = Math.sin(progress * Math.PI) * 40;
                    }

                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    drawGrid(startX, startY, cellSize);
                    drawPath(startX, startY, cellSize, levels[currentLevelIndex].goalX);
                    drawObstacles(startX, startY, cellSize, levels[currentLevelIndex].obstacles);
                    drawStars(startX, startY, cellSize, levels[currentLevelIndex].stars);
                    drawGems(startX, startY, cellSize, levels[currentLevelIndex].gems);
                    drawGoal(startX + levels[currentLevelIndex].goalX * cellSize, startY + levels[currentLevelIndex].goalY * cellSize, cellSize);

                    drawRobot(
                        startX + currentX * cellSize + cellSize / 2,
                        startY + currentY * cellSize - cellSize / 2 + 10 - jumpOffset,
                        cellSize
                    );

                    await sleep(20);
                }

                updateGameInfo();
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ===== PARTICLE EFFECTS =====
        function createParticles(x, y, color) {
            for (let i = 0; i < 12; i++) {
                const angle = (Math.PI * 2 / 12) * i;
                const speed = 3 + Math.random() * 2;
                const particle = {
                    x, y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 1,
                    color
                };
                animateParticle(particle);
            }
        }

        async function animateParticle(particle) {
            while (particle.life > 0) {
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.vy += 0.2;
                particle.life -= 0.05;

                ctx.globalAlpha = particle.life;
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, 4 * particle.life, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;

                await sleep(16);
            }
        }

        // ===== CELEBRATION =====
        function showCelebration() {
            const container = document.getElementById('celebrationContainer');
            const colors = ['#ff2d75', '#00f5ff', '#ffcc00', '#00ff88', '#b14eff'];

            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                container.appendChild(confetti);

                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function showLevelComplete(starsEarned) {
            const modal = document.getElementById('levelCompleteModal');
            const starsDisplay = document.getElementById('modalStars');
            const message = document.getElementById('modalMessage');

            starsDisplay.textContent = '⭐'.repeat(starsEarned) + '☆'.repeat(3 - starsEarned);

            if (starsEarned === 3) {
                message.textContent = '完璧! 素晴らしいコードだ!';
            } else if (starsEarned === 2) {
                message.textContent = 'いい感じ! もっと効率的に書けるかな?';
            } else {
                message.textContent = 'クリア! もう一度挑戦してみよう!';
            }

            // Play clear sound
            playSound('clear_sound.mp3');

            modal.classList.add('show');
            showCelebration();
        }

        // ===== BLOCK MODE SYSTEM =====
        let currentEditorMode = 'code'; // 'code' or 'block'
        let currentBlockCategory = 'motion';
        let draggedBlock = null;
        let dragClone = null;
        let isDragging = false;
        let blockZoom = 100; // Zoom percentage

        // Block definitions
        const blockDefinitions = {
            motion: [
                { id: 'move', icon: '➡️', label: '右に移動', code: 'robot.move();', category: 'motion' },
                { id: 'moveUp', icon: '⬆️', label: '上に移動', code: 'robot.moveUp();', category: 'motion' },
                { id: 'moveDown', icon: '⬇️', label: '下に移動', code: 'robot.moveDown();', category: 'motion' },
                { id: 'jump', icon: '🦘', label: 'ジャンプ', code: 'robot.jump();', category: 'motion' }
            ],
            collect: [
                { id: 'collect', icon: '⭐', label: '星を収集', code: 'robot.collect();', category: 'collect' },
                { id: 'collectGem', icon: '💎', label: 'ジェム収集', code: 'robot.collectGem();', category: 'collect' }
            ],
            check: [
                { id: 'isObstacle', icon: '🧱', label: '障害物？', code: 'robot.isObstacle()', isCondition: true, category: 'check' },
                { id: 'isStar', icon: '⭐', label: '星がある？', code: 'robot.isStar()', isCondition: true, category: 'check' },
                { id: 'isGem', icon: '💎', label: 'ジェム？', code: 'robot.isGem()', isCondition: true, category: 'check' },
                { id: 'isGoal', icon: '🏁', label: 'ゴール？', code: 'robot.isGoal()', isCondition: true, category: 'check' }
            ],
            control: [
                { id: 'if', icon: '🔀', label: 'もし', code: 'if', isContainer: true, hasCondition: true, category: 'control' },
                { id: 'ifElse', icon: '🔀', label: 'もし〜でなければ', code: 'ifElse', isContainer: true, hasCondition: true, hasElse: true, category: 'control' }
            ],
            loop: [
                { id: 'repeat', icon: '🔄', label: '繰り返す', code: 'for', isContainer: true, hasCount: true, defaultCount: 3, category: 'loop' },
                { id: 'while', icon: '🔁', label: '〜の間', code: 'while', isContainer: true, hasCondition: true, category: 'loop' }
            ]
        };

        // Condition options for dropdowns
        const conditionOptions = [
            { value: 'robot.isObstacle()', label: '障害物がある' },
            { value: '!robot.isObstacle()', label: '障害物がない' },
            { value: 'robot.isStar()', label: '星がある' },
            { value: 'robot.isGem()', label: 'ジェムがある' },
            { value: 'robot.isGoal()', label: 'ゴールにいる' },
            { value: '!robot.isGoal()', label: 'ゴールじゃない' }
        ];

        // Initialize block palette
        function initBlockPalette() {
            renderBlockList('motion');

            document.querySelectorAll('.palette-category').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.palette-category').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentBlockCategory = btn.dataset.category;
                    renderBlockList(currentBlockCategory);
                });
            });
        }

        // Render blocks in the palette list
        function renderBlockList(category) {
            const blockList = document.getElementById('blockList');
            blockList.innerHTML = '';

            const blocks = blockDefinitions[category] || [];

            blocks.forEach(blockDef => {
                if (!blockDef.isCondition) { // Don't show condition-only blocks in palette
                    const block = createPaletteBlock(blockDef);
                    blockList.appendChild(block);
                }
            });
        }

        // Create a palette block (draggable source)
        function createPaletteBlock(blockDef) {
            const block = document.createElement('div');
            block.className = `block ${blockDef.category}`;
            block.dataset.blockId = blockDef.id;
            block.dataset.category = blockDef.category;

            if (blockDef.isContainer) {
                block.innerHTML = `<span class="icon">${blockDef.icon}</span><span>${blockDef.label}</span>`;
                if (blockDef.hasCount) {
                    block.innerHTML += ` <span style="opacity:0.7">[n]回</span>`;
                }
            } else {
                block.innerHTML = `<span class="icon">${blockDef.icon}</span><span>${blockDef.label}</span>`;
            }

            // Mouse down - start drag
            block.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startDrag(e, blockDef);
            });

            // Touch support
            block.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                startDrag({ clientX: touch.clientX, clientY: touch.clientY }, blockDef);
            });

            return block;
        }

        // Start dragging
        function startDrag(e, blockDef) {
            isDragging = true;
            draggedBlock = blockDef;

            // Create drag clone
            dragClone = document.createElement('div');
            dragClone.className = `block ${blockDef.category}`;
            dragClone.style.position = 'fixed';
            dragClone.style.pointerEvents = 'none';
            dragClone.style.zIndex = '10000';
            dragClone.style.opacity = '0.85';
            dragClone.style.transform = 'scale(0.9)';
            dragClone.style.fontSize = '0.7rem';
            dragClone.style.padding = '0.35rem 0.5rem';
            dragClone.innerHTML = `<span class="icon">${blockDef.icon}</span><span>${blockDef.label}</span>`;

            document.body.appendChild(dragClone);
            updateDragPosition(e.clientX, e.clientY);

            // Add move listeners
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('mouseup', onDragEnd);
            document.addEventListener('touchmove', onTouchMove);
            document.addEventListener('touchend', onDragEnd);
        }

        function updateDragPosition(x, y) {
            if (dragClone) {
                dragClone.style.left = (x - 40) + 'px';
                dragClone.style.top = (y - 12) + 'px';
            }
        }

        function onDragMove(e) {
            if (isDragging) {
                updateDragPosition(e.clientX, e.clientY);
                highlightDropZone(e.clientX, e.clientY);
            }
        }

        function onTouchMove(e) {
            if (isDragging && e.touches[0]) {
                const touch = e.touches[0];
                updateDragPosition(touch.clientX, touch.clientY);
                highlightDropZone(touch.clientX, touch.clientY);
            }
        }

        function highlightDropZone(x, y) {
            const wrapper = document.querySelector('.block-workspace-wrapper');
            const workspace = document.getElementById('blockWorkspace');
            const rect = wrapper.getBoundingClientRect();

            if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                workspace.style.background = 'rgba(0, 212, 170, 0.1)';
                wrapper.style.borderColor = 'var(--accent-primary)';
            } else {
                workspace.style.background = '';
                wrapper.style.borderColor = '';
            }
        }

        function onDragEnd(e) {
            if (!isDragging) return;

            const clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
            const clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);

            const wrapper = document.querySelector('.block-workspace-wrapper');
            const workspace = document.getElementById('blockWorkspace');
            const rect = wrapper.getBoundingClientRect();

            // Check if dropped in workspace
            if (clientX >= rect.left && clientX <= rect.right &&
                clientY >= rect.top && clientY <= rect.bottom) {

                // Find if dropped inside a container body
                const dropTarget = findDropTarget(clientX, clientY);
                addBlockToWorkspace(draggedBlock, dropTarget);
            }

            // Cleanup
            if (dragClone) {
                dragClone.remove();
                dragClone = null;
            }

            workspace.style.background = '';
            wrapper.style.borderColor = '';

            isDragging = false;
            draggedBlock = null;

            document.removeEventListener('mousemove', onDragMove);
            document.removeEventListener('mouseup', onDragEnd);
            document.removeEventListener('touchmove', onTouchMove);
            document.removeEventListener('touchend', onDragEnd);
        }

        function findDropTarget(x, y) {
            const bodies = document.querySelectorAll('#blockWorkspace .block-body');
            for (const body of bodies) {
                const rect = body.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    return body;
                }
            }
            return null;
        }

        // Add block to workspace
        function addBlockToWorkspace(blockDef, dropTarget) {
            const workspace = document.getElementById('blockWorkspace');
            const block = createWorkspaceBlock(blockDef);

            if (dropTarget) {
                dropTarget.appendChild(block);
            } else {
                workspace.appendChild(block);
            }

            updateWorkspaceHint();
            generateCodeFromBlocks();
        }

        // Create a workspace block (the actual block in workspace)
        function createWorkspaceBlock(blockDef) {
            const wrapper = document.createElement('div');
            wrapper.className = 'workspace-block';
            wrapper.dataset.blockId = blockDef.id;
            wrapper.dataset.category = blockDef.category;
            wrapper.dataset.code = blockDef.code;

            if (blockDef.isContainer) {
                wrapper.classList.add('container-block');

                // Header
                const header = document.createElement('div');
                header.className = `block ${blockDef.category}`;
                header.style.borderRadius = '8px 8px 0 0';
                header.style.marginBottom = '0';

                let headerContent = `<span class="icon">${blockDef.icon}</span><span>${blockDef.label}</span>`;

                if (blockDef.hasCount) {
                    headerContent += ` <input type="number" class="block-input" value="${blockDef.defaultCount || 3}" min="1" max="99" data-type="count"> 回`;
                }

                if (blockDef.hasCondition) {
                    headerContent += ` <select class="block-select" data-type="condition">`;
                    conditionOptions.forEach(opt => {
                        headerContent += `<option value="${opt.value}">${opt.label}</option>`;
                    });
                    headerContent += `</select>`;
                }

                header.innerHTML = headerContent;
                wrapper.appendChild(header);

                // Body
                const body = document.createElement('div');
                body.className = 'block-body';
                body.dataset.dropzone = 'true';
                body.style.borderLeftColor = getBlockColor(blockDef.category);
                wrapper.appendChild(body);

                // Else section if needed
                if (blockDef.hasElse) {
                    const elseHeader = document.createElement('div');
                    elseHeader.className = `block ${blockDef.category}`;
                    elseHeader.style.borderRadius = '0';
                    elseHeader.style.marginBottom = '0';
                    elseHeader.innerHTML = `<span class="icon">↪️</span><span>でなければ</span>`;
                    wrapper.appendChild(elseHeader);

                    const elseBody = document.createElement('div');
                    elseBody.className = 'block-body';
                    elseBody.dataset.dropzone = 'true';
                    elseBody.dataset.isElse = 'true';
                    elseBody.style.borderLeftColor = getBlockColor(blockDef.category);
                    wrapper.appendChild(elseBody);
                }

                // Footer
                const footer = document.createElement('div');
                footer.className = 'block-footer';
                footer.style.borderLeftColor = getBlockColor(blockDef.category);
                footer.style.borderBottomColor = getBlockColor(blockDef.category);
                wrapper.appendChild(footer);

            } else {
                const block = document.createElement('div');
                block.className = `block ${blockDef.category}`;
                block.innerHTML = `<span class="icon">${blockDef.icon}</span><span>${blockDef.label}</span>`;
                wrapper.appendChild(block);
            }

            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '×';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                wrapper.remove();
                updateWorkspaceHint();
                generateCodeFromBlocks();
            });
            wrapper.appendChild(deleteBtn);

            // Add input change listeners
            wrapper.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('change', generateCodeFromBlocks);
                input.addEventListener('input', generateCodeFromBlocks);
            });

            return wrapper;
        }

        function getBlockColor(category) {
            const colors = {
                motion: '#4C97FF',
                collect: '#59C059',
                check: '#FF8C1A',
                control: '#FFAB19',
                loop: '#9966FF'
            };
            return colors[category] || '#666';
        }

        // Initialize workspace
        function initBlockWorkspace() {
            // Workspace is initialized via event listeners in startDrag/onDragEnd
        }

        function updateWorkspaceHint() {
            const workspace = document.getElementById('blockWorkspace');
            const hint = document.getElementById('workspaceHint');
            const hasBlocks = workspace.querySelectorAll('.workspace-block').length > 0;
            hint.classList.toggle('hidden', hasBlocks);
        }

        // Generate JavaScript code from blocks
        function generateCodeFromBlocks() {
            const workspace = document.getElementById('blockWorkspace');
            const blocks = workspace.querySelectorAll(':scope > .workspace-block');

            let code = '';
            blocks.forEach(block => {
                code += generateBlockCode(block, 0);
            });

            // Update the code editor and preview
            document.getElementById('codeInput').value = code;
            document.getElementById('generatedCodePre').textContent = code || '// ブロックをドラッグしてプログラムを作ろう！';
            updateLineNumbers();
        }

        function generateBlockCode(wrapper, indent) {
            const indentStr = '  '.repeat(indent);
            const blockId = wrapper.dataset.blockId;
            const blockCode = wrapper.dataset.code;

            // Find block definition
            let blockDef = null;
            for (const category in blockDefinitions) {
                const found = blockDefinitions[category].find(b => b.id === blockId);
                if (found) {
                    blockDef = found;
                    break;
                }
            }

            if (!blockDef) return '';

            if (blockDef.isContainer) {
                let code = '';

                if (blockDef.hasCount) {
                    // For loop
                    const countInput = wrapper.querySelector('input[data-type="count"]');
                    const count = countInput ? countInput.value : 3;
                    code += `${indentStr}for (let i = 0; i < ${count}; i++) {\n`;
                } else if (blockDef.hasCondition) {
                    // If or While
                    const conditionSelect = wrapper.querySelector('select[data-type="condition"]');
                    const condition = conditionSelect ? conditionSelect.value : 'true';

                    if (blockCode === 'if' || blockCode === 'ifElse') {
                        code += `${indentStr}if (${condition}) {\n`;
                    } else {
                        code += `${indentStr}while (${condition}) {\n`;
                    }
                }

                // Process body blocks
                const bodies = wrapper.querySelectorAll(':scope > .block-body');
                if (bodies[0]) {
                    const bodyBlocks = bodies[0].querySelectorAll(':scope > .workspace-block');
                    bodyBlocks.forEach(childBlock => {
                        code += generateBlockCode(childBlock, indent + 1);
                    });
                }

                code += `${indentStr}}\n`;

                // Handle else block
                if (blockDef.hasElse && bodies[1]) {
                    code = code.slice(0, -1); // Remove last newline
                    code += ` else {\n`;
                    const elseBlocks = bodies[1].querySelectorAll(':scope > .workspace-block');
                    elseBlocks.forEach(childBlock => {
                        code += generateBlockCode(childBlock, indent + 1);
                    });
                    code += `${indentStr}}\n`;
                }

                return code;
            } else {
                return `${indentStr}${blockCode}\n`;
            }
        }

        // Mode toggle handlers
        function switchToCodeMode() {
            playSound('select_stage_sound.mp3');

            currentEditorMode = 'code';
            document.getElementById('codeModeBtn').classList.add('active');
            document.getElementById('blockModeBtn').classList.remove('active');
            document.getElementById('codeEditorWrapper').classList.remove('hidden');
            document.getElementById('blockEditor').classList.remove('active');
        }

        function switchToBlockMode() {
            playSound('select_stage_sound.mp3');

            currentEditorMode = 'block';
            document.getElementById('blockModeBtn').classList.add('active');
            document.getElementById('codeModeBtn').classList.remove('active');
            document.getElementById('codeEditorWrapper').classList.add('hidden');
            document.getElementById('blockEditor').classList.add('active');
            document.getElementById('generatedCode').classList.add('show');
            generateCodeFromBlocks();
        }

        // Clear block workspace
        function clearBlockWorkspace() {
            const workspace = document.getElementById('blockWorkspace');
            const blocks = workspace.querySelectorAll('.workspace-block');
            blocks.forEach(block => block.remove());
            updateWorkspaceHint();
            document.getElementById('generatedCodePre').textContent = '// ブロックをドラッグしてプログラムを作ろう！';
        }

        // Zoom functions
        function setBlockZoom(zoom) {
            blockZoom = Math.max(50, Math.min(150, zoom)); // Limit 50% - 150%
            const workspace = document.getElementById('blockWorkspace');
            workspace.style.transform = `scale(${blockZoom / 100})`;
            document.getElementById('zoomLevel').textContent = blockZoom + '%';

            // Adjust workspace size to fit scaled content
            const wrapper = document.querySelector('.block-workspace-wrapper');
            if (wrapper) {
                workspace.style.minWidth = (100 / (blockZoom / 100)) + '%';
                workspace.style.minHeight = (100 / (blockZoom / 100)) + '%';
            }
        }

        function zoomIn() {
            setBlockZoom(blockZoom + 10);
        }

        function zoomOut() {
            setBlockZoom(blockZoom - 10);
        }

        // ===== EVENT HANDLERS =====
        document.getElementById('runBtn').addEventListener('click', async () => {
            playSound('select_stage_sound.mp3');

            const code = document.getElementById('codeInput').value;
            clearLog();
            robot.reset();
            collectedStarsInLevel.clear();
            collectedGemsInLevel.clear();
            drawCanvas();

            try {
                log('🚀 コードを実行中...');

                // Execute user code
                const wrappedCode = `
                    (function() {
                        ${code}
                    })();
                `;
                eval(wrappedCode);

                await animateRobot();

                const level = levels[currentLevelIndex];
                if (level.validate(robot)) {
                    // Calculate stars
                    const codeLength = code.replace(/\s+/g, '').length;
                    let starsEarned = 1;
                    if (codeLength < 200) starsEarned = 2;
                    if (codeLength < 100) starsEarned = 3;

                    // Update progress
                    const isNewCompletion = !completedLevels.has(level.id);
                    const isStarsImproved = !levelStars[level.id] || levelStars[level.id] < starsEarned;

                    if (isNewCompletion) {
                        completedLevels.add(level.id);
                    }

                    // Track completion mode
                    const currentMode = currentEditorMode; // 'code' or 'block'
                    const previousMode = levelCompletionMode[level.id];

                    if (!previousMode) {
                        // First time completion
                        levelCompletionMode[level.id] = currentMode;
                    } else if (previousMode !== currentMode && previousMode !== 'both') {
                        // Completed in different mode - now both!
                        levelCompletionMode[level.id] = 'both';
                    }

                    if (isStarsImproved) {
                        totalStarsEarned += starsEarned - (levelStars[level.id] || 0);
                        levelStars[level.id] = starsEarned;
                    }

                    // クラウドに保存（新規クリアまたは星が増えた場合）
                    if (isNewCompletion || isStarsImproved) {
                        saveProgressToCloud(level.id, starsEarned);
                    }

                    updateStats();
                    updateLevelButtons();

                    setTimeout(() => showLevelComplete(starsEarned), 500);
                } else {
                    updateStats();

                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    errorDiv.textContent = '❌ ゴールに到達できませんでした。もう一度挑戦!';
                    output.appendChild(errorDiv);
                }
            } catch (error) {
                updateStats();

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = '❌ エラー: ' + error.message;
                output.appendChild(errorDiv);
            }
        });

        document.getElementById('hintBtn').addEventListener('click', () => {
            const hintBox = document.getElementById('hintBox');
            const level = levels[currentLevelIndex];
            hintBox.innerHTML = `<strong>💡 ヒント:</strong><code>${level.hint}</code>`;
            hintBox.classList.toggle('show');
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            loadLevel(currentLevelIndex);
        });

        document.getElementById('nextLevelBtn').addEventListener('click', () => {
            document.getElementById('levelCompleteModal').classList.remove('show');

            // Check if world is complete (all 20 stages in the world)
            const level = levels[currentLevelIndex];
            const worldNum = level.world;
            const worldLevels = levels.filter(l => l.world === worldNum);
            const completedInWorld = worldLevels.filter(l => completedLevels.has(l.id));

            // If just completed all 20 stages and haven't already leveled up for this world
            if (completedInWorld.length === 20 && !completedWorlds.has(worldNum)) {
                completedWorlds.add(worldNum);
                userLevel++;
                localStorage.setItem('codequest-userLevel', userLevel);
                // Save player level to cloud
                if (supabaseClient && currentUser) {
                    supabaseClient
                        .from('profiles')
                        .update({ player_level: userLevel })
                        .eq('id', currentUser.id)
                        .then(() => console.log('📈 プレイヤーレベル保存:', userLevel));
                }
                showLevelUpModal(userLevel, worldNum);
            } else {
                // Proceed to next level
                if (currentLevelIndex < levels.length - 1) {
                    loadLevel(currentLevelIndex + 1);
                }
            }
        });

        // Show Level Up Modal
        function showLevelUpModal(newLevel, worldNum) {
            const modal = document.getElementById('levelUpModal');
            const levelNumber = document.getElementById('levelUpNumber');
            const message = document.getElementById('levelUpMessage');

            levelNumber.textContent = `Lv. ${newLevel}`;
            const worldNames = {
                1: 'ベーシック',
                2: 'ループ',
                3: 'コンディション',
                4: 'ファンクション',
                5: 'デバッグ'
            };
            message.textContent = `ワールド${worldNum} (${worldNames[worldNum] || 'チャレンジ'})をマスターした!`;

            // Play level up sound
            playSound('level_up.mp3');

            modal.classList.add('show');
        }

        // Level Up Modal close handler
        document.getElementById('levelUpCloseBtn').addEventListener('click', () => {
            document.getElementById('levelUpModal').classList.remove('show');
            // Proceed to next level
            if (currentLevelIndex < levels.length - 1) {
                loadLevel(currentLevelIndex + 1);
            }
        });

        document.querySelectorAll('.world-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentWorld = parseInt(btn.dataset.world);
                const worldLevels = getWorldLevels(currentWorld);
                const firstLevelIndex = levels.findIndex(l => l.id === worldLevels[0].id);
                loadLevel(firstLevelIndex);
            });
        });

        document.getElementById('codeInput').addEventListener('input', updateLineNumbers);
        document.getElementById('codeInput').addEventListener('scroll', function () {
            document.getElementById('lineNumbers').scrollTop = this.scrollTop;
        });

        // Initialize
        loadSavedPreferences();
        initCharacterSelector();
        loadLevel(0);

        // Redraw after images load to ensure robot appears
        setTimeout(() => drawCanvas(), 100);
        window.addEventListener('load', () => drawCanvas());

        // Initialize Block Mode
        initBlockPalette();
        initBlockWorkspace();

        // Block Mode Toggle
        document.getElementById('codeModeBtn').addEventListener('click', switchToCodeMode);
        document.getElementById('blockModeBtn').addEventListener('click', switchToBlockMode);

        // Zoom Controls
        document.getElementById('zoomInBtn').addEventListener('click', zoomIn);
        document.getElementById('zoomOutBtn').addEventListener('click', zoomOut);

        // Mouse wheel zoom in workspace
        document.querySelector('.block-workspace-wrapper')?.addEventListener('wheel', (e) => {
            if (e.ctrlKey) {
                e.preventDefault();
                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }
            }
        }, { passive: false });

        // Theme Toggle
        // Theme toggle moved to settings

        // Character Selector
        const characterBtn = document.getElementById('characterBtn');
        const characterModal = document.getElementById('characterModal');
        const closeCharacterModal = document.getElementById('closeCharacterModal');

        characterBtn.addEventListener('click', () => {
            initCharacterSelector();
            characterModal.classList.add('show');
        });

        closeCharacterModal.addEventListener('click', () => {
            characterModal.classList.remove('show');
        });

        characterModal.addEventListener('click', (e) => {
            if (e.target === characterModal) {
                characterModal.classList.remove('show');
            }
        });

        // Quick Reference Panel Toggle
        const floatingHelpBtn = document.getElementById('floatingHelpBtn');
        const quickRefPanel = document.getElementById('quickRefPanel');
        const closeQuickRef = document.getElementById('closeQuickRef');

        floatingHelpBtn.addEventListener('click', () => {
            quickRefPanel.classList.toggle('open');
            floatingHelpBtn.classList.toggle('active');
        });

        closeQuickRef.addEventListener('click', () => {
            quickRefPanel.classList.remove('open');
            floatingHelpBtn.classList.remove('active');
        });

        // ===== AUTH MODAL SETUP =====
        const authModal = document.getElementById('authModal');
        const closeAuthModal = document.getElementById('closeAuthModal');
        const authTabs = document.querySelectorAll('.auth-tab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');

        // モーダルを閉じる
        closeAuthModal.addEventListener('click', () => {
            authModal.classList.remove('show');
            document.getElementById('authError').classList.remove('show');
            document.getElementById('authSuccess').classList.remove('show');
        });

        // モーダル外クリックでは閉じない（✕ボタンでのみ閉じる）
        // authModal.addEventListener('click', (e) => {
        //     if (e.target === authModal) {
        //         authModal.classList.remove('show');
        //     }
        // });

        // タブ切り替え
        authTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                authTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.getElementById('authError').classList.remove('show');
                document.getElementById('authSuccess').classList.remove('show');

                if (tab.dataset.tab === 'login') {
                    loginForm.classList.add('active');
                    registerForm.classList.remove('active');
                } else {
                    loginForm.classList.remove('active');
                    registerForm.classList.add('active');
                }
            });
        });

        // ログインフォーム送信
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const btn = loginForm.querySelector('.auth-btn');
            btn.disabled = true;
            btn.textContent = 'ログイン中...';

            await handleLogin(email, password);

            btn.disabled = false;
            btn.textContent = 'ログイン';
        });

        // 登録フォーム送信
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nickname = document.getElementById('registerNickname').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            const btn = registerForm.querySelector('.auth-btn');
            btn.disabled = true;
            btn.textContent = '登録中...';

            await handleRegister(email, password, nickname);

            btn.disabled = false;
            btn.textContent = 'アカウント作成';
        });

        // Googleログインボタン
        document.getElementById('googleLoginBtn').addEventListener('click', async () => {
            const btn = document.getElementById('googleLoginBtn');
            btn.disabled = true;
            btn.textContent = 'リダイレクト中...';

            await handleGoogleLogin();

            btn.disabled = false;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Googleでログイン
            `;
        });

        // パスワードを忘れた方リンク
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const backToLoginBtn = document.getElementById('backToLoginBtn');
        const authTabsContainer = document.querySelector('.auth-tabs');
        const authDivider = document.querySelector('.auth-divider');
        const googleBtn = document.getElementById('googleLoginBtn');

        forgotPasswordBtn.addEventListener('click', () => {
            loginForm.classList.remove('active');
            registerForm.classList.remove('active');
            forgotPasswordForm.classList.add('active');
            authTabsContainer.style.display = 'none';
            authDivider.style.display = 'none';
            googleBtn.style.display = 'none';
            document.getElementById('authError').classList.remove('show');
            document.getElementById('authSuccess').classList.remove('show');
        });

        backToLoginBtn.addEventListener('click', () => {
            forgotPasswordForm.classList.remove('active');
            loginForm.classList.add('active');
            authTabsContainer.style.display = 'flex';
            authDivider.style.display = 'flex';
            googleBtn.style.display = 'flex';
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.auth-tab[data-tab="login"]').classList.add('active');
            document.getElementById('authError').classList.remove('show');
            document.getElementById('authSuccess').classList.remove('show');
        });

        // パスワードリセットフォーム送信
        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;

            const btn = forgotPasswordForm.querySelector('.auth-btn');
            btn.disabled = true;
            btn.textContent = '送信中...';

            await handlePasswordReset(email);

            btn.disabled = false;
            btn.textContent = 'リセットリンクを送信';
        });

        // パスワード表示/非表示トグル
        document.querySelectorAll('.password-toggle').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.getAttribute('data-target');
                const input = document.getElementById(targetId);

                if (input.type === 'password') {
                    input.type = 'text';
                    btn.textContent = '🙈';
                    btn.classList.add('showing');
                } else {
                    input.type = 'password';
                    btn.textContent = '👁️';
                    btn.classList.remove('showing');
                }
            });
        });

        // ===== SETTINGS MODAL =====
        const settingsModal = document.getElementById('settingsModal');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeSettingsModal = document.getElementById('closeSettingsModal');

        // 設定ボタンクリック
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('show');
            updateSettingsStats();
        });

        // 設定モーダルを閉じる
        closeSettingsModal.addEventListener('click', () => {
            settingsModal.classList.remove('show');
            document.getElementById('settingsMessage').className = 'settings-message';
        });

        // サウンド設定
        const soundToggle = document.getElementById('soundToggle');
        soundToggle.checked = soundEnabled;
        soundToggle.addEventListener('change', () => {
            soundEnabled = soundToggle.checked;
            localStorage.setItem('soundEnabled', soundEnabled);
            if (soundEnabled) {
                playSound('select_stage_sound.mp3');
            }
        });

        // 表示設定 - テーマボタン
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                bgTheme = btn.dataset.theme;
                localStorage.setItem('bgTheme', bgTheme);
                applyDisplaySettings();
                playSound('select_stage_sound.mp3');
            });
        });

        // 表示設定 - テキストカラーボタン
        document.querySelectorAll('.text-color-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                textColor = btn.dataset.textcolor;
                localStorage.setItem('textColor', textColor);
                applyDisplaySettings();
                playSound('select_stage_sound.mp3');
            });
        });

        // 表示設定 - トグル
        const darkModeToggle = document.getElementById('darkModeToggle');
        const robotToggle = document.getElementById('robotToggle');
        const rocketToggle = document.getElementById('rocketToggle');

        // Load dark mode setting
        darkModeToggle.checked = isDarkMode;
        if (!isDarkMode) {
            document.body.classList.add('light-mode');
        }

        robotToggle.checked = robotVisible;
        rocketToggle.checked = rocketVisible;

        darkModeToggle.addEventListener('change', () => {
            isDarkMode = darkModeToggle.checked;
            localStorage.setItem('isDarkMode', isDarkMode);
            if (isDarkMode) {
                document.body.classList.remove('light-mode');
            } else {
                document.body.classList.add('light-mode');
            }
        });

        robotToggle.addEventListener('change', () => {
            robotVisible = robotToggle.checked;
            localStorage.setItem('robotVisible', robotVisible);
            applyDisplaySettings();
        });

        rocketToggle.addEventListener('change', () => {
            rocketVisible = rocketToggle.checked;
            localStorage.setItem('rocketVisible', rocketVisible);
            applyDisplaySettings();
        });

        // Apply display settings on load
        applyDisplaySettings();

        // モーダル外クリックでは閉じない（✕ボタンでのみ閉じる）
        // settingsModal.addEventListener('click', (e) => {
        //     if (e.target === settingsModal) {
        //         settingsModal.classList.remove('show');
        //     }
        // });

        // ログインボタン（設定画面から）
        document.getElementById('openLoginBtn').addEventListener('click', () => {
            settingsModal.classList.remove('show');
            document.getElementById('authModal').classList.add('show');
            // ログインタブを選択
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.auth-tab[data-tab="login"]').classList.add('active');
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('registerForm').classList.remove('active');
            document.getElementById('forgotPasswordForm').classList.remove('active');
            document.querySelector('.auth-tabs').style.display = 'flex';
            document.querySelector('.auth-divider').style.display = 'flex';
            document.getElementById('googleLoginBtn').style.display = 'flex';
        });

        // 新規登録ボタン（設定画面から）
        document.getElementById('openRegisterBtn').addEventListener('click', () => {
            settingsModal.classList.remove('show');
            document.getElementById('authModal').classList.add('show');
            // 登録タブを選択
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.auth-tab[data-tab="register"]').classList.add('active');
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('registerForm').classList.add('active');
            document.getElementById('forgotPasswordForm').classList.remove('active');
            document.querySelector('.auth-tabs').style.display = 'flex';
            document.querySelector('.auth-divider').style.display = 'flex';
            document.getElementById('googleLoginBtn').style.display = 'flex';
        });

        // ログアウトボタン（設定画面から）
        document.getElementById('settingsLogoutBtn').addEventListener('click', async () => {
            if (confirm('ログアウトしますか？')) {
                await handleLogout();
                showSettingsMessage('success', 'ログアウトしました');
            }
        });

        // ニックネーム保存
        document.getElementById('saveNicknameBtn').addEventListener('click', async () => {
            const newNickname = document.getElementById('settingsNickname').value.trim();
            if (!newNickname) {
                showSettingsMessage('error', 'ニックネームを入力してください');
                return;
            }

            if (!supabaseClient || !currentUser) {
                showSettingsMessage('error', 'ログインが必要です');
                return;
            }
        

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ nickname: newNickname })
                    .eq('id', currentUser.id);

                if (error) throw error;

                userProfile.nickname = newNickname;
                updateAuthUI();
                showSettingsMessage('success', 'ニックネームを更新しました');
            } catch (error) {
                showSettingsMessage('error', 'エラー: ' + error.message);
            }
        });

        // メールアドレス変更
        document.getElementById('saveEmailBtn').addEventListener('click', async () => {
            const newEmail = document.getElementById('settingsEmail').value.trim();
            if (!newEmail) {
                showSettingsMessage('error', 'メールアドレスを入力してください');
                return;
            }

            if (!supabaseClient || !currentUser) {
                showSettingsMessage('error', 'ログインが必要です');
                return;
            }

            try {
                const { error } = await supabaseClient.auth.updateUser({
                    email: newEmail
                });

                if (error) throw error;

                showSettingsMessage('success', '確認メールを送信しました。メールを確認してください。');
            } catch (error) {
                showSettingsMessage('error', 'エラー: ' + error.message);
            }
        });

        // パスワード変更画面表示
        document.getElementById('changePasswordBtn').addEventListener('click', () => {
            document.getElementById('settingsLoggedIn').style.display = 'none';
            document.getElementById('settingsPasswordChange').style.display = 'block';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        });

        // パスワード変更キャンセル
        document.getElementById('cancelPasswordChangeBtn').addEventListener('click', () => {
            document.getElementById('settingsPasswordChange').style.display = 'none';
            document.getElementById('settingsLoggedIn').style.display = 'block';
        });

        // パスワード保存
        document.getElementById('savePasswordBtn').addEventListener('click', async () => {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword.length < 6) {
                showSettingsMessage('error', 'パスワードは6文字以上にしてください');
                return;
            }

            if (newPassword !== confirmPassword) {
                showSettingsMessage('error', 'パスワードが一致しません');
                return;
            }

            if (!supabaseClient || !currentUser) {
                showSettingsMessage('error', 'ログインが必要です');
                return;
            }

            try {
                const { error } = await supabaseClient.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                document.getElementById('settingsPasswordChange').style.display = 'none';
                document.getElementById('settingsLoggedIn').style.display = 'block';
                showSettingsMessage('success', 'パスワードを変更しました');
            } catch (error) {
                showSettingsMessage('error', 'エラー: ' + error.message);
            }
        });

        // Supabase初期化
        initSupabase();
    </script>
</body>

</html>